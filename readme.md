# R6 交番・駐在所検索データベース

全国の交番および駐在所の情報を検索・管理するためのWebアプリケーションです。「落ち着いたサイバーパンク」をテーマにしたUIと、堅牢な多段階権限管理システムを備えています。

---

#### データ出典：[e-Gov データポータル - 交番・駐在所オープンデータ](https://data.e-gov.go.jp/data/ja/dataset/04b81179-879c-40e7-ab86-9f097ffac49d/resource/18ce28d1-e3b6-43dd-a3c9-6d4b767bace0?inner_span=True&activity_id=7f92bdf3-a897-4a1e-88d5-59755ea7d37b)

## **👁️‍🗨️ システム・オーバービュー**

本システムは、オープンデータを活用しつつ、組織内での厳格なデータ運用を想定して設計されています。

## **📖 利用者向け操作ガイド**

### **1\. 一般ユーザー（閲覧・申請）**

* **検索**: トップ画面の検索フォームから条件を入力して実行します。スペース区切りで複数キーワード（例：「東京都 新宿」）の検索も可能です。  
* **アカウント作成**: 「サインアップ」からIDとパスワードを設定します。登録直後は「閲覧のみ」の権限が付与されます。  
* **権限申請**: ログイン後、上部の **\[権限の申請\]** リンクから進みます。  
  * 必要な権限をチェックし、理由を入力して「申請プロトコルを実行」します。  
  * 申請中はボタンが「権限申請中...」に変わり、重複申請が制限されます。  
  * 承認または却下されると、トップ画面で一度だけ通知メッセージが表示されます。

### **2\. 管理者（審査・管理）**

* **申請の承認審査**:  
  * 管理者管理権限を持つユーザーは、ナビゲーションの「管理者管理」に **\[\!\]** バッジが表示されたら審査が必要です。  
  * 一覧の「承認審査」から対象ユーザーを選択します。  
  * ユーザーが希望した権限にチェックが入っています。管理者は付与する項目を最終決定して「承認」を行います。  
  * **仕様**: 承認時、ユーザーが既に持っている権限は剥奪されず、新しい権限が追加（統合）されます。  
* **監査ログの確認**:  
  * 「ログ監査」画面では、全ユーザーの操作がリアルタイムで流れます。  
  * 不審なアクセスや操作ミスがないか、キーワードや操作種別でフィルタリングして確認できます。
  * 管理者管理権限を持たないユーザーがログを閲覧した場合、ユーザーIDが自動的に難読化されます

📝 **管理メモ**: 初期管理者アカウントのパスワードリセットが必要な場合は、最高管理者（SuperAdmin）が「管理者管理」画面から強制変更を実行してください。

## 🚀 主な機能

### 🔍 検索・閲覧
* **条件検索**: ID、都道府県、種別（交番/駐在所）、キーワード（名称や住所の一部）による複合検索。  
* **ページネーション**: 大量データの快適な閲覧（1ページ100件表示）。
* **外部連携**: 住所からGoogleマップへのダイレクトリンク機能。
* **サイバーパンクUI**: グリーンを基調とした、スキャンライン演出や発光エフェクトを施したデザイン。  

### **🔐 認証・権限管理 (最重要アップデート)**

* **3段階の個別権限**:  
  * **データ管理**: データの追加・編集・削除、CSVインポートが可能。  
  * **管理者管理**: ユーザーアカウントの発行、パスワードリセット、権限の審査が可能。  
  * **ログ閲覧**: システムの操作ログをリアルタイムで監視可能。  
* **詳細な権限昇格申請**:  
  * 一般ユーザーは必要な権限（データ/ログ）を個別に選択し、理由を添えて申請。  
  * 管理者は申請内容を審査し、付与する権限を個別に選択して承認（既存権限を維持したまま上書き可能）。  
  * 権限の承認審査時、一覧に表示される \[\!\] バッジは、未処理の申請が存在することを示します。
  * 管理者管理の権限は同じ権限を持つユーザーのみが管理できます。
* **リアルタイム権限同期**: 管理者が権限を更新した際、ユーザーがログアウトせずとも次のアクションで即座に新しい権限が反映される動的同期システム。  
* **アカウントロック**: ログイン失敗10回で30分間の自動ロック。
* **匿名監査ログ**: 管理権限のないユーザーに対して、操作ログのユーザーIDを OP\_xxxx (SHA-256ベース) に難読化。

### 📊 データ管理
* **CRUD操作**: ブラウザ上での新規登録、編集、削除。
* **UPSERT対応CSV管理**: ID重複時は更新（UPDATE）、新規は追加（INSERT）を行う堅牢なインポート機能。  
* **CSVエクスポート**: 検索結果または全データのバックアップ。
* **リアルタイム監査ログ**: JS Fetch APIを用いた非同期更新。新着ログは「NEW」バッジと点滅演出で通知。  
* **監査ログの徹底**: 権限申請の理由、承認結果（どの権限が付与されたか）、通知の確認までをすべて記録。
* **ファイルベースキャッシュ**: 検索結果や総件数を storage/cache に保持し、DBへの問い合わせ回数を最小限に抑えます。
* **ハイブリッド・データベース**: ローカル(SQLite) と 本番(PostgreSQL/Supabase) のシームレスな切り替え。

## 🛠 技術スタックと仕様

* **Language**: PHP 8.2 (Apache)
* **Architecture**: MVC（Model-View-Controller）パターン
* **Database**:
    * 本番環境: PostgreSQL (Supabase Renderでの運用)
    * ローカル環境: SQLite (Docker Container)  
* **Environment**: Docker / Docker Compose
* **Frontend**: Vanilla JS (Real-time Log API), CSS3 (Custom Components / Root Variables)  
* **Dependencies**: 
    * `phpdotenv`: 環境変数管理
    * `composer`: PSR-4 オートロード管理

---

## 📁 ディレクトリ構造

```text
.
├── index.php               \# エントリポイント（public/index.phpへ委譲）
├── Dockerfile              \# Webサーバー(Apache+PHP)構成  
├── docker-compose.yml      \# Web \+ DB(PostgreSQL) のオーケストレーション
├── docker-compose.sh       \# Web \+ DB(PostgreSQL) のオーケストレーション  
├── public/                 \# 公開ディレクトリ  
│   ├── css/                \# style.css (全体), style-auth.css (演出)  
│   └── index.php           \# フロントコントローラー（全リクエストの集約）  
├── src/                    \# アプリケーションロジック (PSR-4)  
│   ├── Controllers/        \# Koban, Auth, AdminController  
│   ├── Models/             \# Database抽象化 (PostgreSQL対応)  
│   └── Utils/              \# Database, View, Cache, Validator  
├── views/                  \# PHPテンプレート  
│   ├── admin/              \# 管理者パネル・審査画面  
│   ├── auth/               \# ログイン・詳細申請画面  
│   ├── components/         \# ボタン、アラート、バッジの部品化  
│   └── layouts/            \# ヘッダー・フッター  
└── storage/                \# キャッシュ・テンポラリファイル
```

## ⚡ 起動手順（ローカル開発環境）

1. 準備 
Docker Desktop がインストール・起動されていることを確認してください。

2. 環境変数の設定
プロジェクトルートに .env ファイルを作成します。

* ローカルでSQLiteを使用する場合は空欄、PostgreSQLを使用する場合はURLを記述

DATABASE_URL=

3. コンテナのビルド・起動
ターミナルで以下のコマンドを実行します。

```Bash
docker-compose up -d --build
```

## 🔧 開発・運用メモ
- キャッシュ機能: src/Utils/Cache.php により、検索結果や件数取得をファイルベースでキャッシュし、DB負荷を軽減しています。

- リアルタイムログ: views/admin/log_list.php では JavaScript の fetch を用いて、ページ遷移なしで最新の操作ログを自動更新表示します。

- デプロイ: Dockerfile は Render 等の PaaS 環境（$PORT 環境変数対応）へのデプロイを考慮して設計されています。

#

### **⚡ ローカル起動のメモ**

WSL2/Windows環境特有の権限問題を回避するため、以下の手順でシステムを起動してください。

### - **1\. ディレクトリの準備と権限付与**

WSL2ターミナルで実行してください。

\# 物理ディレクトリの作成  
mkdir \-p SQL storage/cache

\# 権限の全開放（SQLiteのジャーナルファイル作成に必要）  
chmod \-R 777 SQL/ storage/

### - **2\. コンテナのビルドと起動**

docker-compose up \-d \--build

### - **3\. データベースの初期化**

初回起動時、またはテーブルが存在しない場合は以下のプロトコルを実行してください。

docker-compose exec web php init\_sqlite.php

※ admin / Password123\! という初期アカウントが生成されます。

### - 4. ブラウザでアクセス
以下のURLを開きます。 http://localhost:8080

## **🛡 セキュリティ仕様**

* **CSRF対策**: すべてのアクション（承認/却下含む）でワンタイムトークンを検証。  
* **セキュリティヘッダ**: X-Frame-Options, X-XSS-Protection, X-Content-Type-Options 等の強制適用。  
* **データクレンジング**: 入力住所の全角半角正規化、電話番号・郵便番号のフォーマットバリデーション。  
* **監査証跡**: 全てのログイン試行、データ操作、権限変更をIPアドレス・UserAgentと共に記録。

📝 ライセンス
このプロジェクトの取り扱いについては、管理者に確認してください。