This file is a merged representation of the entire codebase, combined into a single document by Repomix.

<file_summary>
This section contains a summary of this file.

<purpose>
This file contains a packed representation of the entire repository's contents.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.
</purpose>

<file_format>
The content is organized as follows:
1. This summary section
2. Repository information
3. Directory structure
4. Repository files (if enabled)
5. Multiple file entries, each consisting of:
  - File path as an attribute
  - Full contents of the file
</file_format>

<usage_guidelines>
- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.
</usage_guidelines>

<notes>
- Some files may have been excluded based on .gitignore rules and Repomix's configuration
- Binary files are not included in this packed representation. Please refer to the Repository Structure section for a complete list of file paths, including binary files
- Files matching patterns in .gitignore are excluded
- Files matching default ignore patterns are excluded
- Files are sorted by Git change count (files with more changes are at the bottom)
</notes>

</file_summary>

<directory_structure>
.htaccess
composer.json
docker-compose.yml
Dockerfile
index.php
public/.htaccess
public/css/style.css
public/index.php
SQL/.htaccess
SQL/log_archives/log_backup_20251206_070310.csv
SQL/opendata.sqlite
src/Controllers/AdminController.php
src/Controllers/AuthController.php
src/Controllers/KobanController.php
src/Models/AdminUser.php
src/Models/AuditLog.php
src/Models/Koban.php
src/Utils/Database.php
src/Utils/functions.php
src/Utils/Validator.php
src/Utils/View.php
views/admin/change_password.php
views/admin/log_list.php
views/admin/register.php
views/admin/reset_password.php
views/home.php
views/koban/form.php
views/layouts/header.php
</directory_structure>

<files>
This section contains the contents of the repository's files.

<file path=".htaccess">
<IfModule mod_rewrite.c>
    RewriteEngine On

    # ▼▼▼ 追加: 重要なディレクトリへの直接アクセスを禁止 ▼▼▼
    RewriteRule ^(src|views|vendor|SQL)/ - [F,L]
    RewriteRule ^composer\.(json|lock)$ - [F,L]
    # ▲▲▲ 追加ここまで ▲▲▲
    # ファイルやディレクトリが存在しなければ index.php に転送
    RewriteCond %{REQUEST_FILENAME} !-f
    RewriteCond %{REQUEST_FILENAME} !-d
    RewriteRule ^(.*)$ index.php [QSA,L]
</IfModule>
</file>

<file path="composer.json">
{
    "name": "miyashu/koban-app",
    "autoload": {
        "psr-4": {
            "App\\": "src/"
        },
        "files": [
            "src/Utils/functions.php"
        ]
    },
    "require": {
        "vlucas/phpdotenv": "^5.6"
    }
}
</file>

<file path="docker-compose.yml">
services:
  web:
    build: .
    ports:
      - "8080:80"
    volumes:
      - .:/var/www/html
</file>

<file path="Dockerfile">
# PHP 8.2 と Apache (Webサーバー) の公式イメージを使う
FROM php:8.2-apache

# SQLiteに必要なライブラリを追加し、pdo_sqliteをインストール
RUN apt-get update && apt-get install -y \
    unzip \
    git \
    libsqlite3-dev \
    && docker-php-ext-install pdo_sqlite

# URLをきれいにする機能（mod_rewrite）を有効化
RUN a2enmod rewrite

# Composer（ライブラリ管理ツール）も最初から入れておく
COPY --from=composer:latest /usr/bin/composer /usr/bin/composer
</file>

<file path="index.php">
<?php
// ルートディレクトリの index.php

// すべてのリクエストを public/index.php に丸投げ（委譲）します
require_once __DIR__ . '/public/index.php';
</file>

<file path="public/.htaccess">
<IfModule mod_rewrite.c>
    RewriteEngine On

    # 実在するファイル（画像、CSS、JSなど）へのアクセスはそのまま通す
    RewriteCond %{REQUEST_FILENAME} !-f
    RewriteCond %{REQUEST_FILENAME} !-d

    # それ以外はすべて index.php に転送する
    RewriteRule ^(.*)$ index.php [QSA,L]
</IfModule>
</file>

<file path="public/css/style.css">
/* オリジナルの雰囲気を再現 */
body {
    background-color: #010000;
    color: #1eff1a;
    font-family: sans-serif;
    text-align: center;
    margin: 0;
    padding: 20px;
    display: flex;
    flex-direction: column;
    align-items: center;
}

h1,
h2,
h3 {
    color: #fbfffc;
}

.container {
    width: 95%;
    max-width: 1400px;
    margin: 0 auto;
}

/* フォームやメニューを囲むボックス */
.box {
    background-color: #1a1a1a;
    padding: 15px;
    margin-bottom: 20px;
    border-radius: 10px;
    border: 1px solid #333;
    box-shadow: 0px 0px 20px rgba(40, 40, 40, 0.4);
    text-align: left;
}

/* 入力フォームデザイン */
input[type=text],
input[type=password],
input[type=tel],
input[type=date],
select {
    background: #333;
    color: #fff;
    border: 1px solid #555;
    padding: 6px;
    border-radius: 4px;
}

/* ボタンデザイン */
input[type=submit],
button,
.btn {
    cursor: pointer;
    font-weight: bold;
    border: none;
    padding: 8px 15px;
    border-radius: 4px;
    text-decoration: none;
    display: inline-block;
    font-size: 14px;
}

.btn-primary {
    background-color: #1eff1a;
    color: #000;
}

.btn-warning {
    background-color: #ffff00;
    color: #000;
}

.btn-danger {
    background-color: #ff4444;
    color: #fff;
}

.btn-secondary {
    background-color: #333;
    color: #fff;
    border: 1px solid #555;
}

.btn-back {
    background-color: #333;
    color: #fff;
    border: 1px solid #555;
    padding: 5px 10px;
}

a {
    color: #888;
    text-decoration: none;
}

a:hover {
    color: #fff;
}

/* テーブルデザイン（元ファイルのデザインを復元） */
table {
    width: 100%;
    border-collapse: collapse;
    border: 1px solid #b0ffd4;
    margin-top: 10px;
}

th {
    background-color: #1a1a1aff;
    color: #fff;
    padding: 8px;
    border: 1px solid #b0ffd4;
    text-align: center;
}

td {
    border: 1px solid #b0ffd4;
    /* 元のボーダー色 */
    padding: 8px;
    color: #1eff1a;
    background-color: #010000;
}

tr:hover td {
    background-color: #111;
}

/* ページネーション */
.pagination a {
    padding: 5px 12px;
    text-decoration: none;
    border-radius: 4px;
    margin: 2px;
}

.pagination .current {
    background: #1eff1a;
    color: #000;
    font-weight: bold;
}

.pagination .other {
    background: #333;
    color: #fff;
}

/* レイアウト調整用 */
.flex-row {
    display: flex;
    gap: 10px;
    align-items: center;
    flex-wrap: wrap;
}

.right-align {
    text-align: right;
}
</file>

<file path="public/index.php">
<?php
// 1. オートロードの読み込み
require_once __DIR__ . '/../vendor/autoload.php';

use App\Controllers\KobanController;
use App\Controllers\AuthController; // 後で作る予定ならコメントアウトでもOK
use App\Controllers\AdminController; // まだない場合はコメントアウト

// 2. 環境変数の読み込み (.env)
try {
    // プロジェクトルート(一つ上の階層)の .env を探す
    $dotenv = \Dotenv\Dotenv::createImmutable(__DIR__ . '/..');
    $dotenv->load();
} catch (\Exception $e) {
    // .envがなくても動作を止めない（本番環境の環境変数を使う場合など）
}

// 3. セッション開始 (全ページ共通)
if (session_status() === PHP_SESSION_NONE) {
    session_start();
}

if (empty($_SESSION['csrf_token'])) {
    $_SESSION['csrf_token'] = bin2hex(random_bytes(32));
}

sendSecurityHeaders();

// 4. ルーティング処理 (修正版)
$requestPath = parse_url($_SERVER['REQUEST_URI'], PHP_URL_PATH);
$method = $_SERVER['REQUEST_METHOD'];

// スクリプトが置かれているディレクトリを取得 (例: /public)
$scriptDir = dirname($_SERVER['SCRIPT_NAME']);

// リクエストパスの先頭にディレクトリパスが含まれていれば削除する
// これにより /public/koban/edit へのアクセスを /koban/edit として扱えます
if ($scriptDir !== '/' && strpos($requestPath, $scriptDir) === 0) {
    $requestPath = substr($requestPath, strlen($scriptDir));
}

// さらに /index.php が付いていたら削除する
$path = str_replace('/index.php', '', $requestPath);

// 空文字になった場合はルート(/)とみなす
if ($path === '') {
    $path = '/';
}

// 確認用デバッグ (解決したら消してください)
// echo "Resolved Path: " . htmlspecialchars($path);

// ルート定義
$routes = [
    'GET' => [
        '/'             => [KobanController::class, 'index'],
        '/opendata'     => [KobanController::class, 'index'],
        '/koban/create' => [KobanController::class, 'create'],
        '/koban/edit'   => [KobanController::class, 'edit'],
        '/admin/login'  => [AuthController::class, 'showLoginForm'],
        '/koban/export' => [KobanController::class, 'export'],

        // ▼▼▼ 管理者用ルート (追加) ▼▼▼
        '/admin/logs'            => [AdminController::class, 'logs'],            // ログ一覧
        '/admin/api/logs'        => [AdminController::class, 'apiLogs'],         // ログAPI (JS用)
        '/admin/password/change' => [AdminController::class, 'changePassword'],  // PW変更画面
        '/admin/users'           => [AdminController::class, 'admins'],          // 管理者一覧
        '/admin/password/reset'  => [AdminController::class, 'resetPasswordForm'] // PW強制リセット
    ],
    'POST' => [
        '/koban/store'  => [KobanController::class, 'store'],
        '/koban/delete' => [KobanController::class, 'delete'],
        '/auth/login'   => [AuthController::class, 'login'],
        '/auth/logout'  => [AuthController::class, 'logout'],
        '/koban/import' => [KobanController::class, 'importCsv'],

        // ▼▼▼ 管理者用ルート (追加) ▼▼▼
        '/admin/password/update' => [AdminController::class, 'updatePassword'],  // PW変更実行
        '/admin/users/store'     => [AdminController::class, 'storeAdmin'],      // 管理者登録・削除
        '/admin/password/reset'  => [AdminController::class, 'resetPasswordExec'], // PW強制リセット実行
    ]
];

// 5. ディスパッチ (コントローラー呼び出し)
if (isset($routes[$method][$path])) {
    // 対応するコントローラーとメソッドを取り出す
    [$controllerClass, $action] = $routes[$method][$path];

    // クラスが存在するかチェック
    if (class_exists($controllerClass)) {
        $controller = new $controllerClass();
        if (method_exists($controller, $action)) {
            // メソッド実行！
            $controller->$action();
        } else {
            http_response_code(500);
            echo "Error: Method '$action' not found in $controllerClass";
        }
    } else {
        http_response_code(500);
        echo "Error: Class '$controllerClass' not found";
    }
} else {
    // 定義されていないURLの場合
    http_response_code(404);
    echo "<h1>404 Not Found</h1>";
    echo "<p>ページが見つかりません。</p>";
    echo "<a href='/'>トップページへ戻る</a>";
}
</file>

<file path="SQL/.htaccess">
<FilesMatch "\.(sqlite|csv|log|bak|sql)$">
    Require all denied
</FilesMatch>

Qptions -Indexes
</file>

<file path="SQL/log_archives/log_backup_20251206_070310.csv">
id,user_id,action_time,action_type,details,ip_address,user_agent
1,admin,"2025-12-05 18:44:40",ログイン,ログインに成功しました,::1,
2,admin,"2025-12-05 18:45:49",管理者削除,"管理者 [hikakin] を削除しました",::1,
3,admin,"2025-12-05 18:45:59",管理者登録,"新規管理者 [seikin] () を作成しました",::1,
4,admin,"2025-12-05 18:46:11",管理者登録,"新規管理者 [hikakin] () を作成しました",::1,
5,admin,"2025-12-05 18:48:52",データ保存,「堂前警察署兎駐在所」を追加,::1,
6,admin,"2025-12-05 18:49:44",データ削除,"ID: 12144 を削除しました",::1,
7,admin,"2025-12-05 18:50:35",データ保存,"ID: 12143 の情報を更新",::1,
8,admin,"2025-12-05 18:50:50",ログアウト,ユーザーがログアウトしました,::1,
9,hikakin,"2025-12-05 18:50:55",ログイン,ログインに成功しました,::1,
10,hikakin,"2025-12-05 18:51:23",データ保存,"ID: 12143 の情報を更新",::1,
11,hikakin,"2025-12-05 18:51:25",ログアウト,ユーザーがログアウトしました,::1,
12,seikin,"2025-12-05 18:51:36",ログイン,ログインに成功しました,::1,
13,seikin,"2025-12-05 18:51:56",データ保存,"ID: 12143 の情報を更新",::1,
14,seikin,"2025-12-05 18:51:57",ログアウト,ユーザーがログアウトしました,::1,
15,admin,"2025-12-05 18:52:03",ログイン,ログインに成功しました,::1,
16,hikakin,"2025-12-05 18:58:26",ログイン,ログインに失敗しました,::1,
17,hikakin,"2025-12-05 18:58:41",ログイン,ログインに成功しました,::1,
18,hikakin,"2025-12-05 18:59:01",パスワード変更,パスワードの変更に成功しました,::1,
19,admin,"2025-12-05 18:59:12",ログイン,ログインに成功しました,::1,
20,hikakin,"2025-12-05 19:00:21",ログイン,ログインに成功しました,::1,
21,admin,"2025-12-05 19:00:30",ログイン,ログインに成功しました,::1,
22,hikakin,"2025-12-05 19:02:07",ログイン,ログインに失敗しました,::1,
23,hikakin,"2025-12-05 19:02:24",ログイン,ログインに成功しました,::1,
24,hikakin,"2025-12-05 19:02:33",パスワード変更,パスワードの変更に成功しました,::1,
25,admin,"2025-12-05 19:02:46",ログイン,ログインに成功しました,::1,
26,admin,"2025-12-05 19:12:29",ログアウト,ログアウトしました（成功）,::1,
27,hikakin,"2025-12-05 19:12:50",ログイン,ログインに成功しました,::1,
28,hikakin,"2025-12-05 19:12:53",ログアウト,ログアウトしました（成功）,::1,
29,admin,"2025-12-05 19:12:58",ログイン,ログインに成功しました,::1,
30,admin,"2025-12-05 19:15:24",ログアウト,ログアウトしました（成功）,::1,
31,seikin,"2025-12-05 19:15:34",ログイン,ログインに成功しました,::1,
32,seikin,"2025-12-05 19:16:48",データ保存,"ID: 12143 の情報を更新",::1,
33,seikin,"2025-12-05 19:16:50",ログアウト,ログアウトしました（成功）,::1,
34,admin,"2025-12-05 19:16:57",ログイン,ログインに成功しました,::1,
35,hikakin,"2025-12-05 19:18:19",ログイン,ログインに成功しました,::1,
36,hikakin,"2025-12-05 19:18:37",ログアウト,ログアウトしました（成功）,::1,
37,seikin,"2025-12-05 19:18:59",ログイン,ログインに成功しました,::1,
38,seikin,"2025-12-05 19:19:13",ログアウト,ログアウトしました（成功）,::1,
39,hikakin,"2025-12-05 19:19:19",ログイン,ログインに成功しました,::1,
40,hikakin,"2025-12-05 19:19:45",パスワード変更,パスワードの変更に成功しました,::1,
41,hikakin,"2025-12-05 19:19:53",ログイン,ログインに失敗しました,::1,
42,hikakin,"2025-12-05 19:19:58",ログアウト,ログアウトしました（成功）,::1,
43,hikakin,"2025-12-05 19:20:03",ログイン,ログインに失敗しました,::1,
44,hikakin,"2025-12-05 19:20:12",ログイン,ログインに成功しました,::1,
45,hikakin,"2025-12-05 19:20:18",パスワード変更,パスワードの変更に成功しました,::1,
46,hikakin,"2025-12-05 19:22:21",ログアウト,ログアウトしました（成功）,::1,
47,hikakin,"2025-12-05 19:25:57",ログイン,ログインに成功しました,::1,
48,hikakin,"2025-12-05 19:26:11",CSVエクスポート,"検索結果CSVをダウンロード [県: 新潟県]",::1,
49,hikakin,"2025-12-05 19:26:34",CSVインポート,"300 件のデータを一括登録しました",::1,
50,hikakin,"2025-12-05 19:27:30",ログアウト,ログアウトしました（成功）,::1,
51,guest,"2025-12-05 19:27:45",CSVエクスポート,"検索結果CSVをダウンロード [種別: 駐在所 県: 愛媛県]",::1,
52,guest,"2025-12-05 19:30:27",CSVエクスポート,全データのCSVをダウンロードしました,::1,
53,hikakin,"2025-12-05 19:47:38",ログイン,ログインに成功しました,::1,"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36 Edg/142.0.0.0"
54,admin,"2025-12-05 19:53:13",ログアウト,ログアウトしました（成功）,::1,"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36"
55,admin,"2025-12-05 19:53:19",ログイン,ログインに成功しました,::1,"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36"
56,admin,"2025-12-05 20:07:29",ログアウト,ログアウトしました（成功）,::1,"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36"
57,admin,"2025-12-05 20:08:57",ログイン,ログインに成功しました,::1,"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36"
58,admin,"2025-12-05 20:17:07",ログイン,ログインに成功しました,::1,"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36"
59,admin,"2025-12-05 20:17:09",ログアウト,ログアウトしました（成功）,::1,"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36"
60,attacker?,"2025-12-05 20:17:31",CSRFエラー,正規の画面以外からのアクセスを検知しました,::1,"Mozilla/5.0 (compatible; EvilBot/1.0)"
61,attacker?,"2025-12-05 20:17:32",CSRFエラー,正規の画面以外からのアクセスを検知しました,::1,Python-urllib/3.9
62,attacker?,"2025-12-05 20:17:33",CSRFエラー,正規の画面以外からのアクセスを検知しました,::1,sqlmap/1.5.2
63,attacker?,"2025-12-05 20:17:35",CSRFエラー,正規の画面以外からのアクセスを検知しました,::1,BruteForce-Test-Script/1.0
64,attacker?,"2025-12-05 20:17:35",CSRFエラー,正規の画面以外からのアクセスを検知しました,::1,BruteForce-Test-Script/1.0
65,attacker?,"2025-12-05 20:17:36",CSRFエラー,正規の画面以外からのアクセスを検知しました,::1,BruteForce-Test-Script/1.0
66,attacker?,"2025-12-05 20:17:36",CSRFエラー,正規の画面以外からのアクセスを検知しました,::1,BruteForce-Test-Script/1.0
67,attacker?,"2025-12-05 20:17:37",CSRFエラー,正規の画面以外からのアクセスを検知しました,::1,BruteForce-Test-Script/1.0
68,admin,"2025-12-05 20:17:45",ログイン,ログインに成功しました,::1,"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36"
69,admin,"2025-12-05 20:31:42",ログイン,ログインに失敗しました,::1,python-requests/2.32.5
70,admin,"2025-12-05 20:31:42",ログイン,ログインに失敗しました,::1,python-requests/2.32.5
71,admin,"2025-12-05 20:31:43",ログイン,ログインに失敗しました,::1,python-requests/2.32.5
72,admin,"2025-12-05 20:31:43",ログイン,ログインに失敗しました,::1,python-requests/2.32.5
73,admin,"2025-12-05 20:31:43",ログイン,ログインに失敗しました,::1,python-requests/2.32.5
74,admin,"2025-12-05 20:31:43",ログイン,ログインに失敗しました,::1,python-requests/2.32.5
75,admin,"2025-12-05 20:31:44",ログイン,ログインに失敗しました,::1,python-requests/2.32.5
76,admin,"2025-12-05 20:31:44",ログイン,ログインに失敗しました,::1,python-requests/2.32.5
77,admin,"2025-12-05 20:31:44",ログイン,ログインに失敗しました,::1,python-requests/2.32.5
78,admin,"2025-12-05 20:31:44",ログイン,ログインに失敗しました,::1,python-requests/2.32.5
79,admin,"2025-12-05 20:32:00",ログイン,ログインに失敗しました,::1,python-requests/2.32.5
80,admin,"2025-12-05 20:32:01",ログイン,ログインに失敗しました,::1,python-requests/2.32.5
81,admin,"2025-12-05 20:32:01",ログイン,ログインに失敗しました,::1,python-requests/2.32.5
82,admin,"2025-12-05 20:32:01",ログイン,ログインに失敗しました,::1,python-requests/2.32.5
83,admin,"2025-12-05 20:32:01",ログイン,ログインに失敗しました,::1,python-requests/2.32.5
84,admin,"2025-12-05 20:32:02",ログイン,ログインに失敗しました,::1,python-requests/2.32.5
85,admin,"2025-12-05 20:32:02",ログイン,ログインに失敗しました,::1,python-requests/2.32.5
86,admin,"2025-12-05 20:32:02",ログイン,ログインに失敗しました,::1,python-requests/2.32.5
87,admin,"2025-12-05 20:32:02",ログイン,ログインに失敗しました,::1,python-requests/2.32.5
88,admin,"2025-12-05 20:32:03",ログイン,ログインに失敗しました,::1,python-requests/2.32.5
89,admin,"2025-12-05 20:32:03",ログイン,ログインに成功しました,::1,python-requests/2.32.5
90,attacker?,"2025-12-05 20:33:48",CSRFエラー,正規の画面以外からのアクセスを検知しました,::1,"Mozilla/5.0 (compatible; EvilBot/1.0)"
91,attacker?,"2025-12-05 20:33:49",CSRFエラー,正規の画面以外からのアクセスを検知しました,::1,Python-urllib/3.9
92,attacker?,"2025-12-05 20:33:50",CSRFエラー,正規の画面以外からのアクセスを検知しました,::1,sqlmap/1.5.2
93,attacker?,"2025-12-05 20:33:51",CSRFエラー,正規の画面以外からのアクセスを検知しました,::1,BruteForce-Test-Script/1.0
94,attacker?,"2025-12-05 20:33:51",CSRFエラー,正規の画面以外からのアクセスを検知しました,::1,BruteForce-Test-Script/1.0
95,attacker?,"2025-12-05 20:33:52",CSRFエラー,正規の画面以外からのアクセスを検知しました,::1,BruteForce-Test-Script/1.0
96,attacker?,"2025-12-05 20:33:52",CSRFエラー,正規の画面以外からのアクセスを検知しました,::1,BruteForce-Test-Script/1.0
97,attacker?,"2025-12-05 20:33:53",CSRFエラー,正規の画面以外からのアクセスを検知しました,::1,BruteForce-Test-Script/1.0
98,admin,"2025-12-05 20:34:04",ログイン,ログインに失敗しました,::1,python-requests/2.32.3
99,admin,"2025-12-05 20:34:05",ログイン,ログインに失敗しました,::1,python-requests/2.32.3
100,admin,"2025-12-05 20:34:05",ログイン,ログインに失敗しました,::1,python-requests/2.32.3
101,admin,"2025-12-05 20:34:05",ログイン,ログインに失敗しました,::1,python-requests/2.32.3
102,admin,"2025-12-05 20:34:05",ログイン,ログインに失敗しました,::1,python-requests/2.32.3
103,admin,"2025-12-05 20:34:06",ログイン,ログインに失敗しました,::1,python-requests/2.32.3
104,admin,"2025-12-05 20:34:06",ログイン,ログインに失敗しました,::1,python-requests/2.32.3
105,admin,"2025-12-05 20:34:06",ログイン,ログインに失敗しました,::1,python-requests/2.32.3
106,admin,"2025-12-05 20:34:06",ログイン,ログインに失敗しました,::1,python-requests/2.32.3
107,admin,"2025-12-05 20:34:07",ログイン,ログインに失敗しました,::1,python-requests/2.32.3
108,admin,"2025-12-05 20:34:07",ログイン,ログインに成功しました,::1,python-requests/2.32.3
109,admin,"2025-12-05 20:34:26",ログイン,ログインに失敗しました,::1,python-requests/2.32.3
110,admin,"2025-12-05 20:34:27",ログイン,ログインに失敗しました,::1,python-requests/2.32.3
111,admin,"2025-12-05 20:34:27",ログイン,ログインに失敗しました,::1,python-requests/2.32.3
112,admin,"2025-12-05 20:34:27",ログイン,ログインに失敗しました,::1,python-requests/2.32.3
113,admin,"2025-12-05 20:34:27",ログイン,ログインに失敗しました,::1,python-requests/2.32.3
114,admin,"2025-12-05 20:34:28",ログイン,ログインに失敗しました,::1,python-requests/2.32.3
115,admin,"2025-12-05 20:34:28",ログイン,ログインに失敗しました,::1,python-requests/2.32.3
116,admin,"2025-12-05 20:34:28",ログイン,ログインに失敗しました,::1,python-requests/2.32.3
117,admin,"2025-12-05 20:34:28",ログイン,ログインに失敗しました,::1,python-requests/2.32.3
118,admin,"2025-12-05 20:34:29",ログイン,ログインに失敗しました,::1,python-requests/2.32.3
119,admin,"2025-12-05 20:34:29",ログイン,ログインに成功しました,::1,python-requests/2.32.3
120,admin,"2025-12-05 20:39:28",ログアウト,ログアウトしました（成功）,::1,"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36"
121,seikin,"2025-12-05 20:39:37",ログイン,ログインに成功しました,::1,"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36"
122,seikin,"2025-12-05 20:40:22",パスワード変更,パスワードの変更に成功しました,::1,"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36"
123,seikin,"2025-12-05 20:40:25",ログアウト,ログアウトしました（成功）,::1,"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36"
124,seikin,"2025-12-05 20:40:30",ログイン,ログインに成功しました,::1,"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36"
125,seikin,"2025-12-05 20:40:34",ログアウト,ログアウトしました（成功）,::1,"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36"
126,admin,"2025-12-05 20:41:46",ログイン失敗,"パスワード不一致 (失敗回数: 1)",::1,"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36"
127,admin,"2025-12-05 20:41:52",ログイン,ログインに成功しました,::1,"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36"
128,admin,"2025-12-05 20:45:55",ログイン失敗,"パスワード不一致 (失敗回数: 1)",::1,python-requests/2.32.5
129,admin,"2025-12-05 20:45:55",ログイン失敗,"パスワード不一致 (失敗回数: 2)",::1,python-requests/2.32.5
130,admin,"2025-12-05 20:45:56",ログイン失敗,"パスワード不一致 (失敗回数: 3)",::1,python-requests/2.32.5
131,admin,"2025-12-05 20:45:56",ログイン失敗,"パスワード不一致 (失敗回数: 4)",::1,python-requests/2.32.5
132,admin,"2025-12-05 20:45:56",アカウントロック,"ログイン失敗 5回目: アカウントをロックしました",::1,python-requests/2.32.5
133,admin,"2025-12-05 20:45:57",ログイン拒否,"アカウントロック中につき拒否 (残り 9分58秒)",::1,python-requests/2.32.5
134,admin,"2025-12-05 20:45:57",ログイン拒否,"アカウントロック中につき拒否 (残り 9分58秒)",::1,python-requests/2.32.5
135,admin,"2025-12-05 20:45:57",ログイン拒否,"アカウントロック中につき拒否 (残り 9分58秒)",::1,python-requests/2.32.5
136,admin,"2025-12-05 20:46:07",ログイン拒否,"アカウントロック中につき拒否 (残り 9分48秒)",::1,python-requests/2.32.5
137,admin,"2025-12-05 20:46:07",ログイン拒否,"アカウントロック中につき拒否 (残り 9分48秒)",::1,python-requests/2.32.5
138,admin,"2025-12-05 20:46:07",ログイン拒否,"アカウントロック中につき拒否 (残り 9分48秒)",::1,python-requests/2.32.5
139,admin,"2025-12-05 20:47:24",ログアウト,ログアウトしました（成功）,::1,"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36"
140,seikin,"2025-12-05 20:47:34",ログイン,ログインに成功しました,::1,"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36"
141,seikin,"2025-12-05 20:47:52",ログアウト,ログアウトしました（成功）,::1,"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36"
142,admin,"2025-12-05 20:47:58",ログイン拒否,"アカウントロック中につき拒否 (残り 7分57秒)",::1,"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36"
143,admin,"2025-12-05 20:51:47",ログイン拒否,"アカウントロック中につき拒否 (残り 4分8秒)",::1,"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36"
144,hikakin,"2025-12-05 20:59:50",ログアウト,ログアウトしました（成功）,::1,"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36 Edg/142.0.0.0"
145,admin,"2025-12-05 20:59:53",ログイン,ログインに成功しました,::1,"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36"
146,admin,"2025-12-05 21:00:29",ログアウト,ログアウトしました（成功）,::1,"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36"
147,admin,"2025-12-05 21:00:35",ログイン,ログインに成功しました,::1,"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36"
148,admin,"2025-12-05 21:32:33",ログアウト,成功,::1,"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36"
149,admin,"2025-12-05 21:32:40",ログイン失敗,失敗1回,::1,"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36"
150,admin,"2025-12-05 21:32:46",ログイン,成功,::1,"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36"
151,admin,"2025-12-05 21:36:32",ログアウト,成功,::1,"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36"
152,admin,"2025-12-05 21:36:38",ログイン,成功,::1,"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36"
153,admin,"2025-12-05 21:40:35",データ保存,"ID: 100 を更新",::1,"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36"
154,admin,"2025-12-05 21:40:42",データ保存,"ID: 100 を更新",::1,"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36"
155,admin,"2025-12-05 21:41:10",管理者登録,"新規管理者 [admin123] (スーパー) を作成",::1,"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36"
156,admin,"2025-12-05 21:41:58",データ保存,"ID: 12143 を更新",::1,"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36"
157,admin,"2025-12-06 06:57:51",ログアウト,成功,::1,"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36"
158,admin,"2025-12-06 06:57:57",ログイン,成功,::1,"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36"
159,admin,"2025-12-06 07:02:42",ログアウト,成功,::1,"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36"
160,admin,"2025-12-06 07:02:49",ログイン失敗,失敗1回,::1,"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36"
161,admin,"2025-12-06 07:03:10",ログイン,成功,::1,"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36"
</file>

<file path="src/Controllers/AdminController.php">
<?php
namespace App\Controllers;

use App\Models\AdminUser;
use App\Models\AuditLog;
use App\Utils\View;

class AdminController {

    // 共通の権限チェックメソッド
    private function requirePermission($type) {
        if (!isset($_SESSION['logged_in']) || !hasPermission($type)) {
            // 権限がない場合はトップへ強制送還（あるいは403画面）
            $_SESSION['message'] = "権限がありません。";
            header("Location: /");
            exit;
        }
    }

    /**
     * 操作ログ一覧画面 (旧 view_logs.php)
     */
    public function logs() {
        $this->requirePermission('log');

        $logModel = new AuditLog();

        // CSVダウンロード処理
        if (isset($_GET['download_csv'])) {
            $this->downloadLogsCsv($logModel);
            return;
        }

        // 画面表示用データ
        $types = $logModel->getActionTypes();
        $logs = $logModel->search($_GET, 500);
        $latest_id = count($logs) > 0 ? $logs[0]['id'] : 0;

        return View::render('admin/log_list', [
            'types' => $types,
            'logs' => $logs,
            'latest_id' => $latest_id
        ]);
    }

    /**
     * ログCSVダウンロード（logsメソッドから呼ばれる）
     */
    private function downloadLogsCsv($logModel) {
        $logs = $logModel->search($_GET, 10000);
        $filename = "audit_log_" . date('Ymd_His') . ".csv";
        
        header('Content-Type: text/csv');
        header('Content-Disposition: attachment; filename="' . $filename . '"');
        $output = fopen('php://output', 'w');
        fwrite($output, "\xEF\xBB\xBF");
        fputcsv($output, ['ID', 'ユーザーID', '日時', '操作種別', '詳細内容', 'IPアドレス', 'UserAgent']);

        foreach ($logs as $row) {
            fputcsv($output, [
                $row['id'], $row['user_id'], $row['action_time'], $row['action_type'],
                $row['details'], $row['ip_address'], $row['user_agent'] ?? ''
            ]);
        }
        fclose($output);
        exit;
    }

    /**
     * ログAPI (旧 api_get_logs.php)
     * JavaScriptから非同期で呼ばれるJSON返却用メソッド
     */
    public function apiLogs() {
        // APIでもしっかり権限チェック
        if (!isset($_SESSION['logged_in']) || !hasPermission('log')) {
            header('Content-Type: application/json');
            echo json_encode(['error' => 'Forbidden']);
            exit;
        }

        $logModel = new AuditLog();
        $last_id = isset($_GET['last_id']) ? (int)$_GET['last_id'] : 0;
        $newLogs = $logModel->getNewLogs($last_id, $_GET);

        // XSS対策をしてJSONで返す
        $clean_logs = array_map(function($log) {
            return [
                'id' => h($log['id']),
                'action_time' => h($log['action_time']),
                'user_id' => h($log['user_id']),
                'action_type' => h($log['action_type']),
                'details' => h($log['details']),
                'ip_address' => h($log['ip_address']),
                'user_agent' => h($log['user_agent'] ?? '')
            ];
        }, $newLogs);

        header('Content-Type: application/json; charset=utf-8');
        echo json_encode($clean_logs);
        exit;
    }

    /**
     * 自分のパスワード変更画面 (旧 change_password.php)
     */
    public function changePassword() {
        if (!isset($_SESSION['logged_in'])) {
            header("Location: /");
            exit;
        }
        return View::render('admin/change_password', ['message' => $_SESSION['message'] ?? '']);
    }

    /**
     * パスワード変更処理 (POST)
     */
    public function updatePassword() {
        verifyCsrfToken();
        if (!isset($_SESSION['logged_in'])) header("Location: /");

        $adminModel = new AdminUser();
        $user_id = $_SESSION['login_id'];
        
        try {
            $user = $adminModel->findById($user_id);
            if ($user && password_verify($_POST['current_pass'], $user['password_hash'])) {
                $new_hash = password_hash($_POST['new_pass'], PASSWORD_DEFAULT);
                $adminModel->updatePassword($user_id, $new_hash);
                
                $_SESSION['message'] = "パスワードを変更しました！";
                logAction($user_id, 'パスワード変更', '成功');
            } else {
                $_SESSION['message'] = "現在のパスワードが間違っています。";
                logAction($user_id, 'パスワード変更失敗', '入力ミス');
            }
        } catch (\Exception $e) {
            $_SESSION['message'] = "エラー: " . $e->getMessage();
        }

        // フォームへリダイレクト
        header("Location: /admin/password/change");
        exit;
    }

    /**
     * 管理者一覧・登録・削除画面 (旧 register_admin.php)
     */
    public function admins() {
        $this->requirePermission('admin');
        
        $adminModel = new AdminUser();
        $message = $_SESSION['message'] ?? '';
        unset($_SESSION['message']); // 一度表示したら消す

        $admin_list = $adminModel->findAll();

        return View::render('admin/register', [
            'admin_list' => $admin_list,
            'message' => $message
        ]);
    }

    /**
     * 管理者保存・削除処理 (POST)
     */
    public function storeAdmin() {
        $this->requirePermission('admin');
        verifyCsrfToken();

        $adminModel = new AdminUser();

        // 削除処理
        if (isset($_POST['delete_admin_id'])) {
            if ($_POST['delete_admin_id'] === $_SESSION['login_id']) {
                $_SESSION['message'] = "エラー：自分自身は削除できません。";
            } else {
                $adminModel->delete($_POST['delete_admin_id']);
                $_SESSION['message'] = "管理者ID: {$_POST['delete_admin_id']} を削除しました。";
                logAction($_SESSION['login_id'], '管理者削除', "対象: {$_POST['delete_admin_id']}");
            }
        }
        
        // 新規登録処理
        if (isset($_POST['new_admin_id'])) {
            if ($adminModel->exists($_POST['new_admin_id'])) {
                $_SESSION['message'] = "エラー：そのIDは既に登録されています。";
            } else {
                $perms = [
                    'data'  => isset($_POST['perm_data']) ? 1 : 0,
                    'admin' => isset($_POST['perm_admin']) ? 1 : 0,
                    'log'   => isset($_POST['perm_log']) ? 1 : 0
                ];
                $adminModel->create($_POST['new_admin_id'], $_POST['new_admin_pass'], $perms);
                $_SESSION['message'] = "管理者「{$_POST['new_admin_id']}」を登録しました。";
                logAction($_SESSION['login_id'], '管理者登録', "新規: {$_POST['new_admin_id']}");
            }
        }

        header("Location: /admin/users");
        exit;
    }

    /**
     * パスワード強制リセット画面 (旧 reset_admin_pass.php)
     */
    public function resetPasswordForm() {
        $this->requirePermission('admin');
        return View::render('admin/reset_password', [
            'target_id' => $_GET['id'] ?? '',
            'message' => $_SESSION['message'] ?? ''
        ]);
    }

    /**
     * パスワード強制リセット処理 (POST)
     */
    public function resetPasswordExec() {
        $this->requirePermission('admin');
        verifyCsrfToken();
        
        $adminModel = new AdminUser();
        $target = $_POST['reset_target_id'];

        if (!$adminModel->exists($target)) {
            $_SESSION['message'] = "エラー：ID「{$target}」は見つかりません。";
        } else {
            $hash = password_hash($_POST['reset_new_pass'], PASSWORD_DEFAULT);
            $adminModel->updatePassword($target, $hash);
            $_SESSION['message'] = "管理者「{$target}」のパスワードをリセットしました。";
            logAction($_SESSION['login_id'], 'PWリセット', "対象: $target");
        }

        header("Location: /admin/password/reset"); // 画面更新
        exit;
    }
}
</file>

<file path="src/Controllers/AuthController.php">
<?php

namespace App\Controllers;

use App\Models\AdminUser;
use App\Utils\View;

class AuthController
{

    // ログイン画面の表示（もし専用画面を作るならここ。今回はトップページにフォームがあるので使いません）
    public function showLoginForm()
    {
        // トップページへリダイレクト
        header("Location: /");
        exit;
    }

    // ログイン処理 (POST)
    public function login()
    {
        verifyCsrfToken(); // CSRF対策

        $login_id = $_POST['login_id'] ?? '';
        $password = $_POST['login_pass'] ?? '';

        $adminModel = new AdminUser();
        $message = "";

        try {
            // ユーザー取得
            $user = $adminModel->findById($login_id);

            // パスワード照合
            if ($user && password_verify($password, $user['password_hash'])) {
                // セッションID再生成（セッションハイジャック対策）
                session_regenerate_id(true);

                // セッション保存
                $_SESSION['logged_in'] = true;
                $_SESSION['login_id'] = $user['login_id'];
                $_SESSION['permissions'] = [
                    'data'  => $user['perm_data'],
                    'admin' => $user['perm_admin'],
                    'log'   => $user['perm_log'] ?? 0
                ];
                $_SESSION['role'] = $user['role'];

                // 失敗回数リセット
                $adminModel->resetFailureCount($login_id);

                // ログ記録 (functions.phpの関数)
                logAction($login_id, 'ログイン', '成功');

                // 成功したらトップへ
                header("Location: /");
                exit;
            } else {
                // ログイン失敗
                logAction($login_id ?: 'unknown', 'ログイン失敗', 'パスワード違いなど');

                // エラーメッセージをセッションに入れてトップへ戻す
                $_SESSION['message'] = "IDまたはパスワードが違います。";
                header("Location: /");
                exit;
            }
        } catch (\Exception $e) {
            // システムエラー
            $_SESSION['message'] = "システムエラーが発生しました。";
            error_log($e->getMessage());
            header("Location: /");
            exit;
        }
    }

    // ログアウト処理
    public function logout()
    {
        $user_id = $_SESSION['login_id'] ?? 'guest';
        logAction($user_id, 'ログアウト', '成功');

        // セッション破棄
        $_SESSION = [];
        if (ini_get("session.use_cookies")) {
            $params = session_get_cookie_params();
            setcookie(
                session_name(),
                '',
                time() - 42000,
                $params["path"],
                $params["domain"],
                $params["secure"],
                $params["httponly"]
            );
        }
        session_destroy();

        header("Location: /");
        exit;
    }
}
</file>

<file path="src/Controllers/KobanController.php">
<?php

namespace App\Controllers;

// 必要なクラス（部品）を読み込む宣言
use App\Models\Koban;       // データベース操作担当
use App\Utils\View;         // 画面表示担当 (さっき作ったやつ)
use App\Utils\Validator;    // 入力チェック担当

class KobanController
{

    /**
     * 一覧画面を表示する (旧 opendata.php の役割)
     */
    public function index()
    {
        // 1. モデルの呼び出し
        // 「交番データ」を扱うためのクラスをインスタンス化（実体化）します
        $kobanModel = new Koban();

        $log_detail = "トップ表示";

        // ▼▼▼ ログ用詳細情報の構築 ▼▼▼
        $conditions = [];
        if (!empty($_GET['keyword'])) {
            $conditions[] = "KW: " . $_GET['keyword'];
        }
        if (!empty($_GET['search_type'])) {
            $conditions[] = "種別: " . $_GET['search_type'];
        }
        if (!empty($_GET['search_pref'])) {
            $conditions[] = "県: " . $_GET['search_pref'];
        }
        if (!empty($_GET['sort'])) {
            // ソート順も記録しておくと分析に役立ちます
            $conditions[] = "順: " . $_GET['sort'];
        }

        // 条件がなければ「トップ表示」、あれば連結して記録
        $log_detail = empty($conditions) ? "トップ表示" : "検索実行 [" . implode(", ", $conditions) . "]";

        // ログ保存
        logAction($_SESSION['login_id'] ?? 'guest', 'アクセス', $log_detail);
        // ▲▲▲ 構築終了 ▲▲▲

        $message = $_SESSION['message'] ?? '';
        unset($_SESSION['message']);

        // 2. データの取得
        // $_GET にはURLのパラメータが入っています (例: ?keyword=新宿&page=2)
        // モデルの search メソッドに「検索条件」を渡して、結果をもらいます
        $limit = 100;
        $page = max(1, (int)($_GET['page'] ?? 1));
        $offset = ($page - 1) * $limit;

        $data = $kobanModel->search($_GET, $limit, $offset, $_GET['sort'] ?? 'id_asc');
        $total_count = $kobanModel->count($_GET);
        $total_pages = ceil($total_count / $limit);

        // 3. ビューの表示
        // 'home' は views/home.php を指します
        // 第2引数の配列が、home.php 内で変数として使えるようになります
        return View::render('home', [
            'all_data'    => $data,
            'total_count' => $total_count,
            'page'        => $page,
            'total_pages' => $total_pages,
            'message'     => $message ?? '', // メッセージ表示用
            'pref_list'   => ["北海道", "青森県", "岩手県", "宮城県", "秋田県", "山形県", "福島県", "茨城県", "栃木県", "群馬県", "埼玉県", "千葉県", "東京都", "神奈川県", "新潟県", "富山県", "石川県", "福井県", "山梨県", "長野県", "岐阜県", "静岡県", "愛知県", "三重県", "滋賀県", "京都府", "大阪府", "兵庫県", "奈良県", "和歌山県", "鳥取県", "島根県", "岡山県", "広島県", "山口県", "徳島県", "香川県", "愛媛県", "高知県", "福岡県", "佐賀県", "長崎県", "熊本県", "大分県", "宮崎県", "鹿児島県", "沖縄県"]
        ]);
    }

    /**
     * 新規作成フォームを表示する (旧 koban_form.php の初期表示)
     */
    public function create()
    {
        // 権限チェック (functions.phpの関数)
        if (!hasPermission('data')) {
            die('権限がありません');
        }

        $phone_parts = ['', '', ''];
        $postal_parts = ['', ''];

        // フォームを表示。新規なのでデータは空っぽです。
        return View::render('koban/form', [
            'page_title' => '新規データ登録',
            'edit_data'  => [],
            'message'    => '',
            'phone_parts' => $phone_parts,   // ビューへ渡す
            'postal_parts' => $postal_parts, // ビューへ渡す
        ]);
    }

    /**
     * 編集フォームを表示する
     */
    public function edit()
    {
        // 1. 権限チェックとID取得 (変更なし)
        if (!hasPermission('data')) {
            die('権限がありません');
        }

        $id = $_GET['id'] ?? null;
        if (!$id) {
            die('IDが指定されていません');
        }

        $kobanModel = new Koban();
        $data = $kobanModel->findById($id);

        if (!$data) {
            die('データが見つかりません');
        }

        // ▼▼▼ 修正: 「無し」データを空欄に変換するロジックを追加 ▼▼▼
        $keys_to_clean = ['phone_number', 'postal_code', 'group_code'];
        foreach ($keys_to_clean as $key) {
            if (isset($data[$key]) && $data[$key] === '無し') {
                $data[$key] = '';
            }
        }
        // ▲▲▲ 変換ロジックここまで ▲▲▲

        // 2. フォーム初期値の計算ロジック
        // phone_number と postal_code が空文字列になったため、以下のロジックが正しく動作します

        // 電話番号の分割
        $phone_parts = explode('-', $data['phone_number'] ?? '') + ['', '', ''];

        // 郵便番号の分割
        $p = $data['postal_code'] ?? '';
        $postal_parts = (strpos($p, '-') !== false) ? explode('-', $p) : [substr($p, 0, 3), substr($p, 3)];

        // 3. View にデータを渡して表示 (変更なし)
        return View::render('koban/form', [
            'page_title' => 'データ編集 (ID: ' . $data['id'] . ')',
            'edit_data'  => $data, // 変換済みの$dataを渡す
            'message'    => '',
            'phone_parts' => $phone_parts,
            'postal_parts' => $postal_parts,
        ]);
    }

    /**
     * データの保存処理を行う (新規・更新 共通)
     */
    public function store()
    {
        // CSRFトークンチェック (セキュリティ対策)
        verifyCsrfToken();

        if (!hasPermission('data')) {
            die('権限がありません');
        }

        // 1. 入力値のチェック (Validatorクラスを利用)
        $validator = new Validator();

        // データの整形（バリデーション前に一部実行）
        $raw_phone_parts = [$_POST['phone_part1'] ?? '', $_POST['phone_part2'] ?? '', $_POST['phone_part3'] ?? ''];
        $raw_postal = ($_POST['postal_part1'] ?? '') . ($_POST['postal_part2'] ?? '');

        if (!$validator->validateKoban($_POST)) {
            // エラーがあった場合、フォーム画面に戻す
            $errors = $validator->getErrors();

            // ★修正: エラー時も電話番号・郵便番号のパーツを渡すことで入力値を保持する
            return View::render('koban/form', [
                'page_title' => '入力エラー',
                'edit_data'  => $_POST,
                'message'    => implode('<br>', $errors),
                // 電話番号パーツはフォームからの入力をそのまま返す
                'phone_parts' => $raw_phone_parts,
                // 郵便番号パーツはフォームからの入力をそのまま返す
                'postal_parts' => [$_POST['postal_part1'] ?? '', $_POST['postal_part2'] ?? '']
            ]);
        }

        // 2. データの整形
        $kobanModel = new Koban();

        $group_code = $_POST['new_group_code'] ?? '';
        $group_code = empty($group_code) ? '無し' : $group_code;

        // ▼▼▼ 電話番号の結合と「無し」判定 ▼▼▼
        $phone = implode('-', array_filter($raw_phone_parts, fn($v) => $v !== ''));
        $phone = empty($phone) ? '無し' : $phone;

        // ▼▼▼ 郵便番号の結合と「無し」判定 ▼▼▼
        $postal = empty($raw_postal) ? '無し' : $raw_postal;


        // ▼▼▼ 住所結合処理（元のkoban_form.phpにあったロジックを移植） ▼▼▼
        // 全角数字の半角化、丁目/番地などをハイフンに置換
        $addr3 = str_replace(['丁目', '番地', '番', '号'], '-', mb_convert_kana($_POST['new_addr3'] ?? '', 'n', 'UTF-8'));
        // 連続するハイフンを一つにまとめ、末尾のハイフンを削除
        $addr3 = rtrim(preg_replace('/-+/', '-', $addr3), '-');


        // データベース保存用データ
        $saveData = [
            'koban_fullname' => $_POST['new_name'],
            'type'           => $_POST['new_type'],
            'phone_number'   => $phone,         // ★「無し」判定後の値
            'group_code'     => $group_code,
            'postal_code'    => $postal,        // ★「無し」判定後の値
            'pref'           => $_POST['new_pref'],
            'addr3'          => $addr3          // ★整形後の値
        ];

        // 3. DBへの保存
        if (!empty($_POST['update_id'])) {
            // IDがあるなら更新
            $kobanModel->update($_POST['update_id'], $saveData);
            $_SESSION['message'] = "ID: {$_POST['update_id']} を更新しました。";
            logAction($_SESSION['login_id'], 'データ更新', "ID: {$_POST['update_id']} を更新");
        } else {
            // IDがないなら新規作成
            $kobanModel->create($saveData);
            $_SESSION['message'] = "新規データを登録しました！";
            logAction($_SESSION['login_id'], 'データ登録', "新規: {$_POST['new_name']} を追加");
        }

        // 4. 一覧画面へリダイレクト (index.phpへ戻る)
        header("Location: /");
        exit;
    }

    /**
     * 削除処理
     */
    public function delete()
    {
        verifyCsrfToken();
        if (!hasPermission('data')) {
            die('権限がありません');
        }

        $id = $_POST['delete_id'] ?? null;
        if ($id) {
            $kobanModel = new Koban();
            $kobanModel->delete($id);
            $_SESSION['message'] = "ID: {$id} を削除しました。";
            logAction($_SESSION['login_id'], 'データ削除', "ID: {$id} を削除しました。");
        }

        header("Location: /");
        exit;
    }

    /**
     * CSV一括インポート処理
     */
    public function importCsv()
    {
        verifyCsrfToken();
        // データ編集権限がなければ終了
        if (!isset($_SESSION['logged_in']) || !hasPermission('data')) {
            $_SESSION['message'] = "データ編集の権限がありません。";
            header("Location: /koban/create");
            exit;
        }

        $kobanModel = new Koban();

        // 処理の本体 (旧koban_form.phpのインポート部分)
        if (isset($_FILES['csv_file']) && $_FILES['csv_file']['error'] == 0) {
            try {
                $handle = fopen($_FILES['csv_file']['tmp_name'], "r");
                if ($handle) {
                    $head = fgets($handle);
                    // 文字コード変換
                    if (mb_detect_encoding($head, ['UTF-8', 'SJIS-win'], true) !== 'UTF-8') {
                        rewind($handle);
                        stream_filter_append($handle, 'convert.iconv.cp932/utf-8');
                    } else {
                        rewind($handle);
                    }

                    fgetcsv($handle); // ヘッダスキップ
                    $rows = [];
                    while (($d = fgetcsv($handle, 1000, ",")) !== FALSE) {
                        if (!isset($d[0]) || !is_numeric($d[0])) continue;
                        $rows[] = $d;
                    }
                    fclose($handle);

                    // Modelで一括登録
                    $kobanModel->bulkInsert($rows);

                    $count = count($rows);
                    $_SESSION['message'] = "$count 件インポートしました。";
                    logAction($_SESSION['login_id'], 'CSVインポート', "$count 件登録");
                }
            } catch (\Exception $e) {
                $_SESSION['message'] = "インポートエラー: " . $e->getMessage();
            }
        } else {
            $_SESSION['message'] = "ファイルがアップロードされていません。";
        }

        // 処理完了後、フォーム画面に戻る
        header("Location: /koban/create");
        exit;
    }


    /**
     * CSVエクスポート処理
     */
    public function export()
    {
        // タイムアウト対策
        set_time_limit(0);

        // 出力バッファのクリア（余計な文字が含まれないようにする）
        if (ob_get_level()) ob_end_clean();

        try {
            $kobanModel = new Koban();

            // ログ用文字列の生成
            $log_detail = "CSVエクスポート: 全件";
            if (!empty($_GET['keyword'])) {
                $log_detail = "CSVエクスポート (検索: " . h($_GET['keyword']) . ")";
            }

            // ▼▼▼ ログ用詳細情報の構築（indexと同じロジック） ▼▼▼
            $conditions = [];
            if (!empty($_GET['keyword'])) {
                $conditions[] = "KW: " . $_GET['keyword'];
            }
            if (!empty($_GET['search_type'])) {
                $conditions[] = "種別: " . $_GET['search_type'];
            }
            if (!empty($_GET['search_pref'])) {
                $conditions[] = "県: " . $_GET['search_pref'];
            }

            $log_detail = empty($conditions) ? "CSV出力: 全件" : "CSV出力 [" . implode(", ", $conditions) . "]";

            // ログ保存
            logAction($_SESSION['login_id'] ?? 'guest', 'CSVエクスポート', $log_detail);
            // ▲▲▲ 構築終了 ▲▲▲

            // データの取得 (ジェネレータ)
            $sort = $_GET['sort'] ?? 'id_asc';
            $rows = $kobanModel->exportAll($_GET, $sort);

            // ファイル名設定
            $filename = "koban_all_" . date('Ymd_His') . ".csv";

            // HTTPヘッダー出力 (ダウンロードさせるための設定)
            header('Content-Type: text/csv');
            header('Content-Disposition: attachment; filename="' . $filename . '"');
            header('Pragma: no-cache');
            header('Expires: 0');

            // 出力ストリームを開く
            $output = fopen('php://output', 'w');

            // BOM付きUTF-8にする (Excel対策)
            fwrite($output, "\xEF\xBB\xBF");

            // ヘッダー行
            fputcsv($output, ['id', '交番名', '種別', '電話番号', '団体コード', '郵便番号', '都道府県', '住所']);

            // データ行の出力
            foreach ($rows as $row) {
                $line_data = array_map(function ($value) {
                    // ExcelでのCSVインジェクション対策（先頭が記号の場合にクォートする）
                    return (is_string($value) && preg_match('/^[\=\+\-\@\t\r\%]/', $value)) ? "'" . $value : $value;
                }, [
                    $row['id'],
                    $row['koban_fullname'],
                    $row['type'],
                    $row['phone_number'],
                    $row['group_code'],
                    $row['postal_code'],
                    $row['pref'],
                    $row['addr3']
                ]);
                fputcsv($output, $line_data);
            }

            fclose($output);
            exit; // 処理終了（ビューは表示しない）

        } catch (\Exception $e) {
            // エラー時はトップに戻すか、エラー表示
            error_log($e->getMessage());
            header("Location: /");
            exit;
        }
    }
}
</file>

<file path="src/Models/AdminUser.php">
<?php

namespace App\Models;

use App\Utils\Database;
use PDO;

class AdminUser
{
    // IDでユーザー情報を取得
    public function findById($login_id)
    {
        $db = Database::connect();
        $stmt = $db->prepare("SELECT * FROM admin_users WHERE login_id = ?");
        $stmt->execute([$login_id]);
        return $stmt->fetch(PDO::FETCH_ASSOC);
    }

    // ログイン成功時に失敗回数をリセット
    public function resetFailureCount($login_id)
    {
        $db = Database::connect();
        $stmt = $db->prepare("UPDATE admin_users SET failure_count = 0 WHERE login_id = ?");
        $stmt->execute([$login_id]);
    }

    // パスワード変更（change_password.php等で使用）
    public function updatePassword($login_id, $new_hash)
    {
        $db = Database::connect();
        $stmt = $db->prepare("UPDATE admin_users SET password_hash = ? WHERE login_id = ?");
        return $stmt->execute([$new_hash, $login_id]);
    }

    // 管理者作成（初期設定用）
    public function create($login_id, $password, $perms = [])
    {
        $db = Database::connect();
        $hash = password_hash($password, PASSWORD_DEFAULT);

        // 権限設定のデフォルト
        $p_data  = $perms['data'] ?? 1;
        $p_admin = $perms['admin'] ?? 1;
        $p_log   = $perms['log'] ?? 1;

        $sql = "INSERT INTO admin_users (login_id, password_hash, role, perm_data, perm_admin, perm_log) VALUES (?, ?, 1, ?, ?, ?)";
        $stmt = $db->prepare($sql);
        return $stmt->execute([$login_id, $hash, $p_data, $p_admin, $p_log]);
    }
    
    // ★追加: 全管理者を取得（一覧画面用）
    public function findAll() {
        $db = Database::connect();
        // 最終操作ログの日時もサブクエリで取得（元のロジックを継承）
        $sql = "SELECT u.login_id, u.perm_data, u.perm_admin, u.perm_log,
                (SELECT action_time FROM audit_logs l WHERE l.user_id = u.login_id ORDER BY id DESC LIMIT 1) as last_act_time,
                (SELECT action_type FROM audit_logs l WHERE l.user_id = u.login_id ORDER BY id DESC LIMIT 1) as last_act_type
                FROM admin_users u ORDER BY u.login_id ASC";
        return $db->query($sql)->fetchAll(PDO::FETCH_ASSOC);
    }

    // ★追加: 管理者削除
    public function delete($login_id) {
        $db = Database::connect();
        $stmt = $db->prepare("DELETE FROM admin_users WHERE login_id = ?");
        return $stmt->execute([$login_id]);
    }
    
    // ★追加: ID重複チェック用
    public function exists($login_id) {
        $db = Database::connect();
        $stmt = $db->prepare("SELECT COUNT(*) FROM admin_users WHERE login_id = ?");
        $stmt->execute([$login_id]);
        return $stmt->fetchColumn() > 0;
    }
}
</file>

<file path="src/Models/AuditLog.php">
<?php

namespace App\Models;

use App\Utils\Database;
use PDO;

class AuditLog
{

    // ログ検索・一覧取得
    public function search($params, $limit = 500)
    {
        $db = Database::connect();
        $query = $this->buildQuery($params);

        $sql = "SELECT * FROM audit_logs " . $query['where'] . " ORDER BY id DESC LIMIT " . (int)$limit;
        $stmt = $db->prepare($sql);
        $stmt->execute($query['params']);

        return $stmt->fetchAll(PDO::FETCH_ASSOC);
    }

    // 新しいログのみ取得（リアルタイム更新API用）
    public function getNewLogs($lastId, $params)
    {
        $db = Database::connect();
        $query = $this->buildQuery($params);

        // 既存の検索条件 AND id > ?
        $where = $query['where'] === "" ? "WHERE id > ?" : $query['where'] . " AND id > ?";
        $params = $query['params'];
        $params[] = $lastId;

        $stmt = $db->prepare("SELECT * FROM audit_logs " . $where . " ORDER BY id DESC");
        $stmt->execute($params);

        return $stmt->fetchAll(PDO::FETCH_ASSOC);
    }

    // 操作種別（Action Type）のリスト取得（ドロップダウン用）
    public function getActionTypes()
    {
        $db = Database::connect();
        return $db->query("SELECT DISTINCT action_type FROM audit_logs ORDER BY action_type ASC")
            ->fetchAll(PDO::FETCH_COLUMN);
    }

    // 内部用: 検索クエリ構築メソッド
    private function buildQuery($params)
    {
        $conditions = [];
        $sqlParams = [];

        // ユーザーID
        if (!empty($params['filter_user'])) {
            $conditions[] = "user_id LIKE ?";
            $sqlParams[] = '%' . $params['filter_user'] . '%';
        }

        // 操作種別
        if (!empty($params['filter_action'])) {
            if ($params['filter_action'] === 'AUTH_SET') {
                $conditions[] = "(action_type LIKE ? OR action_type LIKE ? OR action_type LIKE ?)";
                $sqlParams[] = '%ログイン%';
                $sqlParams[] = '%ログアウト%';
                $sqlParams[] = '%権限%';
            } else {
                $conditions[] = "action_type = ?";
                $sqlParams[] = $params['filter_action'];
            }
        }

        // 日時範囲
        if (!empty($params['filter_date_start'])) {
            $conditions[] = "action_time >= ?";
            $sqlParams[] = $params['filter_date_start'] . ' 00:00:00';
        }
        if (!empty($params['filter_date_end'])) {
            $conditions[] = "action_time <= ?";
            $sqlParams[] = $params['filter_date_end'] . ' 23:59:59';
        }

        // キーワード
        if (!empty($params['filter_keyword'])) {
            $conditions[] = "details LIKE ?";
            $sqlParams[] = '%' . $params['filter_keyword'] . '%';
        }

        $whereSql = !empty($conditions) ? "WHERE " . implode(' AND ', $conditions) : "";

        return ['where' => $whereSql, 'params' => $sqlParams];
    }
}
</file>

<file path="src/Models/Koban.php">
<?php

namespace App\Models;

use App\Utils\Database;
use PDO;

class Koban
{
    // 検索・一覧取得メソッド
    public function search($params, $limit, $offset, $sort)
    {
        $db = Database::connect();

        // 検索条件の構築 (functions.phpの関数を利用)
        $searchData = buildSearchQuery($params);
        $sql = "SELECT * FROM koban " . $searchData['sql'];

        // ソート順の決定
        $sort_sql = match ($sort) {
            'id_desc' => "ORDER BY id DESC",
            'name_asc' => "ORDER BY koban_fullname ASC",
            default => "ORDER BY id ASC"
        };
        $sql .= " $sort_sql LIMIT $limit OFFSET $offset";

        $stmt = $db->prepare($sql);
        $stmt->execute($searchData['params']);
        return $stmt->fetchAll(PDO::FETCH_ASSOC);
    }

    // 総件数を取得するメソッド（ページネーション用）
    public function count($params)
    {
        $db = Database::connect();
        $searchData = buildSearchQuery($params);

        $stmt = $db->prepare("SELECT COUNT(*) FROM koban " . $searchData['sql']);
        $stmt->execute($searchData['params']);
        return $stmt->fetchColumn();
    }

    // 削除メソッド
    public function delete($id)
    {
        $db = Database::connect();
        $stmt = $db->prepare("DELETE FROM koban WHERE id = ?");
        return $stmt->execute([$id]);
    }

    // ★追加: IDで1件データを取得（編集画面用
    public function findById($id)
    {
        $db = Database::connect();
        $stmt = $db->prepare("SELECT * FROM koban WHERE id = ?");
        $stmt->execute([$id]);
        return $stmt->fetch(PDO::FETCH_ASSOC);
    }

    // ★追加: 新規登録
    public function create($data) {
        $db = Database::connect();
        $sql = "INSERT INTO koban (koban_fullname, type, phone_number, group_code, postal_code, pref, addr3) VALUES (?, ?, ?, ?, ?, ?, ?)";
        $stmt = $db->prepare($sql);
        return $stmt->execute([
            $data['koban_fullname'],
            $data['type'],
            $data['phone_number'],
            $data['group_code'],
            $data['postal_code'],
            $data['pref'],
            $data['addr3']
        ]);
    }

    // ★追加: 更新
    public function update($id, $data) {
        $db = Database::connect();
        $sql = "UPDATE koban SET koban_fullname=?, type=?, phone_number=?, group_code=?, postal_code=?, pref=?, addr3=? WHERE id=?";
        $stmt = $db->prepare($sql);
        return $stmt->execute([
            $data['koban_fullname'],
            $data['type'],
            $data['phone_number'],
            $data['group_code'],
            $data['postal_code'],
            $data['pref'],
            $data['addr3'],
            $id
        ]);
    }

    // ★追加: CSV一括登録（トランザクション対応）
    public function bulkInsert($rows) {
        $db = Database::connect();
        try {
            $db->beginTransaction();
            $stmt = $db->prepare("INSERT OR REPLACE INTO koban (id, koban_fullname, type, phone_number, group_code, postal_code, pref, addr3) VALUES (?,?,?,?,?,?,?,?)");
            foreach ($rows as $row) {
                // 配列の要素数が足りない場合は空文字で埋める
                $stmt->execute(array_pad($row, 8, ''));
            }
            $db->commit();
            return true;
        } catch (\Exception $e) {
            $db->rollBack();
            throw $e;
        }
    }

    // ★追加: CSV出力用に全件を1行ずつ返す (ジェネレータ)
    public function exportAll($params, $sort) {
        $db = Database::connect();
        
        // functions.php の buildSearchQuery を利用
        $searchData = buildSearchQuery($params);
        $sql = "SELECT * FROM koban " . $searchData['sql'];
        
        // ソート順
        $sort_sql = match ($sort) {
            'id_desc' => "ORDER BY id DESC",
            'name_asc' => "ORDER BY koban_fullname ASC",
            default => "ORDER BY id ASC"
        };
        $sql .= " $sort_sql"; // LIMITとOFFSETは付けない！

        // プリペアドステートメント実行
        // (バッファなしクエリの設定などはSQLiteの場合あまり気にしなくてOKですが、MySQL等の場合はここで設定します)
        $stmt = $db->prepare($sql);
        $stmt->execute($searchData['params']);

        // ★ここがポイント: fetchAllせず、1行ずつ yield で返す
        while ($row = $stmt->fetch(PDO::FETCH_ASSOC)) {
            yield $row;
        }
    }
}
</file>

<file path="src/Utils/Database.php">
<?php

namespace App\Utils;

use PDO;
use PDOException;

class Database
{
    // データベース接続を返す静的メソッド
    public static function connect(): PDO
    {
        // ※パスに注意: コンテナ内の絶対パス、または相対パスを指定
        // ここではプロジェクトルートにある koban.sqlite を想定しています
        $dbPath = $_ENV['DB_PATH'] ?? __DIR__ . '/../../SQL/opendata.sqlite';

        try {
            $pdo = new PDO("sqlite:" . $dbPath);
            $pdo->setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION);
            $pdo->setAttribute(PDO::ATTR_DEFAULT_FETCH_MODE, PDO::FETCH_ASSOC);
            return $pdo;
        } catch (PDOException $e) {
            // 本番環境(production)ならエラー詳細を隠す
            if (isset($_ENV['APP_ENV']) && $_ENV['APP_ENV'] === 'production') {
                error_log($e->getMessage()); // サーバーのログには残す
                exit('ただいまアクセスが集中しているか、メンテナンス中です。');
            }
            // 開発環境ならエラーを表示
            exit('DB Connection Error: ' . $e->getMessage());
        }
    }
}
</file>

<file path="src/Utils/functions.php">
<?php
// 名前空間は定義せず、グローバル関数として扱います

use App\Utils\Database;

define('PAGE_LIMIT', 100);
date_default_timezone_set('Asia/Tokyo');
// HTMLエスケープ (頻繁に使うので短い名前のまま)
function h($str)
{
    return htmlspecialchars($str ?? '', ENT_QUOTES, 'UTF-8');
}

// CSRFトークン検証
function verifyCsrfToken()
{
    // セッションが開始されていなければ開始
    if (session_status() === PHP_SESSION_NONE) {
        session_start();
    }

    // トークン生成（なければ作る）
    if (empty($_SESSION['csrf_token'])) {
        $_SESSION['csrf_token'] = bin2hex(random_bytes(32));
    }

    // POST送信時はチェックを行う
    if ($_SERVER['REQUEST_METHOD'] === 'POST') {
        if (!isset($_POST['csrf_token']) || $_POST['csrf_token'] !== $_SESSION['csrf_token']) {
            http_response_code(403);
            die('CSRF Token Verification Failed');
        }
    }
}

function sendSecurityHeaders() {
    // クリックジャッキング対策（iframeでの表示を禁止）
    header('X-Frame-Options: DENY');
    
    // XSSフィルター機能の強制有効化（古いブラウザ向け）
    header('X-XSS-Protection: 1; mode=block');
    
    // コンテンツタイプのスニッフィング防止（画像に見せかけたスクリプト実行などを防ぐ）
    header('X-Content-Type-Options: nosniff');
    
    // 可能な限りHTTPSを強制（本番環境のみ推奨）
    // header('Strict-Transport-Security: max-age=31536000; includeSubDomains');
}

// 権限チェックヘルパー
function hasPermission($type)
{
    if (!isset($_SESSION['permissions'])) return false;
    return !empty($_SESSION['permissions'][$type]);
}

// ログ記録 (Databaseクラスを使う形に少し修正)
function logAction($userId, $actionType, $details)
{
    // 引数から $db を消し、内部で取得するように変更すると使いやすくなります
    try {
        $db = Database::connect(); // さきほど作ったクラスを利用
        $sql = "INSERT INTO audit_logs (user_id, action_type, details, ip_address, user_agent, action_time) VALUES (?, ?, ?, ?, ?, ?)";
        $stmt = $db->prepare($sql);
        $stmt->execute([
            $userId,
            $actionType,
            $details,
            $_SERVER['REMOTE_ADDR'] ?? '',
            $_SERVER['HTTP_USER_AGENT'] ?? '',
            date('Y-m-d H:i:s')
        ]);
    } catch (Exception $e) {
        // ログ記録失敗はメイン処理を止めないように握りつぶすことが多い
    }
}

// 検索クエリ構築ヘルパー（元のcommon.phpからロジックを移動）
function buildSearchQuery($getParams)
{
    $where_clauses = [];
    $params = [];
    $log_parts = [];

    $keyword = $getParams['keyword'] ?? '';
    $type = $getParams['search_type'] ?? '';
    $pref = $getParams['search_pref'] ?? '';

    if ($keyword !== "") {
        $keywords = preg_split('/[\s]+/', mb_convert_kana($keyword, 's', 'UTF-8'));
        foreach ($keywords as $word) {
            if ($word === "") continue;
            $where_clauses[] = "(pref LIKE ? OR id LIKE ? OR koban_fullname LIKE ? OR addr3 LIKE ?)";
            $params = array_merge($params, array_fill(0, 4, "%" . $word . "%"));
        }
        $log_parts[] = "KW: $keyword";
    }
    if ($type !== "") {
        $where_clauses[] = "type = ?";
        $params[] = $type;
        $log_parts[] = "種別: $type";
    }
    if ($pref !== "") {
        $where_clauses[] = "pref = ?";
        $params[] = $pref;
        $log_parts[] = "県: $pref";
    }

    $where_sql = !empty($where_clauses) ? "WHERE " . implode(' AND ', $where_clauses) : "";

    return [
        'sql' => $where_sql,
        'params' => $params,
        'log_detail' => empty($log_parts) ? "全データ" : implode(' ', $log_parts)
    ];
}
</file>

<file path="src/Utils/Validator.php">
<?php
namespace App\Utils;

class Validator {
    private $errors = [];

    public function validateKoban($data) {
        // 1. 必須チェック
        if (empty($data['new_name'])) {
            $this->errors['new_name'] = '交番名は必須です。';
        }

        // 2. 文字数チェック (例: 100文字以内)
        if (mb_strlen($data['new_name']) > 100) {
            $this->errors['new_name'] = '交番名は100文字以内で入力してください。';
        }

        // 3. 形式チェック (例: グループコードは半角英数のみ)
        // preg_match は正規表現でチェックします
        if (!empty($data['new_group_code']) && !preg_match('/^[0-9]+$/', $data['new_group_code'])) {
            $this->errors['new_group_code'] = '団体コードは半角数字で入力してください。';
        }

        $phone_raw = ($data['phone_part1'] ?? '') . ($data['phone_part2'] ?? '') . ($data['phone_part3'] ?? '');
        $postal_raw = ($data['postal_part1'] ?? '') . ($data['postal_part2'] ?? '');
        if (!empty($postal_raw) && !preg_match('/^[0-9]+$/', $postal_raw)) {
            $this->errors['postal'] = '郵便番号は半角数字のみで入力してください。';
        }

        return empty($this->errors);
    }

    public function getErrors() {
        return $this->errors;
    }
}
</file>

<file path="src/Utils/View.php">
<?php

namespace App\Utils;

class View
{
    /**
     * ビューファイルを読み込んで表示する
     * * @param string $viewName ビュー名 (例: 'home' や 'koban/form')
     * @param array $data ビューに渡したいデータの配列
     */
    public static function render($viewName, $data = [])
    {
        // 配列のキーを変数名として展開 (例: ['user' => 'Mike'] → $user = 'Mike')
        extract($data);

        // ビューファイルのパスを構築 (viewsフォルダ配下を探す)
        $filePath = __DIR__ . '/../../views/' . $viewName . '.php';

        if (file_exists($filePath)) {
            require $filePath;
        } else {
            // ファイルがない場合のエラー処理（開発用）
            echo "View file not found: " . htmlspecialchars($viewName);
        }
    }
}
</file>

<file path="views/admin/change_password.php">
<?php require __DIR__ . '/../layouts/header.php'; ?>

<div style="width: 400px; margin: 50px auto; background-color: #1a1a1a; padding: 20px; border: 1px solid #333; border-radius: 10px; box-shadow: 0px 0px 20px rgba(78, 78, 78, 0.4); text-align: center; color: #1eff1a; font-family: sans-serif;">
    <h2>パスワード変更</h2>

    <p style="color: <?php echo strpos($message, '変更しました') !== false ? '#1eff1a' : '#ff4444'; ?>;">
        <?php echo h($message); ?>
    </p>

    <p style="font-size: 14px; color: #ccc;">
        対象ID: <b><?php echo h($_SESSION['login_id'] ?? '不明'); ?></b>
    </p>

    <form method="post" action="/admin/password/update" style="display: flex; flex-direction: column; gap: 15px; text-align: left;">
        <input type="hidden" name="csrf_token" value="<?php echo h($_SESSION['csrf_token']); ?>">
        <div>
            <label style="color:#ccc;">現在のパスワード:</label>
            <input type="password" name="current_pass" required style="width: 100%; padding: 8px; background:#333; color:#fff; border:1px solid #555; box-sizing: border-box;">
        </div>
        <div>
            <label style="color:#ccc;">新しいパスワード:</label>
            <input type="password" name="new_pass" required style="width: 100%; padding: 8px; background:#333; color:#fff; border:1px solid #555; box-sizing: border-box;">
        </div>
        <input type="submit" value="変更する" style="background-color: #1eff1a; border: none; padding: 10px; cursor: pointer; font-weight: bold; margin-top: 10px; border-radius: 5px;">
    </form>

    <br>
    <a href="/" style="color: #888;">検索ページに戻る</a>
</div>
</file>

<file path="views/admin/log_list.php">
<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>操作ログ監査</title>
    <style>
        body {
            background-color: #010000;
            color: #1eff1a;
            font-family: sans-serif;
            text-align: center;
        }

        table {
            width: 95%;
            margin: 20px auto;
            border-collapse: collapse;
            border: 1px solid #333;
        }

        th,
        td {
            border: 1px solid #444;
            padding: 8px;
            text-align: left;
            font-size: 14px;
        }

        th {
            background-color: #333;
            color: #fff;
            text-align: center;
        }

        tr:nth-child(even) {
            background-color: #111;
        }

        tr:hover {
            background-color: #222;
        }

        /* 新着ログのアニメーション用 */
        @keyframes flash {
            0% {
                background-color: #ffff00;
                color: #000;
            }

            100% {
                background-color: transparent;
                color: #1eff1a;
            }
        }

        .new-log {
            animation: flash 2s ease-out;
        }

        .search-box {
            background-color: #1a1a1a;
            padding: 15px;
            margin: 20px auto;
            width: 90%;
            border: 1px solid #333;
            border-radius: 8px;
            text-align: left;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
            justify-content: center;
        }

        input,
        select {
            padding: 6px;
            background: #333;
            color: #fff;
            border: 1px solid #555;
            border-radius: 4px;
        }

        .btn {
            padding: 8px 15px;
            font-weight: bold;
            cursor: pointer;
            border-radius: 5px;
            border: none;
        }

        .btn-search {
            background-color: #1eff1a;
            color: #000;
        }

        .btn-csv {
            background-color: #ffff00;
            color: #000;
            margin-left: auto;
        }

        .btn-reset {
            background-color: #555;
            color: #fff;
            text-decoration: none;
            padding: 6px 12px;
            font-size: 12px;
            display: inline-block;
            border-radius: 4px;
        }

        .btn-back {
            background-color: #333;
            color: #fff;
            text-decoration: none;
            display: inline-block;
            border: 1px solid #555;
            padding: 5px 10px;
        }

        .danger {
            color: #ff4444;
        }

        .login {
            color: #00ccff;
        }

        .num-col {
            text-align: center;
            color: #888;
            font-weight: bold;
        }

        /* 更新インジケーター */
        #live-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            background-color: #555;
            border-radius: 50%;
            margin-left: 10px;
            transition: background-color 0.3s;
        }

        #live-indicator.active {
            background-color: #1eff1a;
            box-shadow: 0 0 5px #1eff1a;
        }
    </style>
</head>

<body>

    <h2>システム操作ログ監査 <span id="live-indicator" title="リアルタイム更新待機中..."></span></h2>
    <div style="width: 90%; margin: 0 auto; text-align: left;">
        <a href="/" class="btn btn-back">← 検索画面に戻る</a>
    </div>

    <form method="get" class="search-box" id="searchForm">
        <div>
            <label>ユーザーID:</label>
            <input type="text" name="filter_user" value="<?php echo h($_GET['filter_user'] ?? ''); ?>" size="10" placeholder="部分一致">
        </div>
        <div>
            <label>操作:</label>
            <select name="filter_action">
                <option value="">(すべて)</option>
                <option value="AUTH_SET" style="color: #00ccff; font-weight: bold;" <?php if (($_GET['filter_action'] ?? '') === 'AUTH_SET') echo 'selected'; ?>>
                    【 認証・セッション関連 】
                </option>
                <option disabled>----------------</option>
                <?php foreach ($types as $t): ?>
                    <option value="<?php echo h($t); ?>" <?php if (($_GET['filter_action'] ?? '') === $t) echo 'selected'; ?>>
                        <?php echo h($t); ?>
                    </option>
                <?php endforeach; ?>
            </select>
        </div>
        <button type="submit" class="btn btn-search">検索</button>
        <a href="/admin/logs" class="btn-reset">リセット</a>
        <button type="submit" name="download_csv" value="1" class="btn btn-csv">結果をCSV保存</button>
    </form>

    <div style="width: 95%; margin: 0 auto; text-align: left; margin-bottom: 5px;">
        該当件数: <span style="font-weight: bold; font-size: 1.2em;" id="count-display"><?php echo count($logs); ?></span> 件 (最大500件)
    </div>

    <table id="logTable">
        <thead>
            <tr>
                <th width="5%">No.</th>
                <th width="5%">DB-ID</th>
                <th width="15%">日時</th>
                <th width="10%">ユーザー</th>
                <th width="10%">操作</th>
                <th width="40%">詳細</th>
                <th width="15%">環境情報</th>
            </tr>
        </thead>
        <tbody id="logTableBody">
            <?php if (empty($logs)): ?>
                <tr id="no-logs-row">
                    <td colspan="7" style="text-align: center; padding: 20px; color: #888;">ログが見つかりません</td>
                </tr>
            <?php else: ?>
                <?php $row_num = count($logs); ?>
                <?php foreach ($logs as $log): ?>
                    <tr>
                        <td class="num-col"><?php echo $row_num--; ?></td>
                        <td style="text-align:center; color:#666; font-size:0.9em;"><?php echo h($log['id']); ?></td>
                        <td><?php echo h($log['action_time']); ?></td>
                        <td><?php echo h($log['user_id']); ?></td>
                        <td style="font-weight: bold; text-align: center;">
                            <?php
                            $act = h($log['action_type']);
                            if (strpos($act, '削除') !== false || strpos($act, '失敗') !== false || strpos($act, 'エラー') !== false || strpos($act, '拒否') !== false) {
                                echo "<span class='danger'>$act</span>";
                            } elseif (strpos($act, 'ログイン') !== false) {
                                echo "<span class='login'>$act</span>";
                            } else {
                                echo $act;
                            }
                            ?>
                        </td>
                        <td><?php echo h($log['details']); ?></td>
                        <td style="font-size: 12px; color: #888;">
                            <div>IP: <?php echo h($log['ip_address']); ?></div>
                        </td>
                    </tr>
                <?php endforeach; ?>
            <?php endif; ?>
        </tbody>
    </table>

    <script>
        // PHPから渡された最新のIDを初期値としてセット
        let latestId = <?php echo (int)$latest_id; ?>;

        // 1.5秒ごとに新しいログを取りに行くタイマーを開始
        setInterval(fetchNewLogs, 1500);

        function fetchNewLogs() {
            // 検索フォームに入力されている条件を取得
            const formData = new FormData(document.getElementById('searchForm'));
            const params = new URLSearchParams(formData);

            // 「今の最新IDより後のデータ」をください、というパラメータを追加
            params.append('last_id', latestId);

            // ★修正ポイント: URLを新しいAPIエンドポイントに変更
            fetch('/admin/api/logs?' + params.toString())
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    // エラーが返ってきた場合はログに出して終了
                    if (data.error) {
                        console.error('API Error:', data.error);
                        return;
                    }

                    // 新しいログがあれば画面に追加
                    if (data.length > 0) {
                        updateTable(data);
                    }

                    // 動作確認用の「緑の点」をピカッとさせる
                    flashIndicator();
                })
                .catch(error => console.error('Fetch error:', error));
        }

        // テーブルを更新する関数
        function updateTable(newLogs) {
            const tbody = document.getElementById('logTableBody');
            const noLogsRow = document.getElementById('no-logs-row');
            const countDisplay = document.getElementById('count-display');

            // 「ログが見つかりません」の表示があれば消す
            if (noLogsRow) {
                noLogsRow.remove();
            }

            // 受け取ったログ配列（降順）を逆転させて、古い順にする
            // これにより、forEachで順番に「先頭へ挿入」していくと、最終的に正しい順序（最新が一番上）になる
            newLogs.slice().reverse().forEach(log => {
                // 最新IDを更新（次のリクエスト用）
                if (parseInt(log.id) > latestId) {
                    latestId = parseInt(log.id);
                }

                // HTMLの行を作成
                const row = document.createElement('tr');
                row.className = 'new-log'; // CSSアニメーション（黄色く光る）を適用

                // 操作種別の色分け（PHP側と同じロジック）
                let actionHtml = log.action_type;
                if (log.action_type.match(/削除|失敗|エラー|拒否/)) {
                    actionHtml = `<span class='danger'>${log.action_type}</span>`;
                } else if (log.action_type.match(/ログイン/)) {
                    actionHtml = `<span class='login'>${log.action_type}</span>`;
                }

                // ▼▼▼ 修正箇所: 1行目の td を "NEW" に変更 ▼▼▼
                row.innerHTML = `
                    <td class="num-col" style="color: #ffff00; font-weight: bold; font-size: 0.8em;">NEW</td>
                    <td style="text-align:center; color:#666; font-size:0.9em;">${log.id}</td>
                    <td>${log.action_time}</td>
                    <td>${log.user_id}</td>
                    <td style="font-weight: bold; text-align: center;">${actionHtml}</td>
                    <td>${log.details}</td>
                    <td style="font-size: 12px; color: #888;">
                        <div>IP: ${log.ip_address}</div>
                    </td>
                `;
                // ▲▲▲ 修正ここまで ▲▲▲

                // テーブルの一番上に追加
                tbody.insertAdjacentElement('afterbegin', row);
            });

            // 件数表示を更新
            if (countDisplay) {
                countDisplay.textContent = tbody.rows.length;
            }
        }

        // 通信インジケーターのアニメーション
        function flashIndicator() {
            const indicator = document.getElementById('live-indicator');
            if (indicator) {
                indicator.classList.add('active');
                setTimeout(() => indicator.classList.remove('active'), 500);
            }
        }
    </script>
</body>

</html>
</file>

<file path="views/admin/register.php">
<?php require __DIR__ . '/../layouts/header.php'; // まだ作成していない場合は適宜調整 
?>

<div style="width: 850px; margin: 30px auto; background-color: #1a1a1a; padding: 20px; border: 1px solid #333; border-radius: 10px; color: #1eff1a; font-family: sans-serif;">
    <h2 style="text-align: center;">管理者権限 管理パネル</h2>

    <?php if ($message): ?>
        <p style="color: #ff4444; font-weight: bold; border: 1px solid #555; padding: 10px; text-align: center;">
            <?php echo h($message); ?>
        </p>
    <?php endif; ?>

    <div style="border-bottom: 1px solid #444; padding-bottom: 20px; margin-bottom: 20px;">
        <h3 style="color: #fff; margin-top: 0;">新規管理者 登録</h3>
        <form method="post" action="/admin/users/store" style="display: flex; flex-direction: column; gap: 10px; text-align: left; width: 70%; margin: 0 auto;">
            <input type="hidden" name="csrf_token" value="<?php echo h($_SESSION['csrf_token']); ?>">
            <div>
                <label>新規ID:</label>
                <input type="text" name="new_admin_id" required style="width: 95%; background:#333; color:#fff; border:1px solid #555; padding:5px;">
            </div>
            <div>
                <label>パスワード:</label>
                <input type="password" name="new_admin_pass" required style="width: 95%; background:#333; color:#fff; border:1px solid #555; padding:5px;">
            </div>

            <div style="background: #222; padding: 10px; border-radius: 5px; border: 1px solid #444;">
                <label style="color: #ccc; font-size: 12px; display:block; margin-bottom:5px;">権限設定:</label>
                <label style="display:block; margin-bottom:3px;"><input type="checkbox" name="perm_data" value="1" checked> <span style="color: #ffff00;">データ管理</span></label>
                <label style="display:block; margin-bottom:3px;"><input type="checkbox" name="perm_admin" value="1"> <span style="color: #00ccff;">アカウント管理</span></label>
                <label style="display:block;"><input type="checkbox" name="perm_log" value="1"> <span style="color: #ff88ff;">ログ閲覧</span></label>
            </div>

            <input type="submit" value="登録する" style="background-color: #1eff1a; border: none; padding: 8px; cursor: pointer; font-weight: bold; margin-top:5px;">
        </form>
    </div>

    <div>
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
            <h3 style="color: #fff; margin: 0;">現在の管理者一覧</h3>
            <a href="/admin/password/reset" style="background: #333; color: #ffff00; text-decoration: none; padding: 5px 10px; border: 1px solid #ffff00; border-radius: 4px; font-size: 12px;">
                🔑 パスワードリセット画面へ
            </a>
        </div>

        <table border="1" style="width: 100%; border-collapse: collapse; border-color: #555;">
            <tr style="background: #333; color: #fff;">
                <th>ID</th>
                <th>データ</th>
                <th>アカウント</th>
                <th>ログ</th>
                <th>最終更新</th>
                <th>操作</th>
            </tr>
            <?php foreach ($admin_list as $admin): ?>
                <tr>
                    <td style="padding: 8px; font-weight: bold;"><?php echo h($admin['login_id']); ?></td>
                    <td style="text-align: center;">
                        <?php echo ($admin['perm_data'] == 1) ? "<span style='color:#ffff00;'>●</span>" : "<span style='color:#333;'>-</span>"; ?>
                    </td>
                    <td style="text-align: center;">
                        <?php echo ($admin['perm_admin'] == 1) ? "<span style='color:#00ccff;'>●</span>" : "<span style='color:#333;'>-</span>"; ?>
                    </td>
                    <td style="text-align: center;">
                        <?php echo ($admin['perm_log'] == 1) ? "<span style='color:#ff88ff;'>●</span>" : "<span style='color:#333;'>-</span>"; ?>
                    </td>
                    <td style="padding: 8px; text-align: center; color: #ccc; font-size: 14px;">
                        <?php echo $admin['last_act_time'] ? date('m/d H:i', strtotime($admin['last_act_time'])) : "-"; ?>
                    </td>
                    <td style="padding: 8px; text-align: center;">
                        <?php if ($admin['login_id'] !== $_SESSION['login_id']): ?>
                            <div style="display: flex; gap: 5px; justify-content: center;">
                                <a href="/admin/password/reset?id=<?php echo h($admin['login_id']); ?>" style="background: #ffff00; color: #000; text-decoration: none; padding: 3px 8px; font-size: 11px; border-radius: 3px;">PW変更</a>
                                <form method="post" action="/admin/users/store" onsubmit="return confirm('本当に「<?php echo h($admin['login_id']); ?>」を削除しますか？');">
                                    <input type="hidden" name="csrf_token" value="<?php echo h($_SESSION['csrf_token']); ?>">
                                    <input type="hidden" name="delete_admin_id" value="<?php echo h($admin['login_id']); ?>">
                                    <input type="submit" value="削除" style="background: #ff4444; color: #fff; border: none; cursor: pointer; border-radius: 3px; padding: 3px 8px; font-size: 11px;">
                                </form>
                            </div>
                        <?php else: ?>
                            <span style="color: #888; font-size: 12px;">(自分)</span>
                        <?php endif; ?>
                    </td>
                </tr>
            <?php endforeach; ?>
        </table>
    </div>
    <br><a href="/" style="color: #888;">メイン画面に戻る</a>
</div>
</file>

<file path="views/admin/reset_password.php">
<?php require __DIR__ . '/../layouts/header.php'; ?>

<div style="width: 500px; margin: 50px auto; background-color: #1a1a1a; padding: 30px; border: 1px solid #333; border-radius: 10px; text-align: left; color: #1eff1a; font-family: sans-serif;">
    <h2 style="color: #fff; margin-top: 0; text-align: center; border-bottom: 1px solid #444; padding-bottom: 10px;">パスワード強制リセット</h2>

    <?php if ($message): ?>
        <p style="color: <?php echo strpos($message, 'エラー') !== false ? '#ff4444' : '#1eff1a'; ?>; font-weight: bold; text-align: center;">
            <?php echo h($message); ?>
        </p>
    <?php endif; ?>

    <p style="font-size: 13px; color: #ccc;">
        指定した管理者IDのパスワードを強制的に上書きします。<br>
        <span style="color: #ff4444;">※現在のパスワードを知らなくても変更可能です。</span>
    </p>

    <form method="post" onsubmit="return confirm('本当にパスワードを変更しますか？\nこの操作は取り消せません。');">
        <input type="hidden" name="csrf_token" value="<?php echo h($_SESSION['csrf_token']); ?>">

        <div style="margin-bottom: 15px;">
            <label style="color: #fff;">対象の管理者ID:</label>
            <input type="text" name="reset_target_id" value="<?php echo h($target_id); ?>" required placeholder="user_id" style="width: 100%; padding: 8px; margin-top: 5px; background: #333; color: #fff; border: 1px solid #555;">
        </div>

        <div style="margin-bottom: 15px;">
            <label style="color: #fff;">新しいパスワード:</label>
            <input type="password" name="reset_new_pass" required placeholder="New Password" style="width: 100%; padding: 8px; margin-top: 5px; background: #333; color: #fff; border: 1px solid #555;">
        </div>

        <input type="submit" value="変更を実行する" style="width: 100%; background-color: #ffff00; color: #000; border: none; padding: 10px; cursor: pointer; font-weight: bold; margin-top: 20px; font-size: 16px; border-radius: 4px;">
    </form>

    <div style="text-align: center; margin-top: 20px;">
        <a href="/admin/users" style="color: #888; text-decoration: none;">管理者一覧に戻る</a>
    </div>
</div>
</file>

<file path="views/home.php">
<?php
require __DIR__ . '/layouts/header.php';
?>

<div class="container">
    <?php if ($message): ?>
        <div style="color: #ff4444; font-weight: bold; margin-bottom:10px; border: 1px solid #ff4444; padding: 10px;"><?php echo h($message); ?></div>
    <?php endif; ?>

    <div class="box">
        <?php if (!isset($_SESSION['logged_in'])): ?>
            <form method="post" action="/auth/login" style="text-align: right;">
                <input type="hidden" name="csrf_token" value="<?php echo h($_SESSION['csrf_token']); ?>">
                <span style="color: #888; font-size: 14px;">管理者ログイン: </span>
                <input type="text" name="login_id" placeholder="ID" size="10">
                <input type="password" name="login_pass" placeholder="PASS" size="10">
                <input type="submit" value="ログイン" class="btn-primary">
            </form>
        <?php else: ?>
            <div style="border-bottom: 1px solid #444; margin-bottom: 10px; padding-bottom: 10px; text-align: right;">
                <span style="color: #1eff1aff;">ログイン中: <?php echo h($_SESSION['login_id']); ?></span> |

                <?php if (hasPermission('log')): ?>
                    <a href="/admin/logs" style="color: #00ccff;">[操作ログ監査]</a> |
                <?php endif; ?>

                <?php if (hasPermission('admin')): ?>
                    <a href="/admin/users" style="color: #ffff00;">[管理者登録]</a> |
                <?php endif; ?>

                <a href="/admin/password/change" style="color: #fff;">[PW変更]</a> |
                <form action="/auth/logout" method="post" style="display:inline;">
                    <button type="submit" style="background:none; border:none; color:#888; text-decoration:underline; cursor:pointer;">ログアウト</button>
                </form>
            </div>

            <div style="text-align: left;">
                <?php if (hasPermission('data')): ?>
                    <a href="/koban/create" class="btn-primary btn" style="padding: 10px 20px;">＋ 新規データ追加 / CSV登録</a>
                <?php else: ?>
                    <span style="color: #888;">※データ編集権限がありません</span>
                <?php endif; ?>
            </div>
        <?php endif; ?>
    </div>

    <div class="box" style="background-color: #282828;">
        <h2 style="margin-top: 0; border-bottom: 1px solid #444; padding-bottom: 5px; font-size: 20px;">条件検索</h2>
        <form action="" method="get">
            <div class="flex-row" style="justify-content: center;">
                <select name="search_pref">
                    <option value="">都道府県 (すべて)</option>
                    <?php foreach ($pref_list as $p) echo "<option value='{$p}' " . (($_GET['search_pref'] ?? '') == $p ? 'selected' : '') . ">{$p}</option>"; ?>
                </select>
                <select name="search_type">
                    <option value="">種別 (すべて)</option>
                    <option value="交番" <?php if (($_GET['search_type'] ?? '') == '交番') echo 'selected'; ?>>交番</option>
                    <option value="駐在所" <?php if (($_GET['search_type'] ?? '') == '駐在所') echo 'selected'; ?>>駐在所</option>
                </select>
                <input type="text" name="keyword" placeholder="キーワード (例: 新宿)" value="<?php echo h($_GET['keyword'] ?? ''); ?>" style="background: #fff; color: #000;" size="30">
                <select name="sort">
                    <option value="id_asc">ID昇順</option>
                    <option value="id_desc" <?php if (($_GET['sort'] ?? '') == 'id_desc') echo 'selected'; ?>>ID降順</option>
                    <option value="name_asc" <?php if (($_GET['sort'] ?? '') == 'name_asc') echo 'selected'; ?>>名前順</option>
                </select>
                <input type="submit" value="絞り込み検索" class="btn-primary">
            </div>
            <p style="font-size: 12px; color: #888; text-align: center; margin-bottom: 0;">※スペース区切りで複数の言葉を検索できます（例：東京都 新宿）</p>
        </form>

        <div style="margin-top: 20px; text-align: right; border-top: 1px solid #444; padding-top: 10px; display: flex; justify-content: flex-end; gap: 10px;">
            <form action="/koban/export" method="get">
                <button type="submit" class="btn-secondary">全データをCSV保存</button>
            </form>
            <form action="/koban/export" method="get">
                <?php foreach (['keyword', 'search_type', 'search_pref'] as $k) echo '<input type="hidden" name="' . $k . '" value="' . h($_GET[$k] ?? '') . '">'; ?>
                <button type="submit" class="btn-primary" style="color: #000;">検索結果をCSV保存</button>
            </form>
        </div>
    </div>

    <div style="text-align: left; margin-bottom: 5px; font-size: 18px;">
        <?php if ($total_count > 0): ?>
            検索結果： <span style="font-weight: bold; font-size: 24px; color: #1eff1a;"><?php echo $total_count; ?></span> 件
        <?php else: ?>
            <span style="color: #ff4444;">条件に一致するデータは見つかりませんでした。</span>
        <?php endif; ?>
    </div>

    <table>
        <tr style="background-color: #4a4a4a;">
            <th width="5%">ID</th>
            <th width="20%">交番名</th>
            <th width="5%">種別</th>
            <th width="10%">TEL</th>
            <th width="5%">団体コード</th>
            <th width="8%">郵便番号</th>
            <th>住所</th>
            <?php if (isset($_SESSION['logged_in'])): ?><th width="10%" style="background-color: #550000;">操作</th><?php endif; ?>
        </tr>
        <?php foreach ($all_data as $row): ?>
            <tr>
                <td style="text-align: center;"><?php echo h($row['id']); ?></td>
                <td><?php echo h($row['koban_fullname']); ?></td>
                <td style="text-align: center;"><?php echo h($row['type']); ?></td>
                <td style="text-align: center;"><?php echo h($row['phone_number']); ?></td>
                <td style="text-align: center;"><?php echo h($row['group_code']); ?></td>
                <td style="text-align: center;"><?php echo h($row['postal_code']); ?></td>

                <td>
                    <a href="https://www.google.com/maps/search/?api=1&query=<?php echo urlencode($row['pref'] . $row['addr3']); ?>"
                        target="_blank"
                        style="color: #1eff1a; text-decoration: underline;"
                        title="Googleマップで見る">
                        <?php echo h($row['pref'] . $row['addr3']); ?>
                    </a>
                </td>

                <?php if (isset($_SESSION['logged_in'])): ?>
                    <td style="text-align: center;">
                        <?php if (hasPermission('data')): ?>
                            <div style="display: flex; justify-content: center; gap: 5px;">
                                <a href="/koban/edit?id=<?php echo h($row['id']); ?>" class="btn btn-warning" style="padding: 4px 8px; font-size:12px;">編集</a>
                                <form method="post" action="/koban/delete" onsubmit="return confirm('本当に削除しますか？');">
                                    <input type="hidden" name="csrf_token" value="<?php echo h($_SESSION['csrf_token']); ?>">
                                    <input type="hidden" name="delete_id" value="<?php echo h($row['id']); ?>">
                                    <input type="submit" value="削除" class="btn-danger" style="padding: 4px 8px; font-size:12px;">
                                </form>
                            </div>
                        <?php else: ?>
                            <span style="font-size: 10px; color: #888;">操作不可</span>
                        <?php endif; ?>
                    </td>
                <?php endif; ?>
            </tr>
        <?php endforeach; ?>
    </table>

    <div class="pagination" style="margin-top: 20px;">
        <?php
        $q = http_build_query(array_filter($_GET, fn($k) => $k != 'page', ARRAY_FILTER_USE_KEY));
        $link = "?$q&page=";
        if ($page > 1) {
            echo '<a href="' . $link . '1" class="other">&laquo; 最初</a>';
            echo '<a href="' . $link . ($page - 1) . '" class="other">&lsaquo; 前へ</a>';
        }
        for ($i = max(1, $page - 3); $i <= min($total_pages, $page + 3); $i++) {
            $class = ($i == $page) ? 'current' : 'other';
            echo '<a href="' . $link . $i . '" class="' . $class . '">' . $i . '</a>';
        }
        if ($page < $total_pages) {
            echo '<a href="' . $link . ($page + 1) . '" class="other">次へ &rsaquo;</a>';
            echo '<a href="' . $link . $total_pages . '" class="other">最後 &raquo;</a>';
        }
        ?>
    </div>
    <p style="color: #888; font-size: 12px; margin-top: 5px;">
        全 <?php echo $total_count; ?> 件中、<?php echo $page; ?> ページ目を表示
    </p>
</div>
</body>

</html>
</file>

<file path="views/koban/form.php">
<?php require __DIR__ . '/../layouts/header.php'; ?>

<div class="container">
    <div style="text-align: left; margin-bottom: 15px;">
        <a href="/" class="btn btn-secondary">← 一覧に戻る</a>
    </div>

    <?php if ($message): ?>
        <div style="color: #ff4444; margin-bottom: 15px; font-weight: bold; border: 1px solid red; padding: 10px;">
            <?php echo h($message); ?>
        </div>
    <?php endif; ?>

    <div class="box">
        <h2 style="margin-top:0; border-bottom: 1px solid #444; padding-bottom: 10px;">
            <?php echo h($page_title); ?>
        </h2>

        <form method="post" action="/koban/store" class="h-adr" style="display: flex; flex-direction: column; gap: 15px; text-align: left;">
            <input type="hidden" name="csrf_token" value="<?php echo h($_SESSION['csrf_token']); ?>">
            <input type="hidden" name="save_data" value="1">
            <span class="p-country-name" style="display:none;">Japan</span>

            <?php if (!empty($edit_data['id'])): ?>
                <input type="hidden" name="update_id" value="<?php echo h($edit_data['id']); ?>">
                <p style="color: #888; font-size: 12px;">ID: <?php echo h($edit_data['id']); ?> を編集中</p>
            <?php endif; ?>

            <div>
                <label>交番名 <span style="color: #ff4444;">*</span></label>
                <input type="text" name="new_name" placeholder="例: 明治大学前交番" required
                    value="<?php echo h($edit_data['koban_fullname'] ?? ''); ?>" style="width: 100%;">
            </div>

            <div>
                <label>種別</label><br>
                <?php $cur = $edit_data['type'] ?? '交番'; ?>
                <label><input type="radio" name="new_type" value="交番" <?php if ($cur == '交番') echo 'checked'; ?>> 交番</label>
                <label style="margin-left: 15px;"><input type="radio" name="new_type" value="駐在所" <?php if ($cur == '駐在所') echo 'checked'; ?>> 駐在所</label>
            </div>

            <div>
                <label>電話番号</label>
                <div style="display: flex; gap: 5px; align-items: center;">
                    <input type="text" name="phone_part1" value="<?php echo h($phone_parts[0] ?? ''); ?>" size="6"> -
                    <input type="text" name="phone_part2" value="<?php echo h($phone_parts[1] ?? ''); ?>" size="6"> -
                    <input type="text" name="phone_part3" value="<?php echo h($phone_parts[2] ?? ''); ?>" size="6">
                </div>
            </div>

            <div>
                <label>全国地方公共団体コード</label>
                <input type="tel" name="new_group_code" value="<?php echo h($edit_data['group_code'] ?? ''); ?>" style="width: 100%;">
            </div>

            <div>
                <label>郵便番号 <span style="font-size:12px; color:#ffff00;">(自動入力対応)</span></label>
                <div style="display: flex; gap: 5px; align-items: center;">
                    〒 <input type="text" name="postal_part1" maxlength="3" value="<?php echo h($postal_parts[0] ?? ''); ?>" class="p-postal-code" size="5"> -
                    <input type="text" name="postal_part2" maxlength="4" value="<?php echo h($postal_parts[1] ?? ''); ?>" class="p-postal-code" size="6">
                </div>
            </div>

            <div>
                <label>都道府県 / 市区町村</label>
                <div style="display: flex; gap: 10px;">
                    <input type="text" name="new_pref" placeholder="都道府県" value="<?php echo h($edit_data['pref'] ?? ''); ?>" class="p-region" style="width: 30%;">
                    <input type="text" name="new_addr3" placeholder="市区町村以下" value="<?php echo h($edit_data['addr3'] ?? ''); ?>" class="p-locality p-street-address p-extended-address" style="width: 70%;">
                </div>
            </div>

            <div style="text-align: center; margin-top: 20px;">
                <input type="submit" value="<?php echo !empty($edit_data) ? '変更を保存' : 'データベースに追加'; ?>" class="btn-primary" style="padding: 10px 40px;">
            </div>
        </form>
    </div>

    <div class="box" style="margin-top: 30px;">
        <h3 style="margin-top: 0; color: #ccc;">CSV一括インポート</h3>

        <form method="post" action="/koban/import" enctype="multipart/form-data" style="display: flex; gap: 10px; align-items: center;">

            <input type="hidden" name="csrf_token" value="<?php echo h($_SESSION['csrf_token']); ?>">

            <input type="file" name="csv_file" accept=".csv" required style="color: #fff;">
            <input type="submit" value="インポート実行" class="btn-warning">
        </form>
        <p style="font-size: 11px; color: #888;">※列順: id, 名前, 種別, 電話, コード, 〒, 都道府県, 住所</p>
    </div>

</div>
<script src="https://yubinbango.github.io/yubinbango/yubinbango.js" charset="UTF-8"></script>
</body>

</html>
</file>

<file path="views/layouts/header.php">
<?php require_once __DIR__ . '/../../vendor/autoload.php'; ?>
<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <title><?php echo h($page_title ?? '交番データベース'); ?></title>
    <link rel="stylesheet" href="../../public/css/style.css">
</head>

<body>
    <h1><?php echo h($page_title ?? 'R6 交番・駐在所検索データベース'); ?></h1>
</file>

</files>
