This file is a merged representation of the entire codebase, combined into a single document by Repomix.

<file_summary>
This section contains a summary of this file.

<purpose>
This file contains a packed representation of the entire repository's contents.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.
</purpose>

<file_format>
The content is organized as follows:
1. This summary section
2. Repository information
3. Directory structure
4. Repository files (if enabled)
5. Multiple file entries, each consisting of:
  - File path as an attribute
  - Full contents of the file
</file_format>

<usage_guidelines>
- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.
</usage_guidelines>

<notes>
- Some files may have been excluded based on .gitignore rules and Repomix's configuration
- Binary files are not included in this packed representation. Please refer to the Repository Structure section for a complete list of file paths, including binary files
- Files matching patterns in .gitignore are excluded
- Files matching default ignore patterns are excluded
- Files are sorted by Git change count (files with more changes are at the bottom)
</notes>

</file_summary>

<directory_structure>
.gitignore
.htaccess
composer.json
docker-compose.yml
Dockerfile
index.php
public/.htaccess
public/css/style.css
public/index.php
README.md
SQL/.htaccess
src/Controllers/AdminController.php
src/Controllers/AuthController.php
src/Controllers/KobanController.php
src/Models/AdminUser.php
src/Models/AuditLog.php
src/Models/Koban.php
src/Utils/Cache.php
src/Utils/Database.php
src/Utils/functions.php
src/Utils/Validator.php
src/Utils/View.php
views/admin/change_password.php
views/admin/edit_admin.php
views/admin/log_list.php
views/admin/register.php
views/admin/reset_password.php
views/admin/user_registration.php
views/auth/login.php
views/auth/register.php
views/components/alert.php
views/components/request_link.php
views/home.php
views/koban/form.php
views/layouts/footer.php
views/layouts/header.php
</directory_structure>

<files>
This section contains the contents of the repository's files.

<file path="README.md">
# R6 äº¤ç•ªãƒ»é§åœ¨æ‰€æ¤œç´¢ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹
(Koban Search App)

ã“ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã¯ã€å…¨å›½ã®äº¤ç•ªãŠã‚ˆã³é§åœ¨æ‰€ã®æƒ…å ±ã‚’æ¤œç´¢ãƒ»ç®¡ç†ã™ã‚‹ãŸã‚ã®Webã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã§ã‚ã‚Šã€PHP 8.2ã¨Dockerç’°å¢ƒã‚’ãƒ™ãƒ¼ã‚¹ã«ã—ã¦ã„ã¾ã™ã€‚DBã«é–¢ã™ã‚‹çŸ¥è­˜ã®å­¦ç¿’ã‚’ç›®çš„ã¨ã—ã¦ã„ã¾ã™ã€‚

---

#### ãƒ‡ãƒ¼ã‚¿å‡ºå…¸ï¼š[e-Gov ãƒ‡ãƒ¼ã‚¿ãƒãƒ¼ã‚¿ãƒ« - äº¤ç•ªãƒ»é§åœ¨æ‰€ã‚ªãƒ¼ãƒ—ãƒ³ãƒ‡ãƒ¼ã‚¿](https://data.e-gov.go.jp/data/ja/dataset/04b81179-879c-40e7-ab86-9f097ffac49d/resource/18ce28d1-e3b6-43dd-a3c9-6d4b767bace0?inner_span=True&activity_id=7f92bdf3-a897-4a1e-88d5-59755ea7d37b)

## ğŸš€ ä¸»ãªæ©Ÿèƒ½

### ğŸ” æ¤œç´¢ãƒ»é–²è¦§
* **æ¡ä»¶æ¤œç´¢**: IDã€éƒ½é“åºœçœŒã€ç¨®åˆ¥ï¼ˆäº¤ç•ª/é§åœ¨æ‰€ï¼‰ã€ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ï¼ˆåç§°ã‚„ä½æ‰€ï¼‰ã«ã‚ˆã‚‹çµã‚Šè¾¼ã¿ã€‚
* **ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³**: å¤§é‡ãƒ‡ãƒ¼ã‚¿ã®å¿«é©ãªé–²è¦§ï¼ˆ1ãƒšãƒ¼ã‚¸100ä»¶è¡¨ç¤ºï¼‰ã€‚
* **å¤–éƒ¨é€£æº**: ä½æ‰€ã‹ã‚‰Googleãƒãƒƒãƒ—ã¸ã®ãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆãƒªãƒ³ã‚¯æ©Ÿèƒ½ã€‚

### ğŸ” ç®¡ç†è€…ãƒ»ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£
* **æ¨©é™ç®¡ç†**: ã€Œãƒ‡ãƒ¼ã‚¿ç®¡ç†ã€ã€Œã‚¢ã‚«ã‚¦ãƒ³ãƒˆç®¡ç†ã€ã€Œãƒ­ã‚°é–²è¦§ã€ã®3æ®µéšã®ãƒ‘ãƒ¼ãƒŸãƒƒã‚·ãƒ§ãƒ³è¨­å®šã€‚
* **èªè¨¼ã‚·ã‚¹ãƒ†ãƒ **: å®‰å…¨ãªãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒãƒƒã‚·ãƒ¥ï¼ˆ`password_hash`ï¼‰ã¨ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†ã€‚
* **CSRFå¯¾ç­–**: ã™ã¹ã¦ã®POSTãƒªã‚¯ã‚¨ã‚¹ãƒˆã«å¯¾ã™ã‚‹ãƒˆãƒ¼ã‚¯ãƒ³æ¤œè¨¼ã€‚
* **æ“ä½œãƒ­ã‚°ç›£æŸ»**: ã‚·ã‚¹ãƒ†ãƒ å†…ã®ä¸»è¦ãªæ“ä½œã‚’è¨˜éŒ²ã—ã€ç®¡ç†è€…ãƒ‘ãƒãƒ«ã‹ã‚‰ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§ç¢ºèªå¯èƒ½ã€‚

### ğŸ“Š ãƒ‡ãƒ¼ã‚¿ç®¡ç†
* **CRUDæ“ä½œ**: ãƒ–ãƒ©ã‚¦ã‚¶ä¸Šã§ã®æ–°è¦ç™»éŒ²ã€ç·¨é›†ã€å‰Šé™¤ã€‚
* **CSVã‚¤ãƒ³ãƒãƒ¼ãƒˆ**: å¤–éƒ¨ãƒ‡ãƒ¼ã‚¿ã®ä¸€æ‹¬å–ã‚Šè¾¼ã¿æ©Ÿèƒ½ï¼ˆUPSERTå¯¾å¿œï¼‰ã€‚
* **CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ**: æ¤œç´¢çµæœã¾ãŸã¯å…¨ãƒ‡ãƒ¼ã‚¿ã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã€‚

---

## ğŸ›  æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯

* **Language**: PHP 8.2 (Apache)
* **Architecture**: MVCï¼ˆModel-View-Controllerï¼‰ãƒ‘ã‚¿ãƒ¼ãƒ³
* **Database**:
    * æœ¬ç•ªç’°å¢ƒ: PostgreSQL (Renderç­‰ã§ã®é‹ç”¨ã‚’æƒ³å®š)
    * ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒ: SQLite
* **Environment**: Docker / Docker Compose
* **Frontend**: Vanilla JS (Real-time Log API), CSS3 (Cyber-style Green UI)
* **Dependencies**: 
    * `phpdotenv`: ç’°å¢ƒå¤‰æ•°ç®¡ç†
    * `composer`: ãƒ©ã‚¤ãƒ–ãƒ©ãƒªç®¡ç†

---

## ğŸ“ ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ 

```text
.
â”œâ”€â”€ Dockerfile              # Dockerã‚¤ãƒ¡ãƒ¼ã‚¸å®šç¾©
â”œâ”€â”€ docker-compose.yml      # ã‚³ãƒ³ãƒ†ãƒŠæ§‹æˆç®¡ç†
â”œâ”€â”€ index.php               # ã‚¨ãƒ³ãƒˆãƒªãƒã‚¤ãƒ³ãƒˆï¼ˆpublic/index.phpã¸å§”è­²ï¼‰
â”œâ”€â”€ public/                 # å…¬é–‹ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªï¼ˆé™çš„ãƒ•ã‚¡ã‚¤ãƒ«ã€ãƒ•ãƒ­ãƒ³ãƒˆã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ï¼‰
â”‚   â”œâ”€â”€ css/                # ã‚¹ã‚¿ã‚¤ãƒ«ã‚·ãƒ¼ãƒˆ
â”‚   â””â”€â”€ index.php           # ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°å‡¦ç†
â”œâ”€â”€ src/                    # ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ­ã‚¸ãƒƒã‚¯
â”‚   â”œâ”€â”€ Controllers/        # å„ç”»é¢ã®åˆ¶å¾¡ï¼ˆAuth, Admin, Kobanï¼‰
â”‚   â”œâ”€â”€ Models/             # ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ“ä½œï¼ˆKoban, AdminUser, AuditLogï¼‰
â”‚   â””â”€â”€ Utils/              # å…±é€šãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ï¼ˆDatabase, Cache, Validatorï¼‰
â”œâ”€â”€ views/                  # UIãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆï¼ˆPHP/HTMLï¼‰
â”‚   â”œâ”€â”€ admin/              # ç®¡ç†è€…ç”¨ç”»é¢
â”‚   â”œâ”€â”€ koban/              # ãƒ‡ãƒ¼ã‚¿ç®¡ç†ç”»é¢
â”‚   â””â”€â”€ layouts/            # å…±é€šãƒ˜ãƒƒãƒ€ãƒ¼ç­‰
â”œâ”€â”€ SQL/                    # ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹é–¢é€£ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆSQLiteç­‰ï¼‰
â””â”€â”€ storage/                # æ›¸ãè¾¼ã¿å¯èƒ½ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªï¼ˆCacheç”¨ï¼‰
```

## âš¡ èµ·å‹•æ‰‹é †ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™ºç’°å¢ƒï¼‰

1. æº–å‚™
Docker Desktop ãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãƒ»èµ·å‹•ã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚

2. ç’°å¢ƒå¤‰æ•°ã®è¨­å®š
ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ«ãƒ¼ãƒˆã« .env ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¾ã™ã€‚

ã‚³ãƒ¼ãƒ‰ ã‚¹ãƒ‹ãƒšãƒƒãƒˆ

* ãƒ­ãƒ¼ã‚«ãƒ«ã§SQLiteã‚’ä½¿ç”¨ã™ã‚‹å ´åˆã¯ç©ºæ¬„ã€PostgreSQLã‚’ä½¿ç”¨ã™ã‚‹å ´åˆã¯URLã‚’è¨˜è¿°

DATABASE_URL=

3. ã‚³ãƒ³ãƒ†ãƒŠã®ãƒ“ãƒ«ãƒ‰ãƒ»èµ·å‹•
ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã§ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚

```Bash
docker-compose up -d --build
```

4. ãƒ–ãƒ©ã‚¦ã‚¶ã§ã‚¢ã‚¯ã‚»ã‚¹
ä»¥ä¸‹ã®URLã‚’é–‹ãã¾ã™ã€‚ http://localhost:8080

## ğŸ”§ é–‹ç™ºãƒ»é‹ç”¨ãƒ¡ãƒ¢
- ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ©Ÿèƒ½: src/Utils/Cache.php ã«ã‚ˆã‚Šã€æ¤œç´¢çµæœã‚„ä»¶æ•°å–å¾—ã‚’ãƒ•ã‚¡ã‚¤ãƒ«ãƒ™ãƒ¼ã‚¹ã§ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã—ã€DBè² è·ã‚’è»½æ¸›ã—ã¦ã„ã¾ã™ã€‚

- ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ­ã‚°: views/admin/log_list.php ã§ã¯ JavaScript ã® fetch ã‚’ç”¨ã„ã¦ã€ãƒšãƒ¼ã‚¸é·ç§»ãªã—ã§æœ€æ–°ã®æ“ä½œãƒ­ã‚°ã‚’è‡ªå‹•æ›´æ–°è¡¨ç¤ºã—ã¾ã™ã€‚

- ãƒ‡ãƒ—ãƒ­ã‚¤: Dockerfile ã¯ Render ç­‰ã® PaaS ç’°å¢ƒï¼ˆ$PORT ç’°å¢ƒå¤‰æ•°å¯¾å¿œï¼‰ã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’è€ƒæ…®ã—ã¦è¨­è¨ˆã•ã‚Œã¦ã„ã¾ã™ã€‚

ğŸ“ ãƒ©ã‚¤ã‚»ãƒ³ã‚¹
ã“ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®å–ã‚Šæ‰±ã„ã«ã¤ã„ã¦ã¯ã€ç®¡ç†è€…ã«ç¢ºèªã—ã¦ãã ã•ã„ã€‚
</file>

<file path=".gitignore">
# ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆPostgreSQLã¸ç§»è¡Œæ¸ˆã¿ã®ãŸã‚ä¸è¦ï¼‰
/SQL/opendata.sqlite
/SQL/log_archives/

# ç’°å¢ƒå¤‰æ•°ï¼ˆèªè¨¼æƒ…å ±ãŒå«ã¾ã‚Œã‚‹ãŸã‚çµ¶å¯¾ã«å…¬é–‹ã—ãªã„ï¼‰
.env

# PHPä¾å­˜ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ï¼ˆã‚µãƒ¼ãƒãƒ¼å´ã§ composer install ã™ã‚‹ãŸã‚ä¸è¦ï¼‰
/vendor/

# OSã‚„ã‚¨ãƒ‡ã‚£ã‚¿ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ•ã‚¡ã‚¤ãƒ«
.DS_Store
/node_modules/
.vscode/
</file>

<file path=".htaccess">
<IfModule mod_rewrite.c>
    RewriteEngine On

    # â–¼â–¼â–¼ è¿½åŠ : é‡è¦ãªãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã¸ã®ç›´æ¥ã‚¢ã‚¯ã‚»ã‚¹ã‚’ç¦æ­¢ â–¼â–¼â–¼
    RewriteRule ^(src|views|vendor|SQL)/ - [F,L]
    RewriteRule ^composer\.(json|lock)$ - [F,L]
    # â–²â–²â–² è¿½åŠ ã“ã“ã¾ã§ â–²â–²â–²
    # ãƒ•ã‚¡ã‚¤ãƒ«ã‚„ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒå­˜åœ¨ã—ãªã‘ã‚Œã° index.php ã«è»¢é€
    RewriteCond %{REQUEST_FILENAME} !-f
    RewriteCond %{REQUEST_FILENAME} !-d
    RewriteRule ^(.*)$ index.php [QSA,L]
</IfModule>
</file>

<file path="composer.json">
{
    "name": "miyashu/koban-app",
    "autoload": {
        "psr-4": {
            "App\\": "src/"
        },
        "files": [
            "src/Utils/functions.php"
        ]
    },
    "require": {
        "vlucas/phpdotenv": "^5.6"
    }
}
</file>

<file path="docker-compose.yml">
services:
  web:
    build: .
    ports:
      - "8080:80"
    volumes:
      - .:/var/www/html
</file>

<file path="index.php">
<?php
// ãƒ«ãƒ¼ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã® index.php

// ã™ã¹ã¦ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ public/index.php ã«ä¸¸æŠ•ã’ï¼ˆå§”è­²ï¼‰ã—ã¾ã™
require_once __DIR__ . '/public/index.php';
</file>

<file path="public/.htaccess">
<IfModule mod_rewrite.c>
    RewriteEngine On

    # å®Ÿåœ¨ã™ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆç”»åƒã€CSSã€JSãªã©ï¼‰ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã¯ãã®ã¾ã¾é€šã™
    RewriteCond %{REQUEST_FILENAME} !-f
    RewriteCond %{REQUEST_FILENAME} !-d

    # ãã‚Œä»¥å¤–ã¯ã™ã¹ã¦ index.php ã«è»¢é€ã™ã‚‹
    RewriteRule ^(.*)$ index.php [QSA,L]
</IfModule>
</file>

<file path="SQL/.htaccess">
<FilesMatch "\.(sqlite|csv|log|bak|sql)$">
    Require all denied
</FilesMatch>

Qptions -Indexes
</file>

<file path="src/Models/AuditLog.php">
<?php

namespace App\Models;

use App\Utils\Database;
use PDO;

class AuditLog
{

    // ãƒ­ã‚°æ¤œç´¢ãƒ»ä¸€è¦§å–å¾—
    public function search($params, $limit = 500)
    {
        $db = Database::connect();
        $query = $this->buildQuery($params);

        $sql = "SELECT * FROM audit_logs " . $query['where'] . " ORDER BY id DESC LIMIT " . (int)$limit;
        $stmt = $db->prepare($sql);
        $stmt->execute($query['params']);

        return $stmt->fetchAll(PDO::FETCH_ASSOC);
    }

    // æ–°ã—ã„ãƒ­ã‚°ã®ã¿å–å¾—ï¼ˆãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°APIç”¨ï¼‰
    public function getNewLogs($lastId, $params)
    {
        $db = Database::connect();
        $query = $this->buildQuery($params);

        // æ—¢å­˜ã®æ¤œç´¢æ¡ä»¶ AND id > ?
        $where = $query['where'] === "" ? "WHERE id > ?" : $query['where'] . " AND id > ?";
        $params = $query['params'];
        $params[] = $lastId;

        $stmt = $db->prepare("SELECT * FROM audit_logs " . $where . " ORDER BY id DESC");
        $stmt->execute($params);

        return $stmt->fetchAll(PDO::FETCH_ASSOC);
    }

    // æ“ä½œç¨®åˆ¥ï¼ˆAction Typeï¼‰ã®ãƒªã‚¹ãƒˆå–å¾—ï¼ˆãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ç”¨ï¼‰
    public function getActionTypes()
    {
        $db = Database::connect();
        return $db->query("SELECT DISTINCT action_type FROM audit_logs ORDER BY action_type ASC")
            ->fetchAll(PDO::FETCH_COLUMN);
    }

    // å†…éƒ¨ç”¨: æ¤œç´¢ã‚¯ã‚¨ãƒªæ§‹ç¯‰ãƒ¡ã‚½ãƒƒãƒ‰
    private function buildQuery($params)
    {
        $conditions = [];
        $sqlParams = [];

        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ID
        if (!empty($params['filter_user'])) {
            $conditions[] = "user_id LIKE ?";
            $sqlParams[] = '%' . $params['filter_user'] . '%';
        }

        // æ“ä½œç¨®åˆ¥
        if (!empty($params['filter_action'])) {
            if ($params['filter_action'] === 'AUTH_SET') {
                $conditions[] = "(action_type LIKE ? OR action_type LIKE ? OR action_type LIKE ?)";
                $sqlParams[] = '%ãƒ­ã‚°ã‚¤ãƒ³%';
                $sqlParams[] = '%ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ%';
                $sqlParams[] = '%æ¨©é™%';
            } else {
                $conditions[] = "action_type = ?";
                $sqlParams[] = $params['filter_action'];
            }
        }

        // æ—¥æ™‚ç¯„å›²
        if (!empty($params['filter_date_start'])) {
            $conditions[] = "action_time >= ?";
            $sqlParams[] = $params['filter_date_start'] . ' 00:00:00';
        }
        if (!empty($params['filter_date_end'])) {
            $conditions[] = "action_time <= ?";
            $sqlParams[] = $params['filter_date_end'] . ' 23:59:59';
        }

        // ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰
        if (!empty($params['filter_keyword'])) {
            $conditions[] = "details LIKE ?";
            $sqlParams[] = '%' . $params['filter_keyword'] . '%';
        }

        $whereSql = !empty($conditions) ? "WHERE " . implode(' AND ', $conditions) : "";

        return ['where' => $whereSql, 'params' => $sqlParams];
    }
}
</file>

<file path="views/admin/change_password.php">
<?php require __DIR__ . '/../layouts/header.php'; ?>

<div style="width: 400px; margin: 50px auto; background-color: #1a1a1a; padding: 20px; border: 1px solid #333; border-radius: 10px; box-shadow: 0px 0px 20px rgba(78, 78, 78, 0.4); text-align: center; color: #1eff1a; font-family: sans-serif;">
    <h2>ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´</h2>

    <p style="color: <?php echo strpos($message, 'å¤‰æ›´ã—ã¾ã—ãŸ') !== false ? '#1eff1a' : '#ff4444'; ?>;">
        <?php echo h($message); ?>
    </p>

    <p style="font-size: 14px; color: #ccc;">
        å¯¾è±¡ID: <b><?php echo h($_SESSION['login_id'] ?? 'ä¸æ˜'); ?></b>
    </p>

    <form method="post" action="/admin/password/update" style="display: flex; flex-direction: column; gap: 15px; text-align: left;">
        <input type="hidden" name="csrf_token" value="<?php echo h($_SESSION['csrf_token']); ?>">
        <div>
            <label style="color:#ccc;">ç¾åœ¨ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰:</label>
            <input type="password" name="current_pass" required style="width: 100%; padding: 8px; background:#333; color:#fff; border:1px solid #555; box-sizing: border-box;">
        </div>
        <div>
            <label style="color:#ccc;">æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰:</label>
            <input type="password" name="new_pass" required style="width: 100%; padding: 8px; background:#333; color:#fff; border:1px solid #555; box-sizing: border-box;">
        </div>
        <input type="submit" value="å¤‰æ›´ã™ã‚‹" style="background-color: #1eff1a; border: none; padding: 10px; cursor: pointer; font-weight: bold; margin-top: 10px; border-radius: 5px;">
    </form>

    <br>
    <a href="/" style="color: #888;">æ¤œç´¢ãƒšãƒ¼ã‚¸ã«æˆ»ã‚‹</a>
</div>
</file>

<file path="views/admin/log_list.php">
<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>æ“ä½œãƒ­ã‚°ç›£æŸ»</title>
    <style>
        body {
            background-color: #010000;
            color: #1eff1a;
            font-family: sans-serif;
            text-align: center;
        }

        table {
            width: 95%;
            margin: 20px auto;
            border-collapse: collapse;
            border: 1px solid #333;
        }

        th,
        td {
            border: 1px solid #444;
            padding: 8px;
            text-align: left;
            font-size: 14px;
        }

        th {
            background-color: #333;
            color: #fff;
            text-align: center;
        }

        tr:nth-child(even) {
            background-color: #111;
        }

        tr:hover {
            background-color: #222;
        }

        /* æ–°ç€ãƒ­ã‚°ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ç”¨ */
        @keyframes flash {
            0% {
                background-color: #ffff00;
                color: #000;
            }

            100% {
                background-color: transparent;
                color: #1eff1a;
            }
        }

        .new-log {
            animation: flash 2s ease-out;
        }

        .search-box {
            background-color: #1a1a1a;
            padding: 15px;
            margin: 20px auto;
            width: 90%;
            border: 1px solid #333;
            border-radius: 8px;
            text-align: left;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
            justify-content: center;
        }

        input,
        select {
            padding: 6px;
            background: #333;
            color: #fff;
            border: 1px solid #555;
            border-radius: 4px;
        }

        .btn {
            padding: 8px 15px;
            font-weight: bold;
            cursor: pointer;
            border-radius: 5px;
            border: none;
        }

        .btn-search {
            background-color: #1eff1a;
            color: #000;
        }

        .btn-csv {
            background-color: #ffff00;
            color: #000;
            margin-left: auto;
        }

        .btn-reset {
            background-color: #555;
            color: #fff;
            text-decoration: none;
            padding: 6px 12px;
            font-size: 12px;
            display: inline-block;
            border-radius: 4px;
        }

        .btn-back {
            background-color: #333;
            color: #fff;
            text-decoration: none;
            display: inline-block;
            border: 1px solid #555;
            padding: 5px 10px;
        }

        .danger {
            color: #ff4444;
        }

        .login {
            color: #00ccff;
        }

        .num-col {
            text-align: center;
            color: #888;
            font-weight: bold;
        }

        /* æ›´æ–°ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ */
        #live-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            background-color: #555;
            border-radius: 50%;
            margin-left: 10px;
            transition: background-color 0.3s;
        }

        #live-indicator.active {
            background-color: #1eff1a;
            box-shadow: 0 0 5px #1eff1a;
        }
    </style>
</head>

<body>

    <h2>ã‚·ã‚¹ãƒ†ãƒ æ“ä½œãƒ­ã‚°ç›£æŸ» <span id="live-indicator" title="ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°å¾…æ©Ÿä¸­..."></span></h2>
    <div style="width: 90%; margin: 0 auto; text-align: left;">
        <a href="/" class="btn btn-back">â† æ¤œç´¢ç”»é¢ã«æˆ»ã‚‹</a>
    </div>

    <form method="get" class="search-box" id="searchForm">
        <div>
            <label>ãƒ¦ãƒ¼ã‚¶ãƒ¼ID:</label>
            <input type="text" name="filter_user" value="<?php echo h($_GET['filter_user'] ?? ''); ?>" size="10" placeholder="éƒ¨åˆ†ä¸€è‡´">
        </div>
        <div>
            <label>æ“ä½œ:</label>
            <select name="filter_action">
                <option value="">(ã™ã¹ã¦)</option>
                <option value="AUTH_SET" style="color: #00ccff; font-weight: bold;" <?php if (($_GET['filter_action'] ?? '') === 'AUTH_SET') echo 'selected'; ?>>
                    ã€ èªè¨¼ãƒ»ã‚»ãƒƒã‚·ãƒ§ãƒ³é–¢é€£ ã€‘
                </option>
                <option disabled>----------------</option>
                <?php foreach ($types as $t): ?>
                    <option value="<?php echo h($t); ?>" <?php if (($_GET['filter_action'] ?? '') === $t) echo 'selected'; ?>>
                        <?php echo h($t); ?>
                    </option>
                <?php endforeach; ?>
            </select>
        </div>
        <button type="submit" class="btn btn-search">æ¤œç´¢</button>
        <a href="/admin/logs" class="btn-reset">ãƒªã‚»ãƒƒãƒˆ</a>
        <button type="submit" name="download_csv" value="1" class="btn btn-csv">çµæœã‚’CSVä¿å­˜</button>
    </form>

    <div style="width: 95%; margin: 0 auto; text-align: left; margin-bottom: 5px;">
        è©²å½“ä»¶æ•°: <span style="font-weight: bold; font-size: 1.2em;" id="count-display"><?php echo count($logs); ?></span> ä»¶ (æœ€å¤§500ä»¶)
    </div>

    <table id="logTable">
        <thead>
            <tr>
                <th width="5%">No.</th>
                <th width="5%">DB-ID</th>
                <th width="15%">æ—¥æ™‚</th>
                <th width="10%">ãƒ¦ãƒ¼ã‚¶ãƒ¼</th>
                <th width="10%">æ“ä½œ</th>
                <th width="40%">è©³ç´°</th>
                <th width="15%">ç’°å¢ƒæƒ…å ±</th>
            </tr>
        </thead>
        <tbody id="logTableBody">
            <?php if (empty($logs)): ?>
                <tr id="no-logs-row">
                    <td colspan="7" style="text-align: center; padding: 20px; color: #888;">ãƒ­ã‚°ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</td>
                </tr>
            <?php else: ?>
                <?php $row_num = count($logs); ?>
                <?php foreach ($logs as $log): ?>
                    <tr>
                        <td class="num-col"><?php echo $row_num--; ?></td>
                        <td style="text-align:center; color:#666; font-size:0.9em;"><?php echo h($log['id']); ?></td>
                        <td><?php echo h($log['action_time']); ?></td>
                        <td><?php echo h($log['user_id']); ?></td>
                        <td style="font-weight: bold; text-align: center;">
                            <?php
                            $act = h($log['action_type']);
                            if (strpos($act, 'å‰Šé™¤') !== false || strpos($act, 'å¤±æ•—') !== false || strpos($act, 'ã‚¨ãƒ©ãƒ¼') !== false || strpos($act, 'æ‹’å¦') !== false) {
                                echo "<span class='danger'>$act</span>";
                            } elseif (strpos($act, 'ãƒ­ã‚°ã‚¤ãƒ³') !== false) {
                                echo "<span class='login'>$act</span>";
                            } else {
                                echo $act;
                            }
                            ?>
                        </td>
                        <td><?php echo h($log['details']); ?></td>
                        <td style="font-size: 12px; color: #888;">
                            <div>IP: <?php echo h($log['ip_address']); ?></div>
                        </td>
                    </tr>
                <?php endforeach; ?>
            <?php endif; ?>
        </tbody>
    </table>

    <script>
        // PHPã‹ã‚‰æ¸¡ã•ã‚ŒãŸæœ€æ–°ã®IDã‚’åˆæœŸå€¤ã¨ã—ã¦ã‚»ãƒƒãƒˆ
        let latestId = <?php echo (int)$latest_id; ?>;

        // 1.5ç§’ã”ã¨ã«æ–°ã—ã„ãƒ­ã‚°ã‚’å–ã‚Šã«è¡Œãã‚¿ã‚¤ãƒãƒ¼ã‚’é–‹å§‹
        setInterval(fetchNewLogs, 1500);

        function fetchNewLogs() {
            // æ¤œç´¢ãƒ•ã‚©ãƒ¼ãƒ ã«å…¥åŠ›ã•ã‚Œã¦ã„ã‚‹æ¡ä»¶ã‚’å–å¾—
            const formData = new FormData(document.getElementById('searchForm'));
            const params = new URLSearchParams(formData);

            // ã€Œä»Šã®æœ€æ–°IDã‚ˆã‚Šå¾Œã®ãƒ‡ãƒ¼ã‚¿ã€ã‚’ãã ã•ã„ã€ã¨ã„ã†ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’è¿½åŠ 
            params.append('last_id', latestId);

            // â˜…ä¿®æ­£ãƒã‚¤ãƒ³ãƒˆ: URLã‚’æ–°ã—ã„APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã«å¤‰æ›´
            fetch('/admin/api/logs?' + params.toString())
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    // ã‚¨ãƒ©ãƒ¼ãŒè¿”ã£ã¦ããŸå ´åˆã¯ãƒ­ã‚°ã«å‡ºã—ã¦çµ‚äº†
                    if (data.error) {
                        console.error('API Error:', data.error);
                        return;
                    }

                    // æ–°ã—ã„ãƒ­ã‚°ãŒã‚ã‚Œã°ç”»é¢ã«è¿½åŠ 
                    if (data.length > 0) {
                        updateTable(data);
                    }

                    // å‹•ä½œç¢ºèªç”¨ã®ã€Œç·‘ã®ç‚¹ã€ã‚’ãƒ”ã‚«ãƒƒã¨ã•ã›ã‚‹
                    flashIndicator();
                })
                .catch(error => console.error('Fetch error:', error));
        }

        // ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’æ›´æ–°ã™ã‚‹é–¢æ•°
        function updateTable(newLogs) {
            const tbody = document.getElementById('logTableBody');
            const noLogsRow = document.getElementById('no-logs-row');
            const countDisplay = document.getElementById('count-display');

            // ã€Œãƒ­ã‚°ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€ã®è¡¨ç¤ºãŒã‚ã‚Œã°æ¶ˆã™
            if (noLogsRow) {
                noLogsRow.remove();
            }

            // å—ã‘å–ã£ãŸãƒ­ã‚°é…åˆ—ï¼ˆé™é †ï¼‰ã‚’é€†è»¢ã•ã›ã¦ã€å¤ã„é †ã«ã™ã‚‹
            // ã“ã‚Œã«ã‚ˆã‚Šã€forEachã§é †ç•ªã«ã€Œå…ˆé ­ã¸æŒ¿å…¥ã€ã—ã¦ã„ãã¨ã€æœ€çµ‚çš„ã«æ­£ã—ã„é †åºï¼ˆæœ€æ–°ãŒä¸€ç•ªä¸Šï¼‰ã«ãªã‚‹
            newLogs.slice().reverse().forEach(log => {
                // æœ€æ–°IDã‚’æ›´æ–°ï¼ˆæ¬¡ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆç”¨ï¼‰
                if (parseInt(log.id) > latestId) {
                    latestId = parseInt(log.id);
                }

                // HTMLã®è¡Œã‚’ä½œæˆ
                const row = document.createElement('tr');
                row.className = 'new-log'; // CSSã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆé»„è‰²ãå…‰ã‚‹ï¼‰ã‚’é©ç”¨

                // æ“ä½œç¨®åˆ¥ã®è‰²åˆ†ã‘ï¼ˆPHPå´ã¨åŒã˜ãƒ­ã‚¸ãƒƒã‚¯ï¼‰
                let actionHtml = log.action_type;
                if (log.action_type.match(/å‰Šé™¤|å¤±æ•—|ã‚¨ãƒ©ãƒ¼|æ‹’å¦/)) {
                    actionHtml = `<span class='danger'>${log.action_type}</span>`;
                } else if (log.action_type.match(/ãƒ­ã‚°ã‚¤ãƒ³/)) {
                    actionHtml = `<span class='login'>${log.action_type}</span>`;
                }

                // â–¼â–¼â–¼ ä¿®æ­£ç®‡æ‰€: 1è¡Œç›®ã® td ã‚’ "NEW" ã«å¤‰æ›´ â–¼â–¼â–¼
                row.innerHTML = `
                    <td class="num-col" style="color: #ffff00; font-weight: bold; font-size: 0.8em;">NEW</td>
                    <td style="text-align:center; color:#666; font-size:0.9em;">${log.id}</td>
                    <td>${log.action_time}</td>
                    <td>${log.user_id}</td>
                    <td style="font-weight: bold; text-align: center;">${actionHtml}</td>
                    <td>${log.details}</td>
                    <td style="font-size: 12px; color: #888;">
                        <div>IP: ${log.ip_address}</div>
                    </td>
                `;
                // â–²â–²â–² ä¿®æ­£ã“ã“ã¾ã§ â–²â–²â–²

                // ãƒ†ãƒ¼ãƒ–ãƒ«ã®ä¸€ç•ªä¸Šã«è¿½åŠ 
                tbody.insertAdjacentElement('afterbegin', row);
            });

            // ä»¶æ•°è¡¨ç¤ºã‚’æ›´æ–°
            if (countDisplay) {
                countDisplay.textContent = tbody.rows.length;
            }
        }

        // é€šä¿¡ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
        function flashIndicator() {
            const indicator = document.getElementById('live-indicator');
            if (indicator) {
                indicator.classList.add('active');
                setTimeout(() => indicator.classList.remove('active'), 500);
            }
        }
    </script>
</body>

</html>
</file>

<file path="views/admin/reset_password.php">
<?php require __DIR__ . '/../layouts/header.php'; ?>

<div style="width: 500px; margin: 50px auto; background-color: #1a1a1a; padding: 30px; border: 1px solid #333; border-radius: 10px; text-align: left; color: #1eff1a; font-family: sans-serif;">
    <h2 style="color: #fff; margin-top: 0; text-align: center; border-bottom: 1px solid #444; padding-bottom: 10px;">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¼·åˆ¶ãƒªã‚»ãƒƒãƒˆ</h2>

    <?php if ($message): ?>
        <p style="color: <?php echo strpos($message, 'ã‚¨ãƒ©ãƒ¼') !== false ? '#ff4444' : '#1eff1a'; ?>; font-weight: bold; text-align: center;">
            <?php echo h($message); ?>
        </p>
    <?php endif; ?>

    <p style="font-size: 13px; color: #ccc;">
        æŒ‡å®šã—ãŸç®¡ç†è€…IDã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å¼·åˆ¶çš„ã«ä¸Šæ›¸ãã—ã¾ã™ã€‚<br>
        <span style="color: #ff4444;">â€»ç¾åœ¨ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’çŸ¥ã‚‰ãªãã¦ã‚‚å¤‰æ›´å¯èƒ½ã§ã™ã€‚</span>
    </p>

    <form method="post" onsubmit="return confirm('æœ¬å½“ã«ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å¤‰æ›´ã—ã¾ã™ã‹ï¼Ÿ\nã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚');">
        <input type="hidden" name="csrf_token" value="<?php echo h($_SESSION['csrf_token']); ?>">

        <div style="margin-bottom: 15px;">
            <label style="color: #fff;">å¯¾è±¡ã®ç®¡ç†è€…ID:</label>
            <input type="text" name="reset_target_id" value="<?php echo h($target_id); ?>" required placeholder="user_id" style="width: 100%; padding: 8px; margin-top: 5px; background: #333; color: #fff; border: 1px solid #555;">
        </div>

        <div style="margin-bottom: 15px;">
            <label style="color: #fff;">æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰:</label>
            <input type="password" name="reset_new_pass" required placeholder="New Password" style="width: 100%; padding: 8px; margin-top: 5px; background: #333; color: #fff; border: 1px solid #555;">
        </div>

        <input type="submit" value="å¤‰æ›´ã‚’å®Ÿè¡Œã™ã‚‹" style="width: 100%; background-color: #ffff00; color: #000; border: none; padding: 10px; cursor: pointer; font-weight: bold; margin-top: 20px; font-size: 16px; border-radius: 4px;">
    </form>

    <div style="text-align: center; margin-top: 20px;">
        <a href="/admin/users" style="color: #888; text-decoration: none;">ç®¡ç†è€…ä¸€è¦§ã«æˆ»ã‚‹</a>
    </div>
</div>
</file>

<file path="views/components/request_link.php">
<?php
$status = $_SESSION['request_status'] ?? null;
$hasDataPerm = hasPermission(PERM_DATA);
?>

<?php if (!$hasDataPerm): ?>
    <?php if ($status === 'pending'): ?>
        <span style="color: var(--cyber-yellow); opacity: 0.6; margin-right: 15px; font-family: monospace;">
            [ ç”³è«‹ä¸­... ]
        </span>
    <?php elseif ($status === 'rejected'): ?>
        <form action="/auth/request_permission" method="post" style="display: inline;" onsubmit="return confirm('å‰å›ã®ç”³è«‹ã¯æ‰¿èªã•ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚å†ç”³è«‹ã—ã¾ã™ã‹ï¼Ÿ');">
            <input type="hidden" name="csrf_token" value="<?php echo h($_SESSION['csrf_token']); ?>">
            <button type="submit" style="background: none; border: none; color: var(--cyber-red); cursor: pointer; text-decoration: underline; margin-right: 15px;">
                [ å†ç”³è«‹ã‚’è¡Œã† ]
            </button>
        </form>
    <?php else: ?>
        <form action="/auth/request_permission" method="post" style="display: inline;" onsubmit="return confirm('ãƒ‡ãƒ¼ã‚¿ç·¨é›†æ¨©é™ã‚’ç”³è«‹ã—ã¾ã™ã‹ï¼Ÿ');">
            <input type="hidden" name="csrf_token" value="<?php echo h($_SESSION['csrf_token']); ?>">
            <input type="hidden" name="request_reason" value="ã‚·ã‚¹ãƒ†ãƒ åˆ©ç”¨ã«ã‚ˆã‚‹æ¨©é™æ˜‡æ ¼ç”³è«‹">
            <button type="submit" style="background: none; border: none; color: var(--cyber-green); cursor: pointer; text-decoration: underline; margin-right: 15px;">
                [ æ¨©é™ç”³è«‹ ]
            </button>
        </form>
    <?php endif; ?>
<?php endif; ?>
</file>

<file path="views/koban/form.php">
<?php require __DIR__ . '/../layouts/header.php'; ?>

<div class="container">
    <div style="text-align: left; margin-bottom: 15px;">
        <a href="/" class="btn btn-secondary">â† ä¸€è¦§ã«æˆ»ã‚‹</a>
    </div>

    <?php if ($message): ?>
        <div style="color: #ff4444; margin-bottom: 15px; font-weight: bold; border: 1px solid red; padding: 10px;">
            <?php echo h($message); ?>
        </div>
    <?php endif; ?>

    <div class="box">
        <h2 style="margin-top:0; border-bottom: 1px solid #444; padding-bottom: 10px;">
            <?php echo h($page_title); ?>
        </h2>

        <form method="post" action="/koban/store" class="h-adr" style="display: flex; flex-direction: column; gap: 15px; text-align: left;">
            <input type="hidden" name="csrf_token" value="<?php echo h($_SESSION['csrf_token']); ?>">
            <input type="hidden" name="save_data" value="1">
            <span class="p-country-name" style="display:none;">Japan</span>

            <?php if (!empty($edit_data['id'])): ?>
                <input type="hidden" name="update_id" value="<?php echo h($edit_data['id']); ?>">
                <p style="color: #888; font-size: 12px;">ID: <?php echo h($edit_data['id']); ?> ã‚’ç·¨é›†ä¸­</p>
            <?php endif; ?>

            <div>
                <label>äº¤ç•ªå <span style="color: #ff4444;">*</span></label>
                <input type="text" name="new_name" placeholder="ä¾‹: æ˜æ²»å¤§å­¦å‰äº¤ç•ª" required
                    value="<?php echo h($edit_data['koban_fullname'] ?? ''); ?>" style="width: 100%;">
            </div>

            <div>
                <label>ç¨®åˆ¥</label><br>
                <?php $cur = $edit_data['type'] ?? 'äº¤ç•ª'; ?>
                <label><input type="radio" name="new_type" value="äº¤ç•ª" <?php if ($cur == 'äº¤ç•ª') echo 'checked'; ?>> äº¤ç•ª</label>
                <label style="margin-left: 15px;"><input type="radio" name="new_type" value="é§åœ¨æ‰€" <?php if ($cur == 'é§åœ¨æ‰€') echo 'checked'; ?>> é§åœ¨æ‰€</label>
            </div>

            <div>
                <label>é›»è©±ç•ªå·</label>
                <div style="display: flex; gap: 5px; align-items: center;">
                    <input type="text" name="phone_part1" value="<?php echo h($phone_parts[0] ?? ''); ?>" size="6"> -
                    <input type="text" name="phone_part2" value="<?php echo h($phone_parts[1] ?? ''); ?>" size="6"> -
                    <input type="text" name="phone_part3" value="<?php echo h($phone_parts[2] ?? ''); ?>" size="6">
                </div>
            </div>

            <div>
                <label>å…¨å›½åœ°æ–¹å…¬å…±å›£ä½“ã‚³ãƒ¼ãƒ‰</label>
                <input type="tel" name="new_group_code" value="<?php echo h($edit_data['group_code'] ?? ''); ?>" style="width: 100%;">
            </div>

            <div>
                <label>éƒµä¾¿ç•ªå· <span style="font-size:12px; color:#ffff00;">(è‡ªå‹•å…¥åŠ›å¯¾å¿œ)</span></label>
                <div style="display: flex; gap: 5px; align-items: center;">
                    ã€’ <input type="text" name="postal_part1" maxlength="3" value="<?php echo h($postal_parts[0] ?? ''); ?>" class="p-postal-code" size="5"> -
                    <input type="text" name="postal_part2" maxlength="4" value="<?php echo h($postal_parts[1] ?? ''); ?>" class="p-postal-code" size="6">
                </div>
            </div>

            <div>
                <label>éƒ½é“åºœçœŒ / å¸‚åŒºç”ºæ‘</label>
                <div style="display: flex; gap: 10px;">
                    <input type="text" name="new_pref" placeholder="éƒ½é“åºœçœŒ" value="<?php echo h($edit_data['pref'] ?? ''); ?>" class="p-region" style="width: 30%;">
                    <input type="text" name="new_addr3" placeholder="å¸‚åŒºç”ºæ‘ä»¥ä¸‹" value="<?php echo h($edit_data['addr3'] ?? ''); ?>" class="p-locality p-street-address p-extended-address" style="width: 70%;">
                </div>
            </div>

            <div style="text-align: center; margin-top: 20px;">
                <input type="submit" value="<?php echo !empty($edit_data) ? 'å¤‰æ›´ã‚’ä¿å­˜' : 'ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«è¿½åŠ '; ?>" class="btn-primary" style="padding: 10px 40px;">
            </div>
        </form>
    </div>

    <div class="box" style="margin-top: 30px;">
        <h3 style="margin-top: 0; color: #ccc;">CSVä¸€æ‹¬ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</h3>

        <form method="post" action="/koban/import" enctype="multipart/form-data" style="display: flex; gap: 10px; align-items: center;">

            <input type="hidden" name="csrf_token" value="<?php echo h($_SESSION['csrf_token']); ?>">

            <input type="file" name="csv_file" accept=".csv" required style="color: #fff;">
            <input type="submit" value="ã‚¤ãƒ³ãƒãƒ¼ãƒˆå®Ÿè¡Œ" class="btn-warning">
        </form>
        <p style="font-size: 11px; color: #888;">â€»åˆ—é †: id, åå‰, ç¨®åˆ¥, é›»è©±, ã‚³ãƒ¼ãƒ‰, ã€’, éƒ½é“åºœçœŒ, ä½æ‰€</p>
    </div>

</div>
<script src="https://yubinbango.github.io/yubinbango/yubinbango.js" charset="UTF-8"></script>
</body>

</html>
</file>

<file path="src/Utils/Cache.php">
<?php

namespace App\Utils;

class Cache
{
    private static $cacheDir = __DIR__ . '/../../storage/cache/';
    private static $defaultTtl = 600;

    /**
     * ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’å–å¾—
     * @param string $key æ¤œç´¢ã‚­ãƒ¼
     * @return mixed å†…å®¹ã®ã¿ã‚’è¿”ã™
     */
    public static function get($key)
    {
        $path = self::findPath($key);
        if (!$path || !file_exists($path)) return null;

        $data = unserialize(file_get_contents($path));

        // æœ‰åŠ¹æœŸé™ãƒã‚§ãƒƒã‚¯
        if (time() > $data['metadata']['expires']) {
            unlink($path);
            return null;
        }

        return $data['content'];
    }

    /**
     * ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ä¿å­˜ï¼ˆãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ä»˜ãï¼‰
     * @param string $key æ¤œç´¢ã‚­ãƒ¼
     * @param mixed $content ä¿å­˜å†…å®¹
     * @param string $tag è­˜åˆ¥ã‚¿ã‚°ï¼ˆä¾‹: 'koban_list'ï¼‰
     */
    public static function set($key, $content, $tag = 'default', $ttl = null)
    {
        if (!is_dir(self::$cacheDir)) mkdir(self::$cacheDir, 0755, true);

        $ttl = $ttl ?? self::$defaultTtl;
        $hash = md5($key);
        // [ã‚¿ã‚°]__[ãƒãƒƒã‚·ãƒ¥].cache ã¨ã„ã†å½¢å¼ã§ä¿å­˜
        $path = self::$cacheDir . "{$tag}__{$hash}.cache";
        $tmpPath = $path . '.' . uniqid(mt_rand(), true) . '.tmp';

        $data = [
            'metadata' => [
                'tag' => $tag,
                'expires' => time() + $ttl,
                'created_at' => date('Y-m-d H:i:s'),
                'php_version' => PHP_VERSION,
                'server' => gethostname() // Renderã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹è­˜åˆ¥ç”¨
            ],
            'content' => $content
        ];

        if (file_put_contents($tmpPath, serialize($data), LOCK_EX) !== false) {
            rename($tmpPath, $path);
        }
    }

    /**
     * ç‰¹å®šã®ã‚¿ã‚°ã‚’æŒã¤ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®ã¿ã‚’å‰Šé™¤ï¼ˆãƒ”ãƒ³ãƒã‚¤ãƒ³ãƒˆç„¡åŠ¹åŒ–ï¼‰
     */
    public static function clearByTag($tag)
    {
        $files = glob(self::$cacheDir . "{$tag}__*.cache");
        foreach ($files as $file) {
            if (is_file($file)) unlink($file);
        }
    }

    /**
     * ã‚­ãƒ¼ã‹ã‚‰æ—¢å­˜ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ã‚’æ¢ã™
     */
    private static function findPath($key)
    {
        $hash = md5($key);
        $files = glob(self::$cacheDir . "*__{$hash}.cache");
        return !empty($files) ? $files[0] : null;
    }
}
</file>

<file path="src/Utils/Validator.php">
<?php

namespace App\Utils;

class Validator
{
    /**
     * ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã®å¼·åº¦ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
     * @param string $password
     * @return array [bool $isValid, string $errorMessage]
     */
    private $errors = [];

    public function validateKoban($data)
    {
        // 1. å¿…é ˆãƒã‚§ãƒƒã‚¯
        if (empty($data['new_name'])) {
            $this->errors['new_name'] = 'äº¤ç•ªåã¯å¿…é ˆã§ã™ã€‚';
        }

        // 2. æ–‡å­—æ•°ãƒã‚§ãƒƒã‚¯ (ä¾‹: 100æ–‡å­—ä»¥å†…)
        if (mb_strlen($data['new_name']) > 100) {
            $this->errors['new_name'] = 'äº¤ç•ªåã¯100æ–‡å­—ä»¥å†…ã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚';
        }

        // 3. å½¢å¼ãƒã‚§ãƒƒã‚¯ (ä¾‹: ã‚°ãƒ«ãƒ¼ãƒ—ã‚³ãƒ¼ãƒ‰ã¯åŠè§’è‹±æ•°ã®ã¿)
        // preg_match ã¯æ­£è¦è¡¨ç¾ã§ãƒã‚§ãƒƒã‚¯ã—ã¾ã™
        if (!empty($data['new_group_code']) && !preg_match('/^[0-9]+$/', $data['new_group_code'])) {
            $this->errors['new_group_code'] = 'å›£ä½“ã‚³ãƒ¼ãƒ‰ã¯åŠè§’æ•°å­—ã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚';
        }

        $phone_raw = ($data['phone_part1'] ?? '') . ($data['phone_part2'] ?? '') . ($data['phone_part3'] ?? '');
        $postal_raw = ($data['postal_part1'] ?? '') . ($data['postal_part2'] ?? '');
        if (!empty($postal_raw) && !preg_match('/^[0-9]+$/', $postal_raw)) {
            $this->errors['postal'] = 'éƒµä¾¿ç•ªå·ã¯åŠè§’æ•°å­—ã®ã¿ã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚';
        }

        return empty($this->errors);
    }
    public static function validatePassword(string $password): array
    {
        // 1. æ–‡å­—æ•°ãƒã‚§ãƒƒã‚¯ (NISTæ¨å¥¨ã®æœ€å°8æ–‡å­—)
        if (mb_strlen($password) < 8) {
            return [false, "ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯8æ–‡å­—ä»¥ä¸Šã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚"];
        }

        // 2. è¤‡é›‘æ€§ãƒã‚§ãƒƒã‚¯ (æ­£è¦è¡¨ç¾)
        // è‹±å¤§æ–‡å­—ã€å°æ–‡å­—ã€æ•°å­—ãŒãã‚Œãã‚Œ1ã¤ä»¥ä¸Šå«ã¾ã‚Œã¦ã„ã‚‹ã‹
        $hasUpper = preg_match('/[A-Z]/', $password);
        $hasLower = preg_match('/[a-z]/', $password);
        $hasNumber = preg_match('/[0-9]/', $password);
        $hasSymbol = preg_match('/[!-@#%^&*(),.?":{}|<>]/', $password);

        if (!$hasUpper || !$hasLower || !$hasNumber) {
            return [false, "è‹±å¤§æ–‡å­—ã€å°æ–‡å­—ã€æ•°å­—ã‚’ã™ã¹ã¦çµ„ã¿åˆã‚ã›ã¦ãã ã•ã„ã€‚"];
        }

        return [true, ""];
    }

    /**
     * ãƒ­ã‚°ã‚¤ãƒ³IDã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
     */
    public static function validateLoginId(string $loginId): array
    {
        if (!preg_match('/^[a-zA-Z0-9_]{4,20}$/', $loginId)) {
            return [false, "IDã¯4ã€œ20æ–‡å­—ã®åŠè§’è‹±æ•°å­—ï¼ˆã‚¢ãƒ³ãƒ€ãƒ¼ã‚¹ã‚³ã‚¢å¯ï¼‰ã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚"];
        }
        return [true, ""];
    }

    public function getErrors()
    {
        return $this->errors;
    }
}
</file>

<file path="views/auth/login.php">
<?php require __DIR__ . '/../layouts/header.php'; ?>

<div class="container" style="max-width: 450px; margin-top: 60px;">
    <div class="box" style="border: 2px solid #1eff1a; padding: 30px; position: relative; overflow: hidden; box-shadow: 0 0 15px rgba(30, 255, 26, 0.3);">
        <div class="scan-line"></div>

        <h2 style="color: #1eff1a; text-shadow: 0 0 10px rgba(30, 255, 26, 0.5); text-align: center; margin-top: 0; letter-spacing: 2px; font-family: 'Courier New', Courier, monospace;">
            ã‚·ã‚¹ãƒ†ãƒ èªè¨¼
        </h2>

        <?php if ($message): ?>
            <div style="color: #ff4444; border: 1px solid #ff4444; padding: 10px; margin-bottom: 20px; font-size: 0.9em; background: rgba(255, 68, 68, 0.1); text-align: left;">
                [!] <?php echo h($message); ?>
            </div>
        <?php endif; ?>

        <form method="post" action="/auth/login" style="display: flex; flex-direction: column; gap: 20px; text-align: left;">
            <input type="hidden" name="csrf_token" value="<?php echo h($_SESSION['csrf_token']); ?>">

            <div>
                <label style="color: #1eff1a; display: block; margin-bottom: 8px; font-size: 0.9em;">ãƒ­ã‚°ã‚¤ãƒ³ID</label>
                <input type="text" name="login_id" required
                    style="width: 100%; padding: 12px; background: #000; border: 1px solid #333; color: #1eff1a; box-sizing: border-box; font-family: monospace;"
                    placeholder="IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„">
            </div>

            <div>
                <label style="color: #1eff1a; display: block; margin-bottom: 8px; font-size: 0.9em;">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
                <input type="password" name="login_pass" required
                    style="width: 100%; padding: 12px; background: #000; border: 1px solid #333; color: #1eff1a; box-sizing: border-box; font-family: monospace;"
                    placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„">
            </div>

            <input type="submit" value="[ ã‚·ã‚¹ãƒ†ãƒ ã«ãƒ­ã‚°ã‚¤ãƒ³ ]" class="btn-primary"
                style="width: 100%; padding: 15px; font-weight: bold; font-size: 1.1em; cursor: pointer; border: 1px solid #1eff1a; background: transparent; color: #1eff1a; transition: 0.3s;">
        </form>

        <div style="margin-top: 25px; text-align: center; border-top: 1px solid #333; padding-top: 15px;">
            <p style="color: #666; font-size: 0.8em; margin-bottom: 10px;">ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ãŠæŒã¡ã§ãªã„å ´åˆ</p>
            <a href="/register" style="color: #1eff1a; text-decoration: underline; font-size: 0.9em;">æ–°è¦ã‚¢ã‚«ã‚¦ãƒ³ãƒˆä½œæˆ</a>
        </div>
    </div>
</div>

<style>
    .scan-line {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 2px;
        background: rgba(30, 255, 26, 0.2);
        box-shadow: 0 0 15px #1eff1a;
        animation: scan 4s linear infinite;
        pointer-events: none;
    }

    @keyframes scan {
        0% {
            top: -5%;
        }

        100% {
            top: 105%;
        }
    }

    input[type=submit]:hover {
        background: #1eff1a !important;
        color: #000 !important;
        box-shadow: 0 0 20px #1eff1a;
    }

    input:focus {
        outline: none;
        border-color: #1eff1a !important;
        box-shadow: 0 0 5px #1eff1a;
    }
</style>

<?php require __DIR__ . '/../layouts/footer.php'; ?>
</file>

<file path="views/auth/register.php">
<?php require __DIR__ . '/../layouts/header.php'; ?>

<div class="container" style="max-width: 450px; margin-top: 60px;">
    <div class="box" style="border: 2px solid #1eff1a; padding: 30px; position: relative; overflow: hidden; box-shadow: 0 0 15px rgba(30, 255, 26, 0.3);">
        <div class="scan-line"></div>

        <h2 style="color: #1eff1a; text-shadow: 0 0 10px rgba(30, 255, 26, 0.5); text-align: center; margin-top: 0; letter-spacing: 2px; font-family: 'Courier New', Courier, monospace;">
            æ–°è¦ã‚¢ã‚«ã‚¦ãƒ³ãƒˆä½œæˆ
        </h2>

        <p style="color: #888; font-size: 0.8em; text-align: center; margin-bottom: 25px;">
            ã‚·ã‚¹ãƒ†ãƒ ã‚’åˆ©ç”¨ã™ã‚‹ãŸã‚ã®IDã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚
        </p>

        <form method="post" action="/register" style="display: flex; flex-direction: column; gap: 20px; text-align: left;">
            <input type="hidden" name="csrf_token" value="<?php echo h($_SESSION['csrf_token']); ?>">

            <div>
                <label style="color: #1eff1a; display: block; margin-bottom: 8px; font-size: 0.9em;">ãƒ­ã‚°ã‚¤ãƒ³ID</label>
                <input type="text" name="login_id" required
                    style="width: 100%; background: #000; border: 1px solid #333; color: #1eff1a; padding: 12px; font-family: monospace; box-sizing: border-box;"
                    placeholder="4-20æ–‡å­—ã®åŠè§’è‹±æ•°å­—">
            </div>

            <div>
                <label style="color: #1eff1a; display: block; margin-bottom: 8px; font-size: 0.9em;">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
                <input type="password" name="password" required
                    style="width: 100%; background: #000; border: 1px solid #333; color: #1eff1a; padding: 12px; font-family: monospace; box-sizing: border-box;"
                    placeholder="8æ–‡å­—ä»¥ä¸Š (è‹±å¤§ãƒ»å°ãƒ»æ•°ã‚’å«ã‚€)">
            </div>

            <div style="background: rgba(30, 255, 26, 0.05); border-left: 3px solid #ffff00; padding: 10px; margin: 10px 0 20px 0;">
                <p style="color: #ffff00; font-size: 0.75em; margin: 0; line-height: 1.4;">
                    â€»ç™»éŒ²ç›´å¾Œã®æ¨©é™ã¯ã€Œé–²è¦§ã®ã¿ã€ã«è¨­å®šã•ã‚Œã¾ã™ã€‚ãƒ‡ãƒ¼ã‚¿ã®ç·¨é›†ãŒå¿…è¦ãªå ´åˆã¯ã€ãƒ­ã‚°ã‚¤ãƒ³å¾Œã«ç®¡ç†è€…ã«ç”³è«‹ã—ã¦ãã ã•ã„ã€‚
                </p>
            </div>

            <input type="submit" value="[ ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ä½œæˆã™ã‚‹ ]" class="btn-primary"
                style="width: 100%; padding: 15px; font-weight: bold; font-size: 1.1em; cursor: pointer; border: 1px solid #1eff1a; background: transparent; color: #1eff1a; transition: 0.3s;">
        </form>

        <div style="margin-top: 25px; text-align: center; border-top: 1px solid #333; padding-top: 15px;">
            <a href="/auth/login" style="color: #888; text-decoration: none; font-size: 0.9em;">â† ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã¸æˆ»ã‚‹</a>
        </div>
    </div>
</div>

<style>
    .scan-line {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 2px;
        background: rgba(30, 255, 26, 0.2);
        box-shadow: 0 0 15px #1eff1a;
        animation: scan 4s linear infinite;
        pointer-events: none;
    }

    @keyframes scan {
        0% {
            top: -5%;
        }

        100% {
            top: 105%;
        }
    }

    input[type=submit]:hover {
        background: #1eff1a !important;
        color: #000 !important;
        box-shadow: 0 0 20px #1eff1a;
    }

    input:focus {
        outline: none;
        border-color: #1eff1a !important;
        box-shadow: 0 0 5px #1eff1a;
    }
</style>

<?php require __DIR__ . '/../layouts/footer.php'; ?>
</file>

<file path="views/components/alert.php">
<?php
$msgText = $message ?? '';
$isSuccess = preg_match('/(ä½œæˆ|æˆåŠŸ|å®Œäº†|å¤‰æ›´ã—ã¾ã—ãŸ|æ‰¿èª|ç”³è«‹)/u', $msgText);
$color = $isSuccess ? 'var(--cyber-green)' : 'var(--cyber-red)';
$label = $isSuccess ? '[ SUCCESS ]' : '[ ERROR ]';

if ($msgText === '') return;
?>
<div class="alert-container" style="border: 1px solid <?php echo $color; ?>; background: rgba(0,0,0,0.8); padding: 15px; margin: 10px auto; width: 80%; box-shadow: 0 0 10px <?php echo $color; ?>;">
    <span style="color: <?php echo $color; ?>; font-weight: bold; text-shadow: 0 0 5px <?php echo $color; ?>;">
        <?php echo $label; ?> <?php echo h($msgText); ?>
    </span>
</div>
</file>

<file path="public/css/style.css">
:root {
    /* ã‚«ãƒ©ãƒ¼ãƒ‘ãƒ¬ãƒƒãƒˆ */
    --cyber-green: #1eff1a;
    --cyber-green-dim: rgba(30, 255, 26, 0.2);
    --cyber-green-glow: rgba(30, 255, 26, 0.5);
    --cyber-bg: #010000;
    --cyber-box-bg: #1a1a1a;
    --cyber-red: #ff4444;
    --cyber-yellow: #ffff00;
    --cyber-blue: #00ccff;
    --cyber-gray: #333;
    --cyber-text-dim: #888;

    /* å…±é€šè¨­å®š */
    --cyber-border: 1px solid var(--cyber-gray);
    --cyber-shadow: 0px 0px 20px rgba(40, 40, 40, 0.4);
    --cyber-glow-shadow: 0 0 10px var(--cyber-green-glow);
    --transition-speed: 0.3s;
}

/* å¤‰æ•°ã‚’ä½¿ç”¨ã—ãŸæ—¢å­˜ã‚»ãƒ¬ã‚¯ã‚¿ã®æ›´æ–°ä¾‹ */
body {
    background-color: var(--cyber-bg);
    color: var(--cyber-green);
    transition: background-color var(--transition-speed);
}

.box {
    background-color: var(--cyber-box-bg);
    border: var(--cyber-border);
    box-shadow: var(--cyber-shadow);
}

.btn-primary {
    background-color: var(--cyber-green);
    color: #000;
    transition: box-shadow var(--transition-speed);
}

.btn-primary:hover {
    box-shadow: var(--cyber-glow-shadow);
}

body {
    background-color: #010000;
    color: #1eff1a;
    font-family: sans-serif;
    text-align: center;
    margin: 0;
    padding: 20px;
    display: flex;
    flex-direction: column;
    align-items: center;
}

/* ãƒ¡ãƒ‹ãƒ¥ãƒ¼å†…ã®ãƒªãƒ³ã‚¯å…±é€šã‚¹ã‚¿ã‚¤ãƒ« */
.text-right a,
.text-right button {
    font-family: 'Courier New', monospace;
    transition: opacity 0.2s;
}

.text-right a:hover,
.text-right button:hover {
    opacity: 0.7;
    text-shadow: 0 0 5px currentColor;
}

h1,
h2,
h3 {
    color: #fbfffc;
}

.container {
    width: 95%;
    max-width: 1400px;
    margin: 0 auto;
}

/* ãƒ•ã‚©ãƒ¼ãƒ ã‚„ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’å›²ã‚€ãƒœãƒƒã‚¯ã‚¹ */
.box {
    background-color: #1a1a1a;
    padding: 15px;
    margin-bottom: 20px;
    border-radius: 10px;
    border: 1px solid #333;
    box-shadow: 0px 0px 20px rgba(40, 40, 40, 0.4);
    text-align: left;
}

/* å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ ãƒ‡ã‚¶ã‚¤ãƒ³ */
input[type=text],
input[type=password],
input[type=tel],
input[type=date],
select {
    background: #333;
    color: #fff;
    border: 1px solid #555;
    padding: 6px;
    border-radius: 4px;
}

/* ãƒœã‚¿ãƒ³ãƒ‡ã‚¶ã‚¤ãƒ³ */
input[type=submit],
button,
.btn {
    cursor: pointer;
    font-weight: bold;
    border: none;
    padding: 8px 15px;
    border-radius: 4px;
    text-decoration: none;
    display: inline-block;
    font-size: 14px;
}

.btn-primary {
    background-color: #1eff1a;
    color: #000;
}

.btn-warning {
    background-color: #ffff00;
    color: #000;
}

.btn-danger {
    background-color: #ff4444;
    color: #fff;
}

.btn-secondary {
    background-color: #333;
    color: #fff;
    border: 1px solid #555;
}

.btn-back {
    background-color: #333;
    color: #fff;
    border: 1px solid #555;
    padding: 5px 10px;
}

a {
    color: #888;
    text-decoration: none;
}

a:hover {
    color: #fff;
}

/* ãƒ†ãƒ¼ãƒ–ãƒ«ãƒ‡ã‚¶ã‚¤ãƒ³ï¼ˆå…ƒãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‡ã‚¶ã‚¤ãƒ³ã‚’å¾©å…ƒï¼‰ */
table {
    width: 100%;
    border-collapse: collapse;
    border: 1px solid #b0ffd4;
    margin-top: 10px;
}

th {
    background-color: #1a1a1aff;
    color: #fff;
    padding: 8px;
    border: 1px solid #b0ffd4;
    text-align: center;
}

td {
    border: 1px solid #b0ffd4;
    /* å…ƒã®ãƒœãƒ¼ãƒ€ãƒ¼è‰² */
    padding: 8px;
    color: #1eff1a;
    background-color: #010000;
}

tr:hover td {
    background-color: #111;
}

/* ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ */
.pagination a {
    padding: 5px 12px;
    text-decoration: none;
    border-radius: 4px;
    margin: 2px;
}

.pagination .current {
    background: #1eff1a;
    color: #000;
    font-weight: bold;
}

.pagination .other {
    background: #333;
    color: #fff;
}

/* ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆèª¿æ•´ç”¨ */
.flex-row {
    display: flex;
    gap: 10px;
    align-items: center;
    flex-wrap: wrap;
}

.right-align {
    text-align: right;
}
</file>

<file path="views/admin/user_registration.php">
<?php require __DIR__ . '/../layouts/header.php'; ?>

<div class="container" style="max-width: 500px; margin-top: 40px;">

    <div style="margin-bottom: 20px;">
        <a href="/admin/users" style="color: #888; text-decoration: none; font-size: 0.9em;">â† ç®¡ç†è€…ä¸€è¦§ã¸æˆ»ã‚‹</a>
    </div>

    <div class="box" style="border: 2px solid #1eff1a; padding: 30px; background-color: #000; box-shadow: 0 0 20px rgba(30, 255, 26, 0.1);">
        <h2 style="color: #1eff1a; border-bottom: 1px solid #1eff1a; padding-bottom: 10px; text-align: center; margin-top: 0;">æ–°è¦ç®¡ç†è€…ã‚¢ã‚«ã‚¦ãƒ³ãƒˆç™ºè¡Œ</h2>

        <form method="post" action="/admin/users/register">
            <input type="hidden" name="csrf_token" value="<?php echo h($_SESSION['csrf_token']); ?>">

            <div style="margin-bottom: 20px;">
                <label style="color: #1eff1a; display: block; margin-bottom: 5px;">ãƒ­ã‚°ã‚¤ãƒ³ID</label>
                <input type="text" name="new_id" required
                    style="width: 100%; background: #000; border: 1px solid #333; color: #1eff1a; padding: 10px; font-family: monospace;"
                    placeholder="IDã‚’å…¥åŠ›...">
            </div>

            <div style="margin-bottom: 25px;">
                <label style="color: #1eff1a; display: block; margin-bottom: 5px;">åˆæœŸãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
                <input type="password" name="new_pass" required
                    style="width: 100%; background: #000; border: 1px solid #333; color: #1eff1a; padding: 10px; font-family: monospace;"
                    placeholder="PASSWORDã‚’å…¥åŠ›...">
            </div>

            <h3 style="color: #ffff00; font-size: 0.85em; margin-bottom: 10px;">åˆæœŸæ¨©é™ã®è¨­å®š</h3>
            <div style="display: grid; gap: 8px; margin-bottom: 30px;">
                <label class="cyber-checkbox-label">
                    <input type="checkbox" name="perm_data" value="1" checked>
                    <span class="cyber-panel">â— ãƒ‡ãƒ¼ã‚¿ç®¡ç†æ¨©é™</span>
                </label>
                <label class="cyber-checkbox-label">
                    <input type="checkbox" name="perm_admin" value="1">
                    <span class="cyber-panel">â— ç®¡ç†è€…ç®¡ç†æ¨©é™</span>
                </label>
                <label class="cyber-checkbox-label">
                    <input type="checkbox" name="perm_log" value="1">
                    <span class="cyber-panel">â— ãƒ­ã‚°é–²è¦§æ¨©é™</span>
                </label>
            </div>

            <div style="text-align: center;">
                <input type="submit" value="ã‚·ã‚¹ãƒ†ãƒ ã«ç™»éŒ²å®Ÿè¡Œ" class="btn-primary"
                    style="width: 100%; padding: 12px; font-weight: bold; font-size: 1.1em; cursor: pointer;">
            </div>
        </form>
    </div>
</div>
</file>

<file path="views/layouts/footer.php">
<div style="margin-top: 50px; padding-bottom: 20px; color: #444; font-size: 0.7em; font-family: monospace;">
    &copy; 2025 R6 Koban Database Management System / Enomi-4mg
</div>
</body>

</html>
</file>

<file path="Dockerfile">
# 1. ãƒ™ãƒ¼ã‚¹ã‚¤ãƒ¡ãƒ¼ã‚¸ã®æŒ‡å®š
FROM php:8.2-apache

# 2. å¿…è¦ãªãƒ©ã‚¤ãƒ–ãƒ©ãƒªã¨PostgreSQL/SQLiteæ‹¡å¼µã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
RUN apt-get update && apt-get install -y \
    unzip git libsqlite3-dev libpq-dev \
    && docker-php-ext-install pdo_sqlite pdo_pgsql

# 3. Apacheã®è¨­å®šå¤‰æ›´ (403å¯¾ç­–ã®è‚)
# Apacheã®DocumentRootã‚’ /var/www/html ã«è¨­å®šã—ã€.htaccessã‚’æœ‰åŠ¹åŒ–ã—ã¾ã™
RUN sed -i 's/AllowOverride None/AllowOverride All/g' /etc/apache2/apache2.conf

# 4. Renderã®å‹•çš„ãƒãƒ¼ãƒˆè¨­å®šã«å¯¾å¿œ
# RenderãŒå‰²ã‚Šå½“ã¦ã‚‹ $PORT ç’°å¢ƒå¤‰æ•°ã§ApacheãŒå¾…ã¡å—ã‘ã‚‹ã‚ˆã†ã«ã—ã¾ã™
RUN sed -i 's/80/${PORT}/g' /etc/apache2/sites-available/000-default.conf /etc/apache2/ports.conf

# 5. mod_rewrite (URLæ›¸ãæ›ãˆ) ã‚’æœ‰åŠ¹åŒ–
RUN a2enmod rewrite

# 6. Composer ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
COPY --from=composer:latest /usr/bin/composer /usr/bin/composer

# 7. ä½œæ¥­ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®è¨­å®šã¨ãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚³ãƒ”ãƒ¼
WORKDIR /var/www/html
COPY . .

# 8. æ¨©é™ã®è¨­å®š
# ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆã—ã€æ‰€æœ‰è€…ã‚’ www-data ã«å¤‰æ›´
RUN mkdir -p /var/www/html/storage/cache \
    && chown -R www-data:www-data /var/www/html/storage \
    && chmod -R 775 /var/www/html/storage

# 9. ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
RUN composer install --no-dev --optimize-autoloader

# 10. Apacheã®èµ·å‹•
CMD ["apache2-foreground"]
</file>

<file path="src/Models/AdminUser.php">
<?php

namespace App\Models;

use App\Utils\Database;
use PDO;

class AdminUser
{
    // IDã§ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’å–å¾—
    public function findById($login_id)
    {
        $db = Database::connect();
        $stmt = $db->prepare("SELECT * FROM admin_users WHERE login_id = ?");
        $stmt->execute([$login_id]);
        return $stmt->fetch(PDO::FETCH_ASSOC);
    }

    // ãƒ­ã‚°ã‚¤ãƒ³å¤±æ•—æ™‚ã«ã‚«ã‚¦ãƒ³ãƒˆã‚’1å¢—ã‚„ã™
    public function incrementFailureCount($login_id)
    {
        $db = Database::connect();
        $stmt = $db->prepare("UPDATE admin_users SET failure_count = failure_count + 1 WHERE login_id = ?");
        return $stmt->execute([$login_id]);
    }

    // ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ãƒ­ãƒƒã‚¯ã™ã‚‹
    public function lockAccount($login_id, $until_time)
    {
        $db = Database::connect();
        $stmt = $db->prepare("UPDATE admin_users SET locked_until = ? WHERE login_id = ?");
        return $stmt->execute([$until_time, $login_id]);
    }

    // ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸæ™‚ã«å¤±æ•—å›æ•°ã‚’ãƒªã‚»ãƒƒãƒˆ
    public function resetFailureCount($login_id)
    {
        $db = Database::connect();
        $stmt = $db->prepare("UPDATE admin_users SET failure_count = 0 WHERE login_id = ?");
        $stmt->execute([$login_id]);
    }

    // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´/ãƒªã‚»ãƒƒãƒˆæ™‚ã«ãƒ­ãƒƒã‚¯ã‚‚åŒæ™‚è§£é™¤ã™ã‚‹ã‚ˆã†ã«ã™ã‚‹
    public function updatePassword($login_id, $new_hash)
    {
        $db = Database::connect();
        // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰æ›´æ–°æ™‚ã«ã€å¤±æ•—å›æ•°ã¨ãƒ­ãƒƒã‚¯æœŸé™ã‚‚ã‚¯ãƒªã‚¢ã™ã‚‹
        $stmt = $db->prepare("UPDATE admin_users SET password_hash = ?, failure_count = 0, locked_until = NULL WHERE login_id = ?");
        return $stmt->execute([$new_hash, $login_id]);
    }

    // ç®¡ç†è€…ä½œæˆï¼ˆåˆæœŸè¨­å®šç”¨ï¼‰
    public function create($login_id, $password, $perms = [])
    {
        $db = Database::connect();
        $hash = password_hash($password, PASSWORD_DEFAULT);

        // æ¨©é™è¨­å®šã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ
        $p_data  = $perms['data'] ?? 1;
        $p_admin = $perms['admin'] ?? 1;
        $p_log   = $perms['log'] ?? 1;

        $sql = "INSERT INTO admin_users (login_id, password_hash, role, perm_data, perm_admin, perm_log) VALUES (?, ?, 1, ?, ?, ?)";
        $stmt = $db->prepare($sql);
        return $stmt->execute([$login_id, $hash, $p_data, $p_admin, $p_log]);
    }

    // â˜…è¿½åŠ : å…¨ç®¡ç†è€…ã‚’å–å¾—ï¼ˆä¸€è¦§ç”»é¢ç”¨ï¼‰
    public function findAll()
    {
        $db = Database::connect();
        // æœ€çµ‚æ“ä½œãƒ­ã‚°ã®æ—¥æ™‚ã‚‚ã‚µãƒ–ã‚¯ã‚¨ãƒªã§å–å¾—ï¼ˆå…ƒã®ãƒ­ã‚¸ãƒƒã‚¯ã‚’ç¶™æ‰¿ï¼‰
        $sql = "SELECT u.login_id, u.perm_data, u.perm_admin, u.perm_log,
                (SELECT action_time FROM audit_logs l WHERE l.user_id = u.login_id ORDER BY id DESC LIMIT 1) as last_act_time,
                (SELECT action_type FROM audit_logs l WHERE l.user_id = u.login_id ORDER BY id DESC LIMIT 1) as last_act_type
                FROM admin_users u ORDER BY u.login_id ASC";
        return $db->query($sql)->fetchAll(PDO::FETCH_ASSOC);
    }

    // ç®¡ç†è€…å‰Šé™¤
    public function delete($login_id)
    {
        $db = Database::connect();
        $stmt = $db->prepare("DELETE FROM admin_users WHERE login_id = ?");
        return $stmt->execute([$login_id]);
    }

    // IDé‡è¤‡ãƒã‚§ãƒƒã‚¯ç”¨
    public function exists($login_id)
    {
        $db = Database::connect();
        $stmt = $db->prepare("SELECT COUNT(*) FROM admin_users WHERE login_id = ?");
        $stmt->execute([$login_id]);
        return $stmt->fetchColumn() > 0;
    }

    /**
     * ç‰¹å®šã®ç®¡ç†è€…ã®æ¨©é™ãƒ•ãƒ©ã‚°ã®ã¿ã‚’æ›´æ–°ã™ã‚‹
     */
    public function updatePermissions($login_id, $perms)
    {
        $db = Database::connect();
        $sql = "UPDATE admin_users SET perm_data = ?, perm_admin = ?, perm_log = ? WHERE login_id = ?";
        $stmt = $db->prepare($sql);
        return $stmt->execute([
            $perms['data'],
            $perms['admin'],
            $perms['log'],
            $login_id
        ]);
    }

    /**
     * ç”³è«‹ä¸­(pending)ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°ã‚’å–å¾—ã™ã‚‹
     */
    public function countPendingRequests()
    {
        $db = Database::connect();
        $sql = "SELECT COUNT(*) FROM admin_users WHERE request_status = 'pending'";
        return (int)$db->query($sql)->fetchColumn();
    }

    /**
     * æ¨©é™ç”³è«‹ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã¨æ¨©é™ã‚’æ›´æ–°ã™ã‚‹
     */
    public function updateRequestStatus($login_id, $action)
    {
        $db = Database::connect();
        if ($action === 'approve') {
            // æ‰¿èªï¼šãƒ‡ãƒ¼ã‚¿æ¨©é™(perm_data)ã‚’1ã«ã—ã€ç”³è«‹ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ã‚¯ãƒªã‚¢
            $sql = "UPDATE admin_users SET perm_data = 1, request_status = NULL, request_message = NULL WHERE login_id = ?";
        } else {
            // å´ä¸‹ï¼šã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ rejected ã«å¤‰æ›´
            $sql = "UPDATE admin_users SET request_status = 'rejected' WHERE login_id = ?";
        }
        $stmt = $db->prepare($sql);
        return $stmt->execute([$login_id]);
    }
}
</file>

<file path="src/Utils/View.php">
<?php

namespace App\Utils;

class View
{
    public static function render($viewName, $data = [])
    {
        extract($data);
        $filePath = __DIR__ . '/../../views/' . $viewName . '.php';
        if (file_exists($filePath)) {
            require $filePath;
        } else {
            echo "View file not found: " . htmlspecialchars($viewName);
        }
    }

    public static function component($componentName, $props = [])
    {
        // æ¸¡ã•ã‚ŒãŸå¤‰æ•°ã‚’å±•é–‹ã€‚å­˜åœ¨ã—ãªã„å¤‰æ•°ã¯ null ã¨ã—ã¦æ‰±ã†
        extract($props, EXTR_SKIP);

        $filePath = __DIR__ . '/../../views/components/' . $componentName . '.php';

        if (file_exists($filePath)) {
            include $filePath;
        }
    }
}
</file>

<file path="src/Utils/Database.php">
<?php
namespace App\Utils;
use PDO;
use Exception;

class Database {
    // ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ä¿æŒç”¨ã®é™çš„å¤‰æ•°ï¼ˆã‚·ãƒ³ã‚°ãƒ«ãƒˆãƒ³ï¼‰
    private static $instance = null;

    public static function connect(): PDO {
        // ã™ã§ã«æ¥ç¶šæ¸ˆã¿ã®å ´åˆã¯ã€æ—¢å­˜ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’å³åº§ã«è¿”ã™
        if (self::$instance !== null) {
            return self::$instance;
        }

        // --- è¨ˆæ¸¬é–‹å§‹ ---
        $startTime = microtime(true);

        $dbUrl = $_ENV['DATABASE_URL'] ?? null;

        try {
            if ($dbUrl) {
                // PostgreSQLæ¥ç¶š (Renderæœ¬ç•ªç’°å¢ƒ)
                $dbopts = parse_url($dbUrl);
                $dsn = sprintf("pgsql:host=%s;port=%d;dbname=%s", 
                    $dbopts["host"], $dbopts["port"], ltrim($dbopts["path"], "/"));
                $user = $dbopts["user"];
                $pass = $dbopts["pass"];
                
                self::$instance = new PDO($dsn, $user, $pass, [
                    PDO::ATTR_ERRMODE => PDO::ERRMODE_EXCEPTION,
                    PDO::ATTR_DEFAULT_FETCH_MODE => PDO::FETCH_ASSOC,
                    // â–¼ é«˜é€ŸåŒ–ã®éµï¼šæ°¸ç¶šæ¥ç¶šã‚’æœ‰åŠ¹åŒ–
                    PDO::ATTR_PERSISTENT => true,
                    // ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆè¨­å®šï¼ˆå¿œç­”ãŒãªã„å ´åˆã«5ç§’ã§åˆ‡ã‚Šä¸Šã’ã‚‹ï¼‰
                    PDO::ATTR_TIMEOUT => 5,
                ]);
            } else {
                // SQLiteæ¥ç¶š (ãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™ºç’°å¢ƒ)
                $dbPath = __DIR__ . '/../../SQL/opendata.sqlite';
                self::$instance = new PDO("sqlite:" . $dbPath, null, null, [
                    PDO::ATTR_ERRMODE => PDO::ERRMODE_EXCEPTION
                ]);
            }

            // --- è¨ˆæ¸¬çµ‚äº†ã¨ãƒ­ã‚°å‡ºåŠ› ---
            $endTime = microtime(true);
            $duration = round(($endTime - $startTime) * 1000, 2); // ãƒŸãƒªç§’å˜ä½ã«å¤‰æ›
            
            // Renderã®ãƒ­ã‚°ã«è¡¨ç¤ºã•ã‚Œã‚‹ã‚ˆã†å‡ºåŠ›
            error_log("ã€PERFã€‘DB Connected in {$duration}ms (Host: " . ($dbopts['host'] ?? 'sqlite') . ")");

        } catch (Exception $e) {
            error_log("ã€ERRORã€‘DB Connection Failed: " . $e->getMessage());
            throw $e;
        }

        return self::$instance;
    }
}
?>
</file>

<file path="views/admin/edit_admin.php">
<?php require __DIR__ . '/../layouts/header.php'; ?>
<style>
    /* ã‚µã‚¤ãƒãƒ¼ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®ã‚¹ã‚¿ã‚¤ãƒ« */
    .cyber-checkbox-label {
        display: block;
        cursor: pointer;
    }

    .cyber-checkbox-label input {
        display: none;
    }

    /* ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚’éš ã™ */

    .cyber-panel {
        display: block;
        padding: 12px;
        border: 1px solid #333;
        background: #111;
        color: #555;
        /* ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯æš—ã„è‰² */
        transition: all 0.3s;
    }

    .cyber-panel .status-dot {
        margin-right: 10px;
    }

    /* ãƒã‚§ãƒƒã‚¯æ™‚ã®ã‚¹ã‚¿ã‚¤ãƒ« */
    .cyber-checkbox-label input:checked+.cyber-panel {
        border-color: #1eff1a;
        color: #1eff1a;
        background: rgba(30, 255, 26, 0.1);
        box-shadow: 0 0 10px rgba(30, 255, 26, 0.2) inset;
    }

    /* ãƒ›ãƒãƒ¼æ™‚ */
    .cyber-panel:hover {
        border-color: #666;
    }

    /* ç„¡åŠ¹æ™‚ï¼ˆç‰¹æ¨©ã‚¢ã‚«ã‚¦ãƒ³ãƒˆï¼‰ */
    .cyber-checkbox-label input:disabled+.cyber-panel {
        opacity: 0.5;
        cursor: not-allowed;
        border-style: dotted;
    }
</style>
<div class="container" style="max-width: 600px; margin-top: 20px;">

    <?php if (($admin['request_status'] ?? '') === 'pending'): ?>
        <div style="background: rgba(255, 255, 0, 0.1); border: 1px solid #ffff00; padding: 15px; margin-bottom: 20px;">
            <h3 style="color: #ffff00; margin-top: 0;">æ˜‡æ ¼ãƒªã‚¯ã‚¨ã‚¹ãƒˆå—ä¿¡</h3>
            <p style="color: #ccc; font-size: 0.9em;">ç†ç”±: <?php echo h($admin['request_message']); ?></p>
            <p style="color: #888; font-size: 0.8em;">ç”³è«‹æ—¥æ™‚: <?php echo h($admin['requested_at']); ?></p>

            <form method="post" action="/admin/users/handle_request" style="display: flex; gap: 10px;">
                <input type="hidden" name="csrf_token" value="<?php echo h($_SESSION['csrf_token']); ?>">
                <input type="hidden" name="target_admin_id" value="<?php echo h($admin['login_id']); ?>">

                <button type="submit" name="request_action" value="approve" class="btn-primary">æ‰¿èª (ãƒ‡ãƒ¼ã‚¿æ¨©é™ä»˜ä¸)</button>
                <button type="submit" name="request_action" value="reject" class="btn-danger">å´ä¸‹ã™ã‚‹</button>
            </form>
        </div>
    <?php endif; ?>

    <div style="margin-bottom: 15px;">
        <a href="/admin/users" style="color: #888; text-decoration: none;">â† ç®¡ç†è€…ä¸€è¦§ã«æˆ»ã‚‹</a>
    </div>

    <div class="box" style="border: 1px solid #1eff1a; padding: 20px;">
        <h2 style="color: #1eff1a; border-bottom: 1px solid #1eff1a; padding-bottom: 10px; margin-bottom: 20px;">
            è¨­å®šå¯¾è±¡: <?php echo h($admin['login_id']); ?>
        </h2>

        <form method="post" action="/admin/users/update_perms" style="margin-bottom: 30px;">
            <input type="hidden" name="csrf_token" value="<?php echo h($_SESSION['csrf_token']); ?>">
            <input type="hidden" name="target_admin_id" value="<?php echo h($admin['login_id']); ?>">

            <h3 style="color: #ffff00; font-size: 0.9em; margin-bottom: 15px;">â–  æ¨©é™å‰²ã‚Šå½“ã¦ (ã‚¯ãƒªãƒƒã‚¯ã§åˆ‡æ›¿)</h3>
            <div style="display: grid; gap: 10px; margin-bottom: 25px;">

                <label class="cyber-checkbox-label">
                    <input type="checkbox" name="perm_data" value="1" <?php echo $admin['perm_data'] ? 'checked' : ''; ?> <?php echo isProtectedAdmin($admin['login_id']) ? 'disabled' : ''; ?>>
                    <span class="cyber-panel">
                        <span class="status-dot">â—</span> ãƒ‡ãƒ¼ã‚¿ç®¡ç†æ¨©é™
                    </span>
                </label>

                <label class="cyber-checkbox-label">
                    <input type="checkbox" name="perm_admin" value="1" <?php echo $admin['perm_admin'] ? 'checked' : ''; ?> <?php echo isProtectedAdmin($admin['login_id']) ? 'disabled' : ''; ?>>
                    <span class="cyber-panel">
                        <span class="status-dot">â—</span> ç®¡ç†è€…ç®¡ç†æ¨©é™
                    </span>
                </label>

                <label class="cyber-checkbox-label">
                    <input type="checkbox" name="perm_log" value="1" <?php echo $admin['perm_log'] ? 'checked' : ''; ?> <?php echo isProtectedAdmin($admin['login_id']) ? 'disabled' : ''; ?>>
                    <span class="cyber-panel">
                        <span class="status-dot">â—</span> ãƒ­ã‚°é–²è¦§æ¨©é™
                    </span>
                </label>
            </div>

            <?php if (!isProtectedAdmin($admin['login_id'])): ?>
                <input type="submit" value="æ¨©é™ã‚’æ›´æ–°ã™ã‚‹" class="btn-primary">
            <?php endif; ?>
        </form>

        <?php if (isCurrentSuperAdmin()): ?>
            <div style="border-top: 1px dashed #444; padding-top: 20px;">
                <h3 style="color: #ff4444; font-size: 1em;">â–  ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã®å¼·åˆ¶å¤‰æ›´</h3>
                <form method="post" action="/admin/users/reset_pw" onsubmit="return confirm('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’ä¸Šæ›¸ãã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ');">
                    <input type="hidden" name="csrf_token" value="<?php echo h($_SESSION['csrf_token']); ?>">
                    <input type="hidden" name="target_admin_id" value="<?php echo h($admin['login_id']); ?>">

                    <input type="password" name="new_password" placeholder="æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›" required
                        style="background: #000; color: #ff4444; border: 1px solid #ff4444; padding: 8px; width: 100%; margin: 10px 0;">
                    <input type="submit" value="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’ãƒªã‚»ãƒƒãƒˆ" class="btn-danger" style="width: 100%;">
                </form>
            </div>

            <?php if (!isProtectedAdmin($admin['login_id']) && $admin['login_id'] !== $_SESSION['login_id']): ?>
                <div style="margin-top: 30px; text-align: right;">
                    <form method="post" action="/admin/users/delete" onsubmit="return confirm('ã“ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’å®Œå…¨ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ');">
                        <input type="hidden" name="csrf_token" value="<?php echo h($_SESSION['csrf_token']); ?>">
                        <input type="hidden" name="delete_admin_id" value="<?php echo h($admin['login_id']); ?>">
                        <input type="submit" value="ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’å‰Šé™¤" style="background:none; border:none; color:#666; cursor:pointer; font-size:0.8em; text-decoration:underline;">
                    </form>
                </div>
            <?php endif; ?>
        <?php endif; ?>
    </div>
</div>
</file>

<file path="views/layouts/header.php">
<?php require_once __DIR__ . '/../../vendor/autoload.php'; ?>
<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <title><?php echo h($page_title ?? 'äº¤ç•ªãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹'); ?></title>
    <link rel="stylesheet" href="../../public/css/style.css">
</head>

<body>
    <h1><?php echo h($page_title ?? 'R6 äº¤ç•ªãƒ»é§åœ¨æ‰€æ¤œç´¢ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹'); ?></h1>

    <?php if ($flash_msg = getFlashMessage()): ?>
        <?php \App\Utils\View::component('alert', ['message' => $flash_msg]); ?>
    <?php endif; ?>
</file>

<file path="src/Controllers/AuthController.php">
<?php

namespace App\Controllers;

use App\Models\AdminUser;
use App\Utils\View;

class AuthController
{
    // ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã®è¡¨ç¤ºï¼ˆã‚‚ã—å°‚ç”¨ç”»é¢ã‚’ä½œã‚‹ãªã‚‰ã“ã“ã€‚ä»Šå›ã¯ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸ã«ãƒ•ã‚©ãƒ¼ãƒ ãŒã‚ã‚‹ã®ã§ä½¿ã„ã¾ã›ã‚“ï¼‰

    public function login()
    {
        verifyCsrfToken();
        $login_id = $_POST['login_id'] ?? '';
        $password = $_POST['login_pass'] ?? '';
        $adminModel = new AdminUser();

        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«è¿”ã™å…±é€šã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
        $common_error = "IDã¾ãŸã¯ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ã€‚";

        try {
            $user = $adminModel->findById($login_id);

            // IDãŒå­˜åœ¨ã—ãªã„å ´åˆã§ã‚‚ã€ã‚ã–ã¨ã€Œãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰æ¤œè¨¼ã€ã«ç›¸å½“ã™ã‚‹æ™‚é–“å¾…æ©Ÿã•ã›ã‚‹ã‹ã€
            // ã™ãã«è¿”ã•ãšä¸€å¾‹ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ã‚»ãƒƒãƒˆã™ã‚‹
            if (!$user) {
                $_SESSION['message'] = $common_error;
                logAction($login_id ?: 'unknown', 'ãƒ­ã‚°ã‚¤ãƒ³å¤±æ•—', "å­˜åœ¨ã—ãªã„IDã§ã®è©¦è¡Œ");
                header("Location: /");
                exit;
            }

            // 1. ãƒ­ãƒƒã‚¯ç¢ºèªï¼ˆãƒ­ãƒƒã‚¯ã•ã‚Œã¦ã„ã¦ã‚‚ã€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯å¤‰ãˆãªã„ï¼‰
            if ($user['locked_until'] && strtotime($user['locked_until']) > time()) {
                $_SESSION['message'] = $common_error; // ã€Œãƒ­ãƒƒã‚¯ä¸­ã€ã¨ã¯æ•™ãˆãªã„
                logAction($login_id, 'ãƒ­ã‚°ã‚¤ãƒ³æ‹’å¦', "ãƒ­ãƒƒã‚¯ä¸­ã®IDã¸ã®ã‚¢ã‚¯ã‚»ã‚¹");
                header("Location: /");
                exit;
            }

            // 2. ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰æ¤œè¨¼
            if (password_verify($password, $user['password_hash'])) {
                // æˆåŠŸæ™‚ã®å‡¦ç†ï¼ˆæ—¢å­˜é€šã‚Šï¼‰
                session_regenerate_id(true);
                $_SESSION['logged_in'] = true;
                $_SESSION['login_id'] = $user['login_id'];
                $_SESSION['request_status'] = $user['request_status'] ?? null;
                $_SESSION['permissions'] = [
                    'data'  => $user['perm_data'],
                    'admin' => $user['perm_admin'],
                    'log'   => $user['perm_log'] ?? 0
                ]; // DBã«ä¿å­˜ã•ã‚Œã¦ã„ã‚‹ç”³è«‹ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ã‚»ãƒƒã‚·ãƒ§ãƒ³ã«åŒæœŸ
                $_SESSION['request_status'] = $user['request_status'];
                $adminModel->resetFailureCount($login_id);
                logAction($login_id, 'ãƒ­ã‚°ã‚¤ãƒ³', 'æˆåŠŸ');
                header("Location: /");
                exit;
            }

            // 3. å¤±æ•—æ™‚ï¼šå›æ•°ã‚«ã‚¦ãƒ³ãƒˆã‚„ãƒ­ãƒƒã‚¯å‡¦ç†ã¯è£ã§è¡Œã†
            $adminModel->incrementFailureCount($login_id);
            $updatedUser = $adminModel->findById($login_id);
            $fail_count = $updatedUser ? (int)$updatedUser['failure_count'] : 0;

            if ($fail_count >= 10) {
                $lock_time = date('Y-m-d H:i:s', strtotime('+30 minutes'));
                $adminModel->lockAccount($login_id, $lock_time);
                logAction($login_id, 'ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãƒ­ãƒƒã‚¯', "è‡ªå‹•ãƒ­ãƒƒã‚¯å®Ÿè¡Œ");
            }

            $_SESSION['message'] = $common_error; // å¤±æ•—å›æ•°ã‚‚æ•™ãˆãªã„
            logAction($login_id, 'ãƒ­ã‚°ã‚¤ãƒ³å¤±æ•—', "ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ä¸ä¸€è‡´ï¼ˆç´¯è¨ˆ: {$fail_count}å›ï¼‰");
        } catch (\Exception $e) {
            error_log($e->getMessage());
            $_SESSION['message'] = "ã‚·ã‚¹ãƒ†ãƒ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚";
            logAction($login_id, 'ãƒ­ã‚°ã‚¤ãƒ³ã‚¨ãƒ©ãƒ¼', "ãƒ­ã‚°ã‚¤ãƒ³ã«ã¦ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ");
        }

        header("Location: /auth/login");
        exit;
    }

    // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆå‡¦ç†
    public function logout()
    {
        $user_id = $_SESSION['login_id'] ?? 'guest';
        logAction($user_id, 'ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ', 'æˆåŠŸ');

        // ã‚»ãƒƒã‚·ãƒ§ãƒ³ç ´æ£„
        $_SESSION = [];
        if (ini_get("session.use_cookies")) {
            $params = session_get_cookie_params();
            setcookie(
                session_name(),
                '',
                time() - 42000,
                $params["path"],
                $params["domain"],
                $params["secure"],
                $params["httponly"]
            );
        }
        session_destroy();

        header("Location: /");
        exit;
    }

    /**
     * æ–°è¦ç™»éŒ²ç”»é¢ã®è¡¨ç¤º
     */
    public function showRegisterForm()
    {
        // ãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿ã®å ´åˆã¯ãƒˆãƒƒãƒ—ã¸
        if (isset($_SESSION['logged_in'])) {
            header("Location: /");
            exit;
        }

        return \App\Utils\View::render('auth/register', [
            'page_title' => 'SIGN UP - æ–°è¦ã‚¢ã‚«ã‚¦ãƒ³ãƒˆä½œæˆ',
            'message' => getFlashMessage()
        ]);
    }

    /**
     * ç™»éŒ²å‡¦ç†ã®å®Ÿè¡Œ
     */
    public function register()
    {
        verifyCsrfToken();

        $login_id = $_POST['login_id'] ?? '';
        $password = $_POST['password'] ?? '';

        // 1. ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ (Validatorã‚¯ãƒ©ã‚¹ã®å†åˆ©ç”¨)
        list($idValid, $idMsg) = \App\Utils\Validator::validateLoginId($login_id);
        if (!$idValid) {
            $_SESSION['message'] = $idMsg;
            header("Location: /register");
            exit;
        }

        list($pwValid, $pwMsg) = \App\Utils\Validator::validatePassword($password);
        if (!$pwValid) {
            $_SESSION['message'] = $pwMsg;
            header("Location: /register");
            exit;
        }

        $adminModel = new AdminUser();

        // 2. IDé‡è¤‡ãƒã‚§ãƒƒã‚¯
        if ($adminModel->exists($login_id)) {
            $_SESSION['message'] = "ã“ã®IDã¯æ—¢ã«ä½¿ç”¨ã•ã‚Œã¦ã„ã¾ã™ã€‚";
            header("Location: /register");
            exit;
        }

        // 3. ä¿å­˜ (ä¸€èˆ¬ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯å…¨æ¨©é™ 0 ã§ç™»éŒ²)
        $perms = [
            'data'  => 0,
            'admin' => 0,
            'log'   => 0
        ];

        if ($adminModel->create($login_id, $password, $perms)) {
            logAction($login_id, 'è‡ªå·±ç™»éŒ²', "æ–°è¦ã‚¢ã‚«ã‚¦ãƒ³ãƒˆä½œæˆï¼ˆä¸€èˆ¬ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼‰");
            $_SESSION['message'] = "ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ä½œæˆã—ã¾ã—ãŸã€‚ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚";
            header("Location: /"); // ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸ã®ãƒ­ã‚°ã‚¤ãƒ³ãƒ•ã‚©ãƒ¼ãƒ ã¸
        } else {
            $_SESSION['message'] = "ç™»éŒ²ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚";
            header("Location: /register");
        }
        exit;
    }

    /**
     * ãƒ­ã‚°ã‚¤ãƒ³å°‚ç”¨ç”»é¢ã®è¡¨ç¤º
     */
    public function showLoginForm()
    {
        if (isset($_SESSION['logged_in'])) {
            header("Location: /");
            exit;
        }

        return \App\Utils\View::render('auth/login', [
            'page_title' => 'ACCESS GRANTED - ãƒ­ã‚°ã‚¤ãƒ³',
            'message' => getFlashMessage() // functions.php ã®é–¢æ•°
        ]);
    }

    /**
     * æ¨©é™æ˜‡æ ¼ã®ç”³è«‹ã‚’å®Ÿè¡Œ
     */
    public function submitRequest()
    {
        verifyCsrfToken();
        if (!isset($_SESSION['logged_in'])) header("Location: /");

        $userId = $_SESSION['login_id'];
        $message = $_POST['request_reason'] ?? '';

        $db = \App\Utils\Database::connect();
        $stmt = $db->prepare("UPDATE admin_users SET request_status = 'pending', request_message = ?, requested_at = ? WHERE login_id = ?");
        $stmt->execute([$message, date('Y-m-d H:i:s'), $userId]);

        $_SESSION['request_status'] = 'pending';

        logAction($userId, 'æ¨©é™ç”³è«‹', "ç†ç”±: $message");
        $_SESSION['message'] = "æ¨©é™æ˜‡æ ¼ã‚’ç”³è«‹ã—ã¾ã—ãŸã€‚ç®¡ç†è€…ã®æ‰¿èªã‚’ãŠå¾…ã¡ãã ã•ã„ã€‚";
        header("Location: /");
        exit;
    }
}
</file>

<file path="src/Models/Koban.php">
<?php

namespace App\Models;

use App\Utils\Database;
use App\Utils\Cache;
use PDO;

class Koban
{
    // æ¤œç´¢ãƒ»ä¸€è¦§å–å¾—ãƒ¡ã‚½ãƒƒãƒ‰
    public function search($params, $limit, $offset, $sort)
    {
        $cacheKey = "koban_search_" . json_encode($params) . "_{$limit}_{$offset}_{$sort}";

        // 'koban_list' ã¨ã„ã†ã‚¿ã‚°ã‚’ä»˜ã‘ã¦ä¿å­˜
        $cached = Cache::get($cacheKey);
        if ($cached !== null) return $cached;

        $db = Database::connect();

        // æ¤œç´¢æ¡ä»¶ã®æ§‹ç¯‰ (functions.phpã®é–¢æ•°ã‚’åˆ©ç”¨)
        $searchData = buildSearchQuery($params);
        $sql = "SELECT * FROM koban " . $searchData['sql'];

        // ã‚½ãƒ¼ãƒˆé †ã®æ±ºå®š
        $sort_sql = match ($sort) {
            'id_desc' => "ORDER BY id DESC",
            'name_asc' => "ORDER BY koban_fullname ASC",
            default => "ORDER BY id ASC"
        };
        $sql .= " $sort_sql LIMIT $limit OFFSET $offset";

        $stmt = $db->prepare($sql);
        $stmt->execute($searchData['params']);
        $result = $stmt->fetchAll(PDO::FETCH_ASSOC);

        // çµæœã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«ä¿å­˜
        Cache::set($cacheKey, $result, 'koban_list');
        return $result;
    }

    // ç·ä»¶æ•°ã‚’å–å¾—ã™ã‚‹ãƒ¡ã‚½ãƒƒãƒ‰ï¼ˆãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ç”¨ï¼‰
    public function count($params)
    {
        $cacheKey = "koban_count_" . json_encode($params);
        $cached = Cache::get($cacheKey);
        if ($cached !== null) return $cached;

        $db = Database::connect();
        $searchData = buildSearchQuery($params);

        $stmt = $db->prepare("SELECT COUNT(*) FROM koban " . $searchData['sql']);
        $stmt->execute($searchData['params']);

        // ã€ä¿®æ­£ã€‘executeã®çµæœã§ã¯ãªãã€fetchColumn()ã§å®Ÿéš›ã®æ•°å€¤ã‚’å–å¾—ã™ã‚‹
        $result = (int)$stmt->fetchColumn();

        Cache::set($cacheKey, $result);
        return $result;
    }

    // å‰Šé™¤ãƒ¡ã‚½ãƒƒãƒ‰
    public function delete($id)
    {
        Cache::clearByTag('koban_list');
        $db = Database::connect();
        $stmt = $db->prepare("DELETE FROM koban WHERE id = ?");
        return $stmt->execute([$id]);
    }

    // â˜…è¿½åŠ : IDã§1ä»¶ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ï¼ˆç·¨é›†ç”»é¢ç”¨
    public function findById($id)
    {
        $db = Database::connect();
        $stmt = $db->prepare("SELECT * FROM koban WHERE id = ?");
        $stmt->execute([$id]);
        return $stmt->fetch(PDO::FETCH_ASSOC);
    }

    // â˜…è¿½åŠ : æ–°è¦ç™»éŒ²
    public function create($data)
    {
        Cache::clearByTag('koban_list');
        $db = Database::connect();
        $sql = "INSERT INTO koban (koban_fullname, type, phone_number, group_code, postal_code, pref, addr3) VALUES (?, ?, ?, ?, ?, ?, ?)";
        $stmt = $db->prepare($sql);
        return $stmt->execute([
            $data['koban_fullname'],
            $data['type'],
            $data['phone_number'],
            $data['group_code'],
            $data['postal_code'],
            $data['pref'],
            $data['addr3']
        ]);
    }

    // â˜…è¿½åŠ : æ›´æ–°
    public function update($id, $data)
    {
        Cache::clearByTag('koban_list');
        $db = Database::connect();
        $sql = "UPDATE koban SET koban_fullname=?, type=?, phone_number=?, group_code=?, postal_code=?, pref=?, addr3=? WHERE id=?";
        $stmt = $db->prepare($sql);
        return $stmt->execute([
            $data['koban_fullname'],
            $data['type'],
            $data['phone_number'],
            $data['group_code'],
            $data['postal_code'],
            $data['pref'],
            $data['addr3'],
            $id
        ]);
    }

    // â˜…è¿½åŠ : CSVä¸€æ‹¬ç™»éŒ²ï¼ˆãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³å¯¾å¿œï¼‰
    public function bulkInsert($rows)
    {
        $db = Database::connect();
        try {
            $db->beginTransaction();
            // â˜…ä¿®æ­£å‰ (SQLiteå°‚ç”¨)
            // $stmt = $db->prepare("INSERT OR REPLACE INTO koban (id, koban_fullname, type, phone_number, group_code, postal_code, pref, addr3) VALUES (?,?,?,?,?,?,?,?)");

            // â˜…ä¿®æ­£å¾Œ (PostgreSQL / SQLite ä¸¡å¯¾å¿œã®æ›¸ãæ–¹)
            // idãŒé‡è¤‡ã—ãŸéš›ã«æ›´æ–°ï¼ˆUPSERTï¼‰ã™ã‚‹æ§‹æ–‡ã«å¤‰æ›´ã—ã¾ã™
            $sql = "INSERT INTO koban (id, pref, type, koban_fullname, phone_number, postal_code, group_code, addr3) 
                VALUES (?,?,?,?,?,?,?,?) 
                ON CONFLICT (id) DO UPDATE SET 
                pref=EXCLUDED.pref, type=EXCLUDED.type, koban_fullname=EXCLUDED.koban_fullname, 
                phone_number=EXCLUDED.phone_number, postal_code=EXCLUDED.postal_code, 
                group_code=EXCLUDED.group_code, addr3=EXCLUDED.addr3";

            $stmt = $db->prepare($sql);
            foreach ($rows as $row) {
                $params = array_pad($row, 8, ''); // 8åˆ—åˆ†ã‚’ç¢ºä¿

                // 1. IDãŒæ•°å€¤ã§ãªã„ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œãªã©ã¯ã‚¹ã‚­ãƒƒãƒ—
                if (!is_numeric($params[0])) continue;

                // 2. ç”»åƒã®é †åºã«åŸºã¥ãã€æ•°å€¤å‹ã‚«ãƒ©ãƒ  group_code (ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹6) ã‚’ã‚¯ãƒ¬ãƒ³ã‚¸ãƒ³ã‚°
                if (!isset($params[6]) || !preg_match('/^[0-9]+$/', (string)$params[6])) {
                    $params[6] = null; // æ•°å€¤ä»¥å¤–ï¼ˆã€Œç„¡ã—ã€ã‚„ç©ºæ–‡å­—ï¼‰ãªã‚‰NULL
                }

                // 3. æ–‡å­—åˆ—ã‚«ãƒ©ãƒ ã®ã€Œç„¡ã—ã€ã‚’NULLã«å¤‰æ›ï¼ˆphone_number:4, postal_code:5ï¼‰
                foreach ([4, 5] as $idx) {
                    if ($params[$idx] === 'ç„¡ã—' || $params[$idx] === '' || $params[$idx] === '-') {
                        $params[$idx] = null;
                    }
                }

                $stmt->execute($params);
            }

            Cache::clearByTag('koban_list');
            $db->commit();
            return true;
        } catch (\Exception $e) {
            $db->rollBack();
            error_log("CSV Import Error: " . $e->getMessage());
            throw $e;
        }
    }

    // â˜…è¿½åŠ : CSVå‡ºåŠ›ç”¨ã«å…¨ä»¶ã‚’1è¡Œãšã¤è¿”ã™ (ã‚¸ã‚§ãƒãƒ¬ãƒ¼ã‚¿)
    public function exportAll($params, $sort)
    {
        $db = Database::connect();

        // functions.php ã® buildSearchQuery ã‚’åˆ©ç”¨
        $searchData = buildSearchQuery($params);
        $sql = "SELECT * FROM koban " . $searchData['sql'];

        // ã‚½ãƒ¼ãƒˆé †
        $sort_sql = match ($sort) {
            'id_desc' => "ORDER BY id DESC",
            'name_asc' => "ORDER BY koban_fullname ASC",
            default => "ORDER BY id ASC"
        };
        $sql .= " $sort_sql"; // LIMITã¨OFFSETã¯ä»˜ã‘ãªã„ï¼

        // ãƒ—ãƒªãƒšã‚¢ãƒ‰ã‚¹ãƒ†ãƒ¼ãƒˆãƒ¡ãƒ³ãƒˆå®Ÿè¡Œ
        // (ãƒãƒƒãƒ•ã‚¡ãªã—ã‚¯ã‚¨ãƒªã®è¨­å®šãªã©ã¯SQLiteã®å ´åˆã‚ã¾ã‚Šæ°—ã«ã—ãªãã¦OKã§ã™ãŒã€MySQLç­‰ã®å ´åˆã¯ã“ã“ã§è¨­å®šã—ã¾ã™)
        $stmt = $db->prepare($sql);
        $stmt->execute($searchData['params']);

        // â˜…ã“ã“ãŒãƒã‚¤ãƒ³ãƒˆ: fetchAllã›ãšã€1è¡Œãšã¤ yield ã§è¿”ã™
        while ($row = $stmt->fetch(PDO::FETCH_ASSOC)) {
            yield $row;
        }
    }
}
</file>

<file path="src/Controllers/KobanController.php">
<?php

namespace App\Controllers;

// å¿…è¦ãªã‚¯ãƒ©ã‚¹ï¼ˆéƒ¨å“ï¼‰ã‚’èª­ã¿è¾¼ã‚€å®£è¨€
use App\Models\Koban;       // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ“ä½œæ‹…å½“
use App\Utils\View;         // ç”»é¢è¡¨ç¤ºæ‹…å½“ (ã•ã£ãä½œã£ãŸã‚„ã¤)
use App\Utils\Validator;    // å…¥åŠ›ãƒã‚§ãƒƒã‚¯æ‹…å½“
use App\Models\AdminUser;

class KobanController
{

    /**
     * ä¸€è¦§ç”»é¢ã‚’è¡¨ç¤ºã™ã‚‹ (æ—§ opendata.php ã®å½¹å‰²)
     */
    public function index()
    {
        // 1. ãƒ¢ãƒ‡ãƒ«ã®å‘¼ã³å‡ºã—
        // ã€Œäº¤ç•ªãƒ‡ãƒ¼ã‚¿ã€ã‚’æ‰±ã†ãŸã‚ã®ã‚¯ãƒ©ã‚¹ã‚’ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹åŒ–ï¼ˆå®Ÿä½“åŒ–ï¼‰ã—ã¾ã™
        $kobanModel = new Koban();
        $adminModel = new AdminUser();

        $log_detail = "ãƒˆãƒƒãƒ—è¡¨ç¤º";

        // â–¼â–¼â–¼ ãƒ­ã‚°ç”¨è©³ç´°æƒ…å ±ã®æ§‹ç¯‰ â–¼â–¼â–¼
        $conditions = [];
        if (!empty($_GET['keyword'])) {
            $conditions[] = "KW: " . $_GET['keyword'];
        }
        if (!empty($_GET['search_type'])) {
            $conditions[] = "ç¨®åˆ¥: " . $_GET['search_type'];
        }
        if (!empty($_GET['search_pref'])) {
            $conditions[] = "çœŒ: " . $_GET['search_pref'];
        }
        if (!empty($_GET['sort'])) {
            // ã‚½ãƒ¼ãƒˆé †ã‚‚è¨˜éŒ²ã—ã¦ãŠãã¨åˆ†æã«å½¹ç«‹ã¡ã¾ã™
            $conditions[] = "é †: " . $_GET['sort'];
        }
        // ç®¡ç†è€…æ¨©é™ãŒã‚ã‚‹å ´åˆã®ã¿ã€æœªæ‰¿èªä»¶æ•°ã‚’å–å¾—
        $pendingCount = 0;
        if (hasPermission(PERM_ADMIN)) {
            $pendingCount = $adminModel->countPendingRequests();
        }

        // æ¡ä»¶ãŒãªã‘ã‚Œã°ã€Œãƒˆãƒƒãƒ—è¡¨ç¤ºã€ã€ã‚ã‚Œã°é€£çµã—ã¦è¨˜éŒ²
        $log_detail = empty($conditions) ? "ãƒˆãƒƒãƒ—è¡¨ç¤º" : "æ¤œç´¢å®Ÿè¡Œ [" . implode(", ", $conditions) . "]";

        // ãƒ­ã‚°ä¿å­˜
        logAction($_SESSION['login_id'] ?? 'guest', 'ã‚¢ã‚¯ã‚»ã‚¹', $log_detail);
        // â–²â–²â–² æ§‹ç¯‰çµ‚äº† â–²â–²â–²

        // 2. ãƒ‡ãƒ¼ã‚¿ã®å–å¾—
        // $_GET ã«ã¯URLã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒå…¥ã£ã¦ã„ã¾ã™ (ä¾‹: ?keyword=æ–°å®¿&page=2)
        // ãƒ¢ãƒ‡ãƒ«ã® search ãƒ¡ã‚½ãƒƒãƒ‰ã«ã€Œæ¤œç´¢æ¡ä»¶ã€ã‚’æ¸¡ã—ã¦ã€çµæœã‚’ã‚‚ã‚‰ã„ã¾ã™
        $limit = 100;
        $page = max(1, (int)($_GET['page'] ?? 1));
        $offset = ($page - 1) * $limit;

        $data = $kobanModel->search($_GET, $limit, $offset, $_GET['sort'] ?? 'id_asc');
        $total_count = $kobanModel->count($_GET);
        $total_pages = ceil($total_count / $limit);

        // 3. ãƒ“ãƒ¥ãƒ¼ã®è¡¨ç¤º
        // 'home' ã¯ views/home.php ã‚’æŒ‡ã—ã¾ã™
        // ç¬¬2å¼•æ•°ã®é…åˆ—ãŒã€home.php å†…ã§å¤‰æ•°ã¨ã—ã¦ä½¿ãˆã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™
        return View::render('home', [
            'all_data'    => $data,
            'total_count' => $total_count,
            'page'        => $page,
            'total_pages' => $total_pages,
            'pendingCount' => $pendingCount, // ãƒ“ãƒ¥ãƒ¼ã«æ¸¡ã™
            'pref_list'   => ["åŒ—æµ·é“", "é’æ£®çœŒ", "å²©æ‰‹çœŒ", "å®®åŸçœŒ", "ç§‹ç”°çœŒ", "å±±å½¢çœŒ", "ç¦å³¶çœŒ", "èŒ¨åŸçœŒ", "æ ƒæœ¨çœŒ", "ç¾¤é¦¬çœŒ", "åŸ¼ç‰çœŒ", "åƒè‘‰çœŒ", "æ±äº¬éƒ½", "ç¥å¥ˆå·çœŒ", "æ–°æ½ŸçœŒ", "å¯Œå±±çœŒ", "çŸ³å·çœŒ", "ç¦äº•çœŒ", "å±±æ¢¨çœŒ", "é•·é‡çœŒ", "å²é˜œçœŒ", "é™å²¡çœŒ", "æ„›çŸ¥çœŒ", "ä¸‰é‡çœŒ", "æ»‹è³€çœŒ", "äº¬éƒ½åºœ", "å¤§é˜ªåºœ", "å…µåº«çœŒ", "å¥ˆè‰¯çœŒ", "å’Œæ­Œå±±çœŒ", "é³¥å–çœŒ", "å³¶æ ¹çœŒ", "å²¡å±±çœŒ", "åºƒå³¶çœŒ", "å±±å£çœŒ", "å¾³å³¶çœŒ", "é¦™å·çœŒ", "æ„›åª›çœŒ", "é«˜çŸ¥çœŒ", "ç¦å²¡çœŒ", "ä½è³€çœŒ", "é•·å´çœŒ", "ç†Šæœ¬çœŒ", "å¤§åˆ†çœŒ", "å®®å´çœŒ", "é¹¿å…å³¶çœŒ", "æ²–ç¸„çœŒ"]
        ]);
    }

    /**
     * æ–°è¦ä½œæˆãƒ•ã‚©ãƒ¼ãƒ ã‚’è¡¨ç¤ºã™ã‚‹ (æ—§ koban_form.php ã®åˆæœŸè¡¨ç¤º)
     */
    public function create()
    {
        // æ¨©é™ãƒã‚§ãƒƒã‚¯ (functions.phpã®é–¢æ•°)
        if (!hasPermission(PERM_DATA)) {
            die('æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“');
        }

        $message = $_SESSION['message'] ?? '';
        unset($_SESSION['message']);

        $phone_parts = ['', '', ''];
        $postal_parts = ['', ''];

        // ãƒ•ã‚©ãƒ¼ãƒ ã‚’è¡¨ç¤ºã€‚æ–°è¦ãªã®ã§ãƒ‡ãƒ¼ã‚¿ã¯ç©ºã£ã½ã§ã™ã€‚
        return View::render('koban/form', [
            'page_title' => 'æ–°è¦ãƒ‡ãƒ¼ã‚¿ç™»éŒ²',
            'edit_data'  => [],
            'message'    => $message,
            'phone_parts' => $phone_parts,   // ãƒ“ãƒ¥ãƒ¼ã¸æ¸¡ã™
            'postal_parts' => $postal_parts, // ãƒ“ãƒ¥ãƒ¼ã¸æ¸¡ã™
        ]);
    }

    /**
     * ç·¨é›†ãƒ•ã‚©ãƒ¼ãƒ ã‚’è¡¨ç¤ºã™ã‚‹
     */
    public function edit()
    {
        // 1. æ¨©é™ãƒã‚§ãƒƒã‚¯ã¨IDå–å¾— (å¤‰æ›´ãªã—)
        if (!hasPermission(PERM_DATA)) {
            die('æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“');
        }

        $id = $_GET['id'] ?? null;
        if (!$id) {
            die('IDãŒæŒ‡å®šã•ã‚Œã¦ã„ã¾ã›ã‚“');
        }

        $kobanModel = new Koban();
        $data = $kobanModel->findById($id);

        if (!$data) {
            die('ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
        }

        // ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‹ã‚‰ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å–å¾—ã—ã¦æ¶ˆå»ï¼ˆã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚¨ãƒ©ãƒ¼ç­‰ã®è¡¨ç¤ºç”¨ï¼‰
        $message = $_SESSION['message'] ?? '';
        unset($_SESSION['message']);


        // â–¼â–¼â–¼ ä¿®æ­£: ã€Œç„¡ã—ã€ãƒ‡ãƒ¼ã‚¿ã‚’ç©ºæ¬„ã«å¤‰æ›ã™ã‚‹ãƒ­ã‚¸ãƒƒã‚¯ã‚’è¿½åŠ  â–¼â–¼â–¼
        $keys_to_clean = ['phone_number', 'postal_code', 'group_code'];
        foreach ($keys_to_clean as $key) {
            if (isset($data[$key]) && $data[$key] === 'ç„¡ã—') {
                $data[$key] = '';
            }
        }
        // â–²â–²â–² å¤‰æ›ãƒ­ã‚¸ãƒƒã‚¯ã“ã“ã¾ã§ â–²â–²â–²

        // 2. ãƒ•ã‚©ãƒ¼ãƒ åˆæœŸå€¤ã®è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯
        // phone_number ã¨ postal_code ãŒç©ºæ–‡å­—åˆ—ã«ãªã£ãŸãŸã‚ã€ä»¥ä¸‹ã®ãƒ­ã‚¸ãƒƒã‚¯ãŒæ­£ã—ãå‹•ä½œã—ã¾ã™

        // é›»è©±ç•ªå·ã®åˆ†å‰²
        $phone_parts = explode('-', $data['phone_number'] ?? '') + ['', '', ''];

        // éƒµä¾¿ç•ªå·ã®åˆ†å‰²
        $p = $data['postal_code'] ?? '';
        $postal_parts = (strpos($p, '-') !== false) ? explode('-', $p) : [substr($p, 0, 3), substr($p, 3)];

        // 3. View ã«ãƒ‡ãƒ¼ã‚¿ã‚’æ¸¡ã—ã¦è¡¨ç¤º (å¤‰æ›´ãªã—)
        return View::render('koban/form', [
            'page_title' => 'ãƒ‡ãƒ¼ã‚¿ç·¨é›† (ID: ' . $data['id'] . ')',
            'edit_data'  => $data, // å¤‰æ›æ¸ˆã¿ã®$dataã‚’æ¸¡ã™
            'message'    => $message,
            'phone_parts' => $phone_parts,
            'postal_parts' => $postal_parts,
        ]);
    }

    /**
     * ãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜å‡¦ç†ã‚’è¡Œã† (æ–°è¦ãƒ»æ›´æ–° å…±é€š)
     */
    public function store()
    {
        // CSRFãƒˆãƒ¼ã‚¯ãƒ³ãƒã‚§ãƒƒã‚¯ (ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¯¾ç­–)
        verifyCsrfToken();

        if (!hasPermission(PERM_DATA)) {
            die('æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“');
        }

        // 1. å…¥åŠ›å€¤ã®ãƒã‚§ãƒƒã‚¯ (Validatorã‚¯ãƒ©ã‚¹ã‚’åˆ©ç”¨)
        $validator = new Validator();

        // ãƒ‡ãƒ¼ã‚¿ã®æ•´å½¢ï¼ˆãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³å‰ã«ä¸€éƒ¨å®Ÿè¡Œï¼‰
        $raw_phone_parts = [$_POST['phone_part1'] ?? '', $_POST['phone_part2'] ?? '', $_POST['phone_part3'] ?? ''];
        $raw_postal = ($_POST['postal_part1'] ?? '') . ($_POST['postal_part2'] ?? '');

        if (!$validator->validateKoban($_POST)) {
            // ã‚¨ãƒ©ãƒ¼ãŒã‚ã£ãŸå ´åˆã€ãƒ•ã‚©ãƒ¼ãƒ ç”»é¢ã«æˆ»ã™
            $errors = $validator->getErrors();

            // â˜…ä¿®æ­£: ã‚¨ãƒ©ãƒ¼æ™‚ã‚‚é›»è©±ç•ªå·ãƒ»éƒµä¾¿ç•ªå·ã®ãƒ‘ãƒ¼ãƒ„ã‚’æ¸¡ã™ã“ã¨ã§å…¥åŠ›å€¤ã‚’ä¿æŒã™ã‚‹
            return View::render('koban/form', [
                'page_title' => 'å…¥åŠ›ã‚¨ãƒ©ãƒ¼',
                'edit_data'  => $_POST,
                'message'    => implode('<br>', $errors),
                // é›»è©±ç•ªå·ãƒ‘ãƒ¼ãƒ„ã¯ãƒ•ã‚©ãƒ¼ãƒ ã‹ã‚‰ã®å…¥åŠ›ã‚’ãã®ã¾ã¾è¿”ã™
                'phone_parts' => $raw_phone_parts,
                // éƒµä¾¿ç•ªå·ãƒ‘ãƒ¼ãƒ„ã¯ãƒ•ã‚©ãƒ¼ãƒ ã‹ã‚‰ã®å…¥åŠ›ã‚’ãã®ã¾ã¾è¿”ã™
                'postal_parts' => [$_POST['postal_part1'] ?? '', $_POST['postal_part2'] ?? '']
            ]);
        }

        // 2. ãƒ‡ãƒ¼ã‚¿ã®æ•´å½¢
        $kobanModel = new Koban();

        $group_code = $_POST['new_group_code'] ?? '';
        // ã€ä¿®æ­£ã€‘æ•°å€¤å‹ã‚«ãƒ©ãƒ ã«ã¯ 'ç„¡ã—' ã§ã¯ãªã null ã‚’å…¥ã‚Œã‚‹
        $group_code = (empty($group_code) || $group_code === 'ç„¡ã—') ? null : $group_code;

        // é›»è©±ç•ªå·ã‚„éƒµä¾¿ç•ªå·ãŒæ–‡å­—åˆ—å‹(VARCHAR/TEXT)ãªã‚‰ 'ç„¡ã—' ã§ã‚‚é€šã‚Šã¾ã™ãŒã€
        // å¿µã®ãŸã‚çµ±ä¸€ã—ã¦ null ã¾ãŸã¯ç©ºæ–‡å­—ã‚’æ¤œè¨ã—ã¦ãã ã•ã„
        $phone = implode('-', array_filter($raw_phone_parts, fn($v) => $v !== ''));
        $phone = empty($phone) ? null : $phone; // nullã‚’æ¨å¥¨

        $postal = empty($raw_postal) ? null : $raw_postal; // nullã‚’æ¨å¥¨


        // â–¼â–¼â–¼ ä½æ‰€çµåˆå‡¦ç†ï¼ˆå…ƒã®koban_form.phpã«ã‚ã£ãŸãƒ­ã‚¸ãƒƒã‚¯ã‚’ç§»æ¤ï¼‰ â–¼â–¼â–¼
        // å…¨è§’æ•°å­—ã®åŠè§’åŒ–ã€ä¸ç›®/ç•ªåœ°ãªã©ã‚’ãƒã‚¤ãƒ•ãƒ³ã«ç½®æ›
        $addr3 = str_replace(['ä¸ç›®', 'ç•ªåœ°', 'ç•ª', 'å·'], '-', mb_convert_kana($_POST['new_addr3'] ?? '', 'n', 'UTF-8'));
        // é€£ç¶šã™ã‚‹ãƒã‚¤ãƒ•ãƒ³ã‚’ä¸€ã¤ã«ã¾ã¨ã‚ã€æœ«å°¾ã®ãƒã‚¤ãƒ•ãƒ³ã‚’å‰Šé™¤
        $addr3 = rtrim(preg_replace('/-+/', '-', $addr3), '-');


        // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ä¿å­˜ç”¨ãƒ‡ãƒ¼ã‚¿
        $saveData = [
            'koban_fullname' => $_POST['new_name'],
            'type'           => $_POST['new_type'],
            'phone_number'   => $phone,         // â˜…ã€Œç„¡ã—ã€åˆ¤å®šå¾Œã®å€¤
            'group_code'     => $group_code,
            'postal_code'    => $postal,        // â˜…ã€Œç„¡ã—ã€åˆ¤å®šå¾Œã®å€¤
            'pref'           => $_POST['new_pref'],
            'addr3'          => $addr3          // â˜…æ•´å½¢å¾Œã®å€¤
        ];

        // 3. DBã¸ã®ä¿å­˜
        if (!empty($_POST['update_id'])) {
            // IDãŒã‚ã‚‹ãªã‚‰æ›´æ–°
            $kobanModel->update($_POST['update_id'], $saveData);
            $_SESSION['message'] = "ID: {$_POST['update_id']} ã‚’æ›´æ–°ã—ã¾ã—ãŸã€‚";
            logAction($_SESSION['login_id'], 'ãƒ‡ãƒ¼ã‚¿æ›´æ–°', "ID: {$_POST['update_id']} ã‚’æ›´æ–°");
        } else {
            // IDãŒãªã„ãªã‚‰æ–°è¦ä½œæˆ
            $kobanModel->create($saveData);
            $_SESSION['message'] = "æ–°è¦ãƒ‡ãƒ¼ã‚¿ã‚’ç™»éŒ²ã—ã¾ã—ãŸï¼";
            logAction($_SESSION['login_id'], 'ãƒ‡ãƒ¼ã‚¿ç™»éŒ²', "æ–°è¦: {$_POST['new_name']} ã‚’è¿½åŠ ");
        }

        // 4. ä¸€è¦§ç”»é¢ã¸ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ (index.phpã¸æˆ»ã‚‹)
        header("Location: /");
        exit;
    }

    /**
     * å‰Šé™¤å‡¦ç†
     */
    public function delete()
    {
        verifyCsrfToken();
        if (!hasPermission(PERM_DATA)) {
            die('æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“');
        }

        $id = $_POST['delete_id'] ?? null;
        if ($id) {
            $kobanModel = new Koban();
            $kobanModel->delete($id);
            $_SESSION['message'] = "ID: {$id} ã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚";
            logAction($_SESSION['login_id'], 'ãƒ‡ãƒ¼ã‚¿å‰Šé™¤', "ID: {$id} ã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚");
        }

        header("Location: /");
        exit;
    }

    /**
     * CSVä¸€æ‹¬ã‚¤ãƒ³ãƒãƒ¼ãƒˆå‡¦ç†
     */
    public function importCsv()
    {
        verifyCsrfToken();
        // æ¨©é™ãƒã‚§ãƒƒã‚¯ï¼š'data' ã§ã¯ãªã 'admin'ï¼ˆç®¡ç†è€…ç®¡ç†ãƒ­ãƒ¼ãƒ«ï¼‰ã«å¤‰æ›´
        if (!isset($_SESSION['logged_in']) || !hasPermission(PERM_ADMIN)) {
            $_SESSION['message'] = "ã‚¨ãƒ©ãƒ¼ï¼šCSVã‚¤ãƒ³ãƒãƒ¼ãƒˆã«ã¯ç®¡ç†è€…ç®¡ç†æ¨©é™ãŒå¿…è¦ã§ã™ã€‚";
            logAction($_SESSION['login_id'] ?? 'guest', 'æ¨©é™æ‹’å¦', 'CSVã‚¤ãƒ³ãƒãƒ¼ãƒˆè©¦è¡Œï¼ˆæ¨©é™ä¸è¶³ï¼‰');
            header("Location: /koban/create");
            exit;
        }

        $kobanModel = new Koban();

        // å‡¦ç†ã®æœ¬ä½“ (æ—§koban_form.phpã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆéƒ¨åˆ†)
        if (isset($_FILES['csv_file']) && $_FILES['csv_file']['error'] == 0) {
            try {
                $handle = fopen($_FILES['csv_file']['tmp_name'], "r");
                if ($handle) {
                    $head = fgets($handle);
                    // æ–‡å­—ã‚³ãƒ¼ãƒ‰å¤‰æ›
                    if (mb_detect_encoding($head, ['UTF-8', 'SJIS-win'], true) !== 'UTF-8') {
                        rewind($handle);
                        stream_filter_append($handle, 'convert.iconv.cp932/utf-8');
                    } else {
                        rewind($handle);
                    }

                    fgetcsv($handle); // ãƒ˜ãƒƒãƒ€ã‚¹ã‚­ãƒƒãƒ—
                    $rows = [];
                    while (($d = fgetcsv($handle, 1000, ",")) !== FALSE) {
                        if (!isset($d[0]) || !is_numeric($d[0])) continue;
                        $rows[] = $d;
                    }
                    fclose($handle);

                    // Modelã§ä¸€æ‹¬ç™»éŒ²
                    $kobanModel->bulkInsert($rows);

                    $count = count($rows);
                    $_SESSION['message'] = "ã‚¤ãƒ³ãƒãƒ¼ãƒˆå®Œäº†ï¼š{$count}ä»¶ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‡¦ç†ã—ã¾ã—ãŸã€‚";
                    logAction($_SESSION['login_id'], 'CSVã‚¤ãƒ³ãƒãƒ¼ãƒˆ', "ãƒ•ã‚¡ã‚¤ãƒ«å: {$_FILES['csv_file']['name']} / å‡¦ç†ä»¶æ•°: {$count}ä»¶");
                }
            } catch (\Exception $e) {
                $_SESSION['message'] = "ã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚¨ãƒ©ãƒ¼: " . $e->getMessage();
                logAction($_SESSION['login_id'], 'CSVã‚¤ãƒ³ãƒãƒ¼ãƒˆå¤±æ•—', $e->getMessage());
            }
        } else {
            $_SESSION['message'] = "ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚";
        }

        // å‡¦ç†å®Œäº†å¾Œã€ãƒ•ã‚©ãƒ¼ãƒ ç”»é¢ã«æˆ»ã‚‹
        header("Location: /koban/create");
        exit;
    }


    /**
     * äº¤ç•ªãƒ‡ãƒ¼ã‚¿ã‚’ç§»è¡Œç”¨ã‚«ã‚¹ã‚¿ãƒ CSVã¨ã—ã¦ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã™ã‚‹
     */
    public function export()
    {
        // ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆå¯¾ç­–
        set_time_limit(0);
        if (ob_get_level()) ob_end_clean();

        try {
            $kobanModel = new \App\Models\Koban();

            // ãƒ­ã‚°è¨˜éŒ²
            logAction($_SESSION['login_id'] ?? 'guest', 'CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ', 'ç§»è¡Œç”¨ã‚«ã‚¹ã‚¿ãƒ å½¢å¼ã§å‡ºåŠ›');

            // å…¨ä»¶å–å¾— (ã‚¸ã‚§ãƒãƒ¬ãƒ¼ã‚¿ã‚’ä½¿ç”¨)
            $rows = $kobanModel->exportAll($_GET, $_GET['sort'] ?? 'id_asc');

            $filename = "koban_migration_" . date('Ymd_His') . ".csv";

            header('Content-Type: text/csv');
            header('Content-Disposition: attachment; filename="' . $filename . '"');

            $output = fopen('php://output', 'w');
            fwrite($output, "\xEF\xBB\xBF"); // Excelå¯¾å¿œç”¨BOM

            // æŒ‡å®šã•ã‚ŒãŸé †åºã¨ã‚«ãƒ©ãƒ åã§ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’å‡ºåŠ› (ä½¿ç”¨ã—ã¦ã„ãªã„ã‚«ãƒ©ãƒ ã¯é™¤å¤–)
            fputcsv($output, [
                'id',
                'pref',
                'type',
                'koban_fullname',
                'phone_number',
                'postal_code',
                'group_code',
                'addr3'
            ]);

            foreach ($rows as $row) {
                // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ã‚«ãƒ©ãƒ åã¨CSVã®ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’æ­£ç¢ºã«ãƒãƒƒãƒ”ãƒ³ã‚°
                fputcsv($output, [
                    $row['id'],
                    $row['pref'],
                    $row['type'],
                    $row['koban_fullname'],
                    $row['phone_number'],
                    $row['postal_code'],
                    $row['group_code'],
                    $row['addr3']
                ]);
            }

            fclose($output);
            exit;
        } catch (\Exception $e) {
            error_log($e->getMessage());
            header("Location: /");
            exit;
        }
    }
}
</file>

<file path="public/index.php">
<?php
// 1. ã‚ªãƒ¼ãƒˆãƒ­ãƒ¼ãƒ‰ã®èª­ã¿è¾¼ã¿
require_once __DIR__ . '/../vendor/autoload.php';

use App\Controllers\KobanController;
use App\Controllers\AuthController;
use App\Controllers\AdminController;

// 2. ç’°å¢ƒå¤‰æ•°ã®èª­ã¿è¾¼ã¿ (.env)
try {
    // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ«ãƒ¼ãƒˆ(ä¸€ã¤ä¸Šã®éšå±¤)ã® .env ã‚’æ¢ã™
    $dotenv = \Dotenv\Dotenv::createImmutable(__DIR__ . '/..');
    $dotenv->load();
} catch (\Exception $e) {
    // .envãŒãªãã¦ã‚‚å‹•ä½œã‚’æ­¢ã‚ãªã„ï¼ˆæœ¬ç•ªç’°å¢ƒã®ç’°å¢ƒå¤‰æ•°ã‚’ä½¿ã†å ´åˆãªã©ï¼‰
}

// 3. ã‚»ãƒƒã‚·ãƒ§ãƒ³é–‹å§‹ (å…¨ãƒšãƒ¼ã‚¸å…±é€š)
if (session_status() === PHP_SESSION_NONE) {
    session_start();
}

if (empty($_SESSION['csrf_token'])) {
    $_SESSION['csrf_token'] = bin2hex(random_bytes(32));
}

sendSecurityHeaders();

// 4. ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°å‡¦ç† (ä¿®æ­£ç‰ˆ)
$requestPath = parse_url($_SERVER['REQUEST_URI'], PHP_URL_PATH);
$method = $_SERVER['REQUEST_METHOD'];
// â–¼â–¼â–¼ è¿½åŠ ï¼šHEADãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’GETã¨ã—ã¦å‡¦ç†ï¼ˆ404å¯¾ç­–ï¼‰ â–¼â–¼â–¼
if ($method === 'HEAD' && ($requestPath === '/' || $requestPath === '/index.php')) {
    $method = 'GET';
}
// ã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒç½®ã‹ã‚Œã¦ã„ã‚‹ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’å–å¾— (ä¾‹: /public)
$scriptDir = dirname($_SERVER['SCRIPT_NAME']);

// ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ‘ã‚¹ã®å…ˆé ­ã«ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãƒ‘ã‚¹ãŒå«ã¾ã‚Œã¦ã„ã‚Œã°å‰Šé™¤ã™ã‚‹
// ã“ã‚Œã«ã‚ˆã‚Š /public/koban/edit ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚’ /koban/edit ã¨ã—ã¦æ‰±ãˆã¾ã™
if ($scriptDir !== '/' && strpos($requestPath, $scriptDir) === 0) {
    $requestPath = substr($requestPath, strlen($scriptDir));
}

// ã•ã‚‰ã« /index.php ãŒä»˜ã„ã¦ã„ãŸã‚‰å‰Šé™¤ã™ã‚‹
$path = str_replace('/index.php', '', $requestPath);

// ç©ºæ–‡å­—ã«ãªã£ãŸå ´åˆã¯ãƒ«ãƒ¼ãƒˆ(/)ã¨ã¿ãªã™
if ($path === '') {
    $path = '/';
}

// ç¢ºèªç”¨ãƒ‡ãƒãƒƒã‚° (è§£æ±ºã—ãŸã‚‰æ¶ˆã—ã¦ãã ã•ã„)
// echo "Resolved Path: " . htmlspecialchars($path);

// ãƒ«ãƒ¼ãƒˆå®šç¾©
$routes = [
    'GET' => [
        '/'             => [KobanController::class, 'index'],
        '/opendata'     => [KobanController::class, 'index'],
        '/koban/create' => [KobanController::class, 'create'],
        '/koban/edit'   => [KobanController::class, 'edit'],
        '/admin/login'  => [AuthController::class, 'showLoginForm'],
        '/koban/export' => [KobanController::class, 'export'],
        '/auth/login'   => [AuthController::class, 'showLoginForm'], // è¿½åŠ 
        '/register' => [App\Controllers\AuthController::class, 'showRegisterForm'],

        // â–¼â–¼â–¼ ç®¡ç†è€…ç”¨ãƒ«ãƒ¼ãƒˆ (è¿½åŠ ) â–¼â–¼â–¼
        '/admin/logs'            => [AdminController::class, 'logs'],            // ãƒ­ã‚°ä¸€è¦§
        '/admin/api/logs'        => [AdminController::class, 'apiLogs'],         // ãƒ­ã‚°API (JSç”¨)
        '/admin/password/change' => [AdminController::class, 'changePassword'],  // PWå¤‰æ›´ç”»é¢
        '/admin/password/reset'  => [AdminController::class, 'resetPasswordForm'], // PWå¼·åˆ¶ãƒªã‚»ãƒƒãƒˆ
        '/admin/users/export' => [AdminController::class, 'exportAdmins'],
        '/admin/users'          => [AdminController::class, 'admins'],           // ä¸€è¦§
        '/admin/users/create'   => [AdminController::class, 'showRegisterForm'], // ç™»éŒ²ç”»é¢
        '/admin/users/edit'     => [AdminController::class, 'editAdmin'],       // è©³ç´°ãƒ»ç·¨é›†ç”»é¢
        '/admin/users/handle_request' => [AdminController::class, 'handleRequest'],
    ],
    'POST' => [
        '/koban/store'  => [KobanController::class, 'store'],
        '/koban/delete' => [KobanController::class, 'delete'],
        '/auth/login'   => [AuthController::class, 'login'],
        '/auth/logout'  => [AuthController::class, 'logout'],
        '/auth/request_permission' => [AuthController::class, 'submitRequest'],
        '/koban/import' => [KobanController::class, 'importCsv'],
        '/register' => [AuthController::class, 'register'],


        // â–¼â–¼â–¼ ç®¡ç†è€…ç”¨ãƒ«ãƒ¼ãƒˆ (è¿½åŠ ) â–¼â–¼â–¼
        '/admin/password/update' => [AdminController::class, 'updatePassword'],  // PWå¤‰æ›´å®Ÿè¡Œ
        '/admin/users/store'     => [AdminController::class, 'storeAdmin'],      // ç®¡ç†è€…ç™»éŒ²ãƒ»å‰Šé™¤
        '/admin/password/reset'  => [AdminController::class, 'resetPasswordExec'], // PWå¼·åˆ¶ãƒªã‚»ãƒƒãƒˆå®Ÿè¡Œ
        '/admin/users/register'  => [AdminController::class, 'registerUser'],    // æ–°è¦ç™»éŒ²å®Ÿè¡Œ
        '/admin/users/update_perms' => [AdminController::class, 'updateAdminPerms'], // æ¨©é™æ›´æ–°
        '/admin/users/reset_pw'  => [AdminController::class, 'resetPassword'],    // PWãƒªã‚»ãƒƒãƒˆå®Ÿè¡Œ
        '/admin/users/delete'    => [AdminController::class, 'deleteAdmin'],      // å‰Šé™¤å®Ÿè¡Œ
    ]
];

// 5. ãƒ‡ã‚£ã‚¹ãƒ‘ãƒƒãƒ (ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼å‘¼ã³å‡ºã—)
if (isset($routes[$method][$path])) {
    // å¯¾å¿œã™ã‚‹ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ã¨ãƒ¡ã‚½ãƒƒãƒ‰ã‚’å–ã‚Šå‡ºã™
    [$controllerClass, $action] = $routes[$method][$path];

    // ã‚¯ãƒ©ã‚¹ãŒå­˜åœ¨ã™ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
    if (class_exists($controllerClass)) {
        $controller = new $controllerClass();
        if (method_exists($controller, $action)) {
            // ãƒ¡ã‚½ãƒƒãƒ‰å®Ÿè¡Œï¼
            $controller->$action();
        } else {
            http_response_code(500);
            echo "Error: Method '$action' not found in $controllerClass";
        }
    } else {
        http_response_code(500);
        echo "Error: Class '$controllerClass' not found";
    }
} else {
    // å®šç¾©ã•ã‚Œã¦ã„ãªã„URLã®å ´åˆ
    http_response_code(404);
    echo "<h1>404 Not Found</h1>";
    echo "<p>ãƒšãƒ¼ã‚¸ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚</p>";
    echo "<a href='/'>ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸ã¸æˆ»ã‚‹</a>";
}
</file>

<file path="src/Utils/functions.php">
<?php
// æ¨©é™ç®¡ç†ç”¨ã®å®šæ•°å®šç¾©
const PERM_DATA  = 'data';
const PERM_ADMIN = 'admin';
const PERM_LOG   = 'log';

/**
 * æ¨©é™ãƒã‚§ãƒƒã‚¯ãƒ˜ãƒ«ãƒ‘ãƒ¼ (å®šæ•°å¯¾å¿œç‰ˆ)
 * @param string|array $types ãƒã‚§ãƒƒã‚¯ã—ãŸã„æ¨©é™(å®šæ•°)ã¾ãŸã¯ãã®é…åˆ—
 * @return bool
 */

// åå‰ç©ºé–“ã¯å®šç¾©ã›ãšã€ã‚°ãƒ­ãƒ¼ãƒãƒ«é–¢æ•°ã¨ã—ã¦æ‰±ã„ã¾ã™
use App\Utils\Database;

define('PAGE_LIMIT', 100);
date_default_timezone_set('Asia/Tokyo');
// HTMLã‚¨ã‚¹ã‚±ãƒ¼ãƒ— (é »ç¹ã«ä½¿ã†ã®ã§çŸ­ã„åå‰ã®ã¾ã¾)
function h($str)
{
    return htmlspecialchars($str ?? '', ENT_QUOTES, 'UTF-8');
}

// CSRFãƒˆãƒ¼ã‚¯ãƒ³æ¤œè¨¼
function verifyCsrfToken()
{
    // ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒé–‹å§‹ã•ã‚Œã¦ã„ãªã‘ã‚Œã°é–‹å§‹
    if (session_status() === PHP_SESSION_NONE) {
        session_start();
    }

    // ãƒˆãƒ¼ã‚¯ãƒ³ç”Ÿæˆï¼ˆãªã‘ã‚Œã°ä½œã‚‹ï¼‰
    if (empty($_SESSION['csrf_token'])) {
        $_SESSION['csrf_token'] = bin2hex(random_bytes(32));
    }

    // POSTé€ä¿¡æ™‚ã¯ãƒã‚§ãƒƒã‚¯ã‚’è¡Œã†
    if ($_SERVER['REQUEST_METHOD'] === 'POST') {
        if (!isset($_POST['csrf_token']) || $_POST['csrf_token'] !== $_SESSION['csrf_token']) {
            http_response_code(403);
            die('CSRF Token Verification Failed');
        }
    }
}

function sendSecurityHeaders()
{
    // ã‚¯ãƒªãƒƒã‚¯ã‚¸ãƒ£ãƒƒã‚­ãƒ³ã‚°å¯¾ç­–ï¼ˆiframeã§ã®è¡¨ç¤ºã‚’ç¦æ­¢ï¼‰
    header('X-Frame-Options: DENY');

    // XSSãƒ•ã‚£ãƒ«ã‚¿ãƒ¼æ©Ÿèƒ½ã®å¼·åˆ¶æœ‰åŠ¹åŒ–ï¼ˆå¤ã„ãƒ–ãƒ©ã‚¦ã‚¶å‘ã‘ï¼‰
    header('X-XSS-Protection: 1; mode=block');

    // ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚¿ã‚¤ãƒ—ã®ã‚¹ãƒ‹ãƒƒãƒ•ã‚£ãƒ³ã‚°é˜²æ­¢ï¼ˆç”»åƒã«è¦‹ã›ã‹ã‘ãŸã‚¹ã‚¯ãƒªãƒ—ãƒˆå®Ÿè¡Œãªã©ã‚’é˜²ãï¼‰
    header('X-Content-Type-Options: nosniff');

    // å¯èƒ½ãªé™ã‚ŠHTTPSã‚’å¼·åˆ¶ï¼ˆæœ¬ç•ªç’°å¢ƒã®ã¿æ¨å¥¨ï¼‰
    // header('Strict-Transport-Security: max-age=31536000; includeSubDomains');
}

// æ¨©é™ãƒã‚§ãƒƒã‚¯ãƒ˜ãƒ«ãƒ‘ãƒ¼
function hasPermission($types)
{
    if (!isset($_SESSION['permissions'])) return false;

    // é…åˆ—ã§ãªã„å ´åˆã¯é…åˆ—ã«å¤‰æ›ã—ã¦ãƒ«ãƒ¼ãƒ—å‡¦ç†
    $types = (array)$types;
    foreach ($types as $type) {
        // ã‚»ãƒƒã‚·ãƒ§ãƒ³å†…ã«è©²å½“ã™ã‚‹æ¨©é™ãƒ•ãƒ©ã‚°ãŒ1ã§ã‚ã‚Œã°trueã‚’è¿”ã™
        if (!empty($_SESSION['permissions'][$type])) {
            return true;
        }
    }
    return false;
}

// ä¿è­·å¯¾è±¡ã®ç®¡ç†è€…IDã‚’å®šç¾©ï¼ˆç’°å¢ƒå¤‰æ•°ã‹ã‚‰èª­ã¿è¾¼ã‚€ã®ãŒç†æƒ³çš„ï¼‰
define('SUPER_ADMIN_ID', 'admin');

/**
 * å¯¾è±¡IDãŒä¿è­·ã•ã‚ŒãŸç‰¹æ¨©ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‹åˆ¤å®š
 */
function isProtectedAdmin($loginId)
{
    return $loginId === SUPER_ADMIN_ID;
}
/**
 * ç¾åœ¨ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæœ€é«˜ç®¡ç†è€…ï¼ˆSuper Adminï¼‰ã‹åˆ¤å®š
 */
function isCurrentSuperAdmin()
{
    return isset($_SESSION['login_id']) && $_SESSION['login_id'] === SUPER_ADMIN_ID;
}
/**
 * æ¥ç¶šå…ƒã®çœŸã®IPã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å–å¾—ã™ã‚‹
 */
function getRemoteIp()
{
    // Renderã‚„ãƒ—ãƒ­ã‚­ã‚·ç’°å¢ƒã§ã¯ X-Forwarded-For ã‚’å„ªå…ˆã™ã‚‹
    if (!empty($_SERVER['HTTP_X_FORWARDED_FOR'])) {
        // ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šã§è¤‡æ•°å…¥ã‚‹ã“ã¨ãŒã‚ã‚‹ã®ã§æœ€åˆã®1ã¤ã‚’å–å¾—
        $ips = explode(',', $_SERVER['HTTP_X_FORWARDED_FOR']);
        return trim($ips[0]);
    }
    if (!empty($_SERVER['HTTP_CLIENT_IP'])) {
        return $_SERVER['HTTP_CLIENT_IP'];
    }
    return $_SERVER['REMOTE_ADDR'] ?? '0.0.0.0';
}

/**
 * ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‹ã‚‰ä¸€åº¦ã ã‘è¡¨ç¤ºã™ã‚‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å–å¾—
 */
function getFlashMessage()
{
    if (isset($_SESSION['message'])) {
        $msg = $_SESSION['message'];
        unset($_SESSION['message']);
        return $msg;
    }
    return null;
}

// ãƒ­ã‚°è¨˜éŒ² (Databaseã‚¯ãƒ©ã‚¹ã‚’ä½¿ã†å½¢ã«å°‘ã—ä¿®æ­£)
function logAction($userId, $actionType, $details)
{
    // ç›£è¦–ã‚µãƒ¼ãƒ“ã‚¹ç‰¹æœ‰ã®User-Agentã‚’åˆ¤å®š
    $ua = $_SERVER['HTTP_USER_AGENT'] ?? '';
    $isPing = (stripos($ua, 'UptimeRobot') !== false || stripos($ua, 'cron-job') !== false);
    // HEADãƒªã‚¯ã‚¨ã‚¹ãƒˆã¾ãŸã¯ç›£è¦–ã‚µãƒ¼ãƒ“ã‚¹ã®å ´åˆã¯ç¨®åˆ¥ã‚’ PING ã«å›ºå®š
    if ($_SERVER['REQUEST_METHOD'] === 'HEAD' || $isPing) {
        $actionType = 'PING';
        $userId = 'system_monitor';
    }

    try {
        $db = \App\Utils\Database::connect();
        $sql = "INSERT INTO audit_logs (user_id, action_type, details, ip_address, user_agent, action_time) VALUES (?, ?, ?, ?, ?, ?)";
        $stmt = $db->prepare($sql);

        $success = $stmt->execute([
            $userId,
            $actionType,
            $details,
            getRemoteIp(),
            $_SERVER['HTTP_USER_AGENT'] ?? '',
            date('Y-m-d H:i:s')
        ]);

        // â–¼â–¼â–¼ DBåœ§è¿«å¯¾ç­–ï¼šå¤ã„ PING ãƒ­ã‚°ã‚’è‡ªå‹•å‰Šé™¤ï¼ˆ1æ—¥ä»¥ä¸Šå‰ï¼‰ â–¼â–¼â–¼
        // ã“ã®ã‚¯ã‚¨ãƒªã«ã‚ˆã‚Šã€ç›£è¦–ãƒ­ã‚°ãŒç„¡é™ã«å¢—ãˆã‚‹ã®ã‚’é˜²ãã¾ã™
        if ($actionType === 'PING') {
            $cleanupSql = "DELETE FROM audit_logs WHERE action_type = 'PING' AND action_time < CURRENT_TIMESTAMP - INTERVAL '1 day'";
            $db->exec($cleanupSql);
        }
        // â–²â–²â–² å¯¾ç­–ã“ã“ã¾ã§ â–²â–²â–²

        if (!$success) {
            // SQLã®å®Ÿè¡Œã«å¤±æ•—ã—ãŸå ´åˆã€ã‚¨ãƒ©ãƒ¼å†…å®¹ã‚’ Render ã®ãƒ­ã‚°ã¸å‡ºåŠ›
            $errorInfo = $stmt->errorInfo();
            error_log("ã€DB ERRORã€‘Log save failed: " . $errorInfo[2]);
        }
    } catch (\Exception $e) {
        // æ¥ç¶šã‚¨ãƒ©ãƒ¼ãªã©ã®è‡´å‘½çš„ã‚¨ãƒ©ãƒ¼ã‚’è¨˜éŒ²
        error_log("ã€LOG CRITICAL ERRORã€‘" . $e->getMessage());
    }
}

/**
 * æ¤œç´¢ã‚¯ã‚¨ãƒªæ§‹ç¯‰ãƒ˜ãƒ«ãƒ‘ãƒ¼
 */
function buildSearchQuery($getParams)
{
    $where_clauses = [];
    $params = [];
    $log_parts = [];

    // --- 1. å°‚ç”¨IDæ¤œç´¢ (è¿½åŠ ) ---
    // å®Œå…¨ä¸€è‡´ã§æ¤œç´¢ã™ã‚‹ãŸã‚ã€é«˜é€Ÿã‹ã¤PostgreSQLã§ã‚‚å®‰å…¨ã§ã™
    if (!empty($getParams['search_id'])) {
        $where_clauses[] = "id = ?";
        $params[] = (int)$getParams['search_id'];
        $log_parts[] = "ID: " . $getParams['search_id'];
    }

    // --- 2. éƒ½é“åºœçœŒãƒ»ç¨®åˆ¥ (æ—¢å­˜) ---
    if (!empty($getParams['search_pref'])) {
        $where_clauses[] = "pref = ?";
        $params[] = $getParams['search_pref'];
        $log_parts[] = "çœŒ: " . $getParams['search_pref'];
    }
    if (!empty($getParams['search_type'])) {
        $where_clauses[] = "type = ?";
        $params[] = $getParams['search_type'];
        $log_parts[] = "ç¨®åˆ¥: " . $getParams['search_type'];
    }

    // --- 3. ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ¤œç´¢ (ä¿®æ­£) ---
    if (!empty($getParams['keyword'])) {
        $keyword = $getParams['keyword'];
        $keywords = preg_split('/[\s]+/', mb_convert_kana($keyword, 's', 'UTF-8'));
        foreach ($keywords as $word) {
            if ($word === "") continue;
            // PostgreSQLå¯¾å¿œ: id ã‚’ CAST(id AS TEXT) ã«å¤‰æ›´ã—ã¦ LIKE ã‚’é€šã‚‹ã‚ˆã†ã«ã™ã‚‹
            $where_clauses[] = "(pref LIKE ? OR CAST(id AS TEXT) LIKE ? OR koban_fullname LIKE ? OR addr3 LIKE ?)";
            $params = array_merge($params, array_fill(0, 4, "%" . $word . "%"));
        }
        $log_parts[] = "KW: $keyword";
    }

    $where_sql = !empty($where_clauses) ? "WHERE " . implode(' AND ', $where_clauses) : "";

    return [
        'sql' => $where_sql,
        'params' => $params,
        'log_detail' => empty($log_parts) ? "å…¨ãƒ‡ãƒ¼ã‚¿" : implode(' ', $log_parts)
    ];
}
</file>

<file path="src/Controllers/AdminController.php">
<?php

namespace App\Controllers;

use App\Models\AdminUser;
use App\Models\AuditLog;
use App\Utils\View;
use App\Utils\Validator;

class AdminController
{

    // å…±é€šã®æ¨©é™ãƒã‚§ãƒƒã‚¯ãƒ¡ã‚½ãƒƒãƒ‰
    private function requirePermission($type)
    {
        // æ–‡å­—åˆ—ã®ä»£ã‚ã‚Šã«å®šæ•°ã‚’å—ã‘å–ã‚‹ã‚ˆã†ã«ã—ã€ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ç¢ºèª
        if (!isset($_SESSION['logged_in']) || !hasPermission($type)) {
            $_SESSION['message'] = "æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“ã€‚";
            header("Location: /");
            exit;
        }
    }

    /**
     * æ“ä½œãƒ­ã‚°ä¸€è¦§ç”»é¢ (æ—§ view_logs.php)
     */
    public function logs()
    {
        $this->requirePermission(PERM_LOG);

        $logModel = new AuditLog();

        // CSVãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å‡¦ç†
        if (isset($_GET['download_csv'])) {
            $this->downloadLogsCsv($logModel);
            return;
        }

        // ç”»é¢è¡¨ç¤ºç”¨ãƒ‡ãƒ¼ã‚¿
        $types = $logModel->getActionTypes();
        $logs = $logModel->search($_GET, 500);
        $latest_id = count($logs) > 0 ? $logs[0]['id'] : 0;

        return View::render('admin/log_list', [
            'types' => $types,
            'logs' => $logs,
            'latest_id' => $latest_id
        ]);
    }

    /**
     * ãƒ­ã‚°CSVãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ï¼ˆlogsãƒ¡ã‚½ãƒƒãƒ‰ã‹ã‚‰å‘¼ã°ã‚Œã‚‹ï¼‰
     */
    private function downloadLogsCsv($logModel)
    {
        $logs = $logModel->search($_GET, 10000);
        $filename = "audit_log_" . date('Ymd_His') . ".csv";

        header('Content-Type: text/csv');
        header('Content-Disposition: attachment; filename="' . $filename . '"');
        $output = fopen('php://output', 'w');
        fwrite($output, "\xEF\xBB\xBF");
        fputcsv($output, ['ID', 'ãƒ¦ãƒ¼ã‚¶ãƒ¼ID', 'æ—¥æ™‚', 'æ“ä½œç¨®åˆ¥', 'è©³ç´°å†…å®¹', 'IPã‚¢ãƒ‰ãƒ¬ã‚¹', 'UserAgent']);

        foreach ($logs as $row) {
            fputcsv($output, [
                $row['id'],
                $row['user_id'],
                $row['action_time'],
                $row['action_type'],
                $row['details'],
                $row['ip_address'],
                $row['user_agent'] ?? ''
            ]);
        }
        fclose($output);
        exit;
    }

    /**
     * ãƒ­ã‚°API (æ—§ api_get_logs.php)
     * JavaScriptã‹ã‚‰éåŒæœŸã§å‘¼ã°ã‚Œã‚‹JSONè¿”å´ç”¨ãƒ¡ã‚½ãƒƒãƒ‰
     */
    public function apiLogs()
    {
        // APIã§ã‚‚ã—ã£ã‹ã‚Šæ¨©é™ãƒã‚§ãƒƒã‚¯
        if (!isset($_SESSION['logged_in']) || !hasPermission(PERM_LOG)) {
            header('Content-Type: application/json');
            echo json_encode(['error' => 'Forbidden']);
            exit;
        }

        $logModel = new AuditLog();
        $last_id = isset($_GET['last_id']) ? (int)$_GET['last_id'] : 0;
        $newLogs = $logModel->getNewLogs($last_id, $_GET);

        // XSSå¯¾ç­–ã‚’ã—ã¦JSONã§è¿”ã™
        $clean_logs = array_map(function ($log) {
            return [
                'id' => h($log['id']),
                'action_time' => h($log['action_time']),
                'user_id' => h($log['user_id']),
                'action_type' => h($log['action_type']),
                'details' => h($log['details']),
                'ip_address' => h($log['ip_address']),
                'user_agent' => h($log['user_agent'] ?? '')
            ];
        }, $newLogs);

        header('Content-Type: application/json; charset=utf-8');
        echo json_encode($clean_logs);
        exit;
    }

    /**
     * è‡ªåˆ†ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´ç”»é¢ (æ—§ change_password.php)
     */
    public function changePassword()
    {
        if (!isset($_SESSION['logged_in'])) {
            header("Location: /");
            exit;
        }
        return View::render('admin/change_password', ['message' => $_SESSION['message'] ?? '']);
    }

    /**
     * ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´å‡¦ç† (POST)
     */
    public function updatePassword()
    {
        verifyCsrfToken();
        if (!isset($_SESSION['logged_in'])) header("Location: /");

        $adminModel = new AdminUser();
        $user_id = $_SESSION['login_id'];

        try {
            $user = $adminModel->findById($user_id);
            if ($user && password_verify($_POST['current_pass'], $user['password_hash'])) {
                $new_hash = password_hash($_POST['new_pass'], PASSWORD_DEFAULT);
                $adminModel->updatePassword($user_id, $new_hash);

                $_SESSION['message'] = "ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å¤‰æ›´ã—ã¾ã—ãŸï¼";
                logAction($user_id, 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´', 'æˆåŠŸ');
            } else {
                $_SESSION['message'] = "ç¾åœ¨ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé–“é•ã£ã¦ã„ã¾ã™ã€‚";
                logAction($user_id, 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´å¤±æ•—', 'å…¥åŠ›ãƒŸã‚¹');
            }
        } catch (\Exception $e) {
            $_SESSION['message'] = "ã‚¨ãƒ©ãƒ¼: " . $e->getMessage();
        }

        // ãƒ•ã‚©ãƒ¼ãƒ ã¸ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
        header("Location: /admin/password/change");
        exit;
    }

    /**
     * ç®¡ç†è€…ä¸€è¦§ (ãƒ•ã‚©ãƒ¼ãƒ ã‚’é™¤å»)
     */
    public function admins()
    {
        $this->requirePermission(PERM_ADMIN);
        $adminModel = new AdminUser();
        $all_admins = $adminModel->findAll();

        // ç‰¹æ¨©ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®éš è”½
        $filtered = array_filter($all_admins, function ($a) {
            return isCurrentSuperAdmin() || !isProtectedAdmin($a['login_id']);
        });

        return View::render('admin/register', [ // ãƒ•ã‚¡ã‚¤ãƒ«åã¯æ—¢å­˜ã®ã¾ã¾ä¸€è¦§ã¨ã—ã¦ä½¿ç”¨
            'admin_list' => $filtered
        ]);
    }
    /**
     * ç®¡ç†è€…ä¿å­˜ãƒ»å‰Šé™¤å‡¦ç† (POST)
     */
    public function storeAdmin()
    {
        $this->requirePermission(PERM_ADMIN);
        verifyCsrfToken();

        $adminModel = new AdminUser();

        // å‰Šé™¤å‡¦ç†
        if (isset($_POST['delete_admin_id'])) {
            if (!isCurrentSuperAdmin()) {
                $_SESSION['message'] = "ã‚¨ãƒ©ãƒ¼ï¼šç®¡ç†è€…ã®å‰Šé™¤æ¨©é™ã¯æœ€é«˜ç®¡ç†è€…ã«é™å®šã•ã‚Œã¦ã„ã¾ã™ã€‚";
                header("Location: /admin/users");
                exit;
            }
            $target = $_POST['delete_admin_id'];

            // ç‰¹æ¨©ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®å‰Šé™¤ã‚’ãƒ–ãƒ­ãƒƒã‚¯
            if (isProtectedAdmin($target)) {
                $_SESSION['message'] = "ã‚¨ãƒ©ãƒ¼ï¼šã‚·ã‚¹ãƒ†ãƒ ç®¡ç†è€…ã¯å‰Šé™¤ã§ãã¾ã›ã‚“ã€‚";
            } elseif ($_POST['delete_admin_id'] === $_SESSION['login_id']) {
                $_SESSION['message'] = "ã‚¨ãƒ©ãƒ¼ï¼šè‡ªåˆ†è‡ªèº«ã¯å‰Šé™¤ã§ãã¾ã›ã‚“ã€‚";
            } else {
                $adminModel->delete($_POST['delete_admin_id']);
                $_SESSION['message'] = "ç®¡ç†è€…ID: {$_POST['delete_admin_id']} ã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚";
                logAction($_SESSION['login_id'], 'ç®¡ç†è€…å‰Šé™¤', "å¯¾è±¡: {$_POST['delete_admin_id']}");
            }
        }

        // æ–°è¦ç™»éŒ²å‡¦ç†
        if (isset($_POST['new_admin_id'])) {
            if ($adminModel->exists($_POST['new_admin_id'])) {
                $_SESSION['message'] = "ã‚¨ãƒ©ãƒ¼ï¼šãã®IDã¯æ—¢ã«ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã™ã€‚";
            } else {
                $perms = [
                    'data'  => isset($_POST['perm_data']) ? 1 : 0,
                    'admin' => isset($_POST['perm_admin']) ? 1 : 0,
                    'log'   => isset($_POST['perm_log']) ? 1 : 0
                ];
                $adminModel->create($_POST['new_admin_id'], $_POST['new_admin_pass'], $perms);
                $_SESSION['message'] = "ç®¡ç†è€…ã€Œ{$_POST['new_admin_id']}ã€ã‚’ç™»éŒ²ã—ã¾ã—ãŸã€‚";
                logAction($_SESSION['login_id'], 'ç®¡ç†è€…ç™»éŒ²', "æ–°è¦: {$_POST['new_admin_id']}");
            }
        }

        header("Location: /admin/users");
        exit;
    }
    /**
     * æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²ç”»é¢ã®è¡¨ç¤º
     */
    public function showRegisterForm()
    {
        // ãƒ­ã‚°ã‚¤ãƒ³ãƒã‚§ãƒƒã‚¯ã¨æœ€é«˜ç®¡ç†è€…æ¨©é™ã®ç¢ºèª
        if (!isCurrentSuperAdmin()) {
            $_SESSION['message'] = "ã‚¨ãƒ©ãƒ¼ï¼šãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²ã¯æœ€é«˜ç®¡ç†è€…ã®ã¿è¨±å¯ã•ã‚Œã¦ã„ã¾ã™ã€‚";
            header("Location: /admin/users");
            exit;
        }

        return View::render('admin/user_registration', [
            'page_title' => 'æ–°è¦ç®¡ç†è€…ç™»éŒ²',
            'message' => getFlashMessage()
        ]);
    }

    /**
     * ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²å‡¦ç†ã®å®Ÿè¡Œ
     */
    public function registerUser()
    {
        verifyCsrfToken();

        $login_id = $_POST['new_id'] ?? '';
        $password = $_POST['new_pass'] ?? '';

        // IDã®å½¢å¼ãƒã‚§ãƒƒã‚¯
        list($idValid, $idMsg) = Validator::validateLoginId($login_id);
        if (!$idValid) {
            $_SESSION['message'] = $idMsg;
            header("Location: /admin/users/create");
            exit;
        }

        // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã®å¼·åº¦ãƒã‚§ãƒƒã‚¯
        list($pwValid, $pwMsg) = Validator::validatePassword($password);
        if (!$pwValid) {
            $_SESSION['message'] = $pwMsg;
            header("Location: /admin/users/create");
            exit;
        }

        $adminModel = new \App\Models\AdminUser();

        // é‡è¤‡ãƒã‚§ãƒƒã‚¯
        if ($adminModel->exists($login_id)) {
            $_SESSION['message'] = "ã‚¨ãƒ©ãƒ¼ï¼šãã®IDã¯æ—¢ã«ä½¿ç”¨ã•ã‚Œã¦ã„ã¾ã™ã€‚";
            header("Location: /admin/users/create");
            exit;
        }

        // æ¨©é™è¨­å®šã®å–å¾—
        $perms = [
            'data'  => isset($_POST['perm_data']) ? 1 : 0,
            'admin' => isset($_POST['perm_admin']) ? 1 : 0,
            'log'   => isset($_POST['perm_log']) ? 1 : 0
        ];

        // ä¿å­˜å®Ÿè¡Œ
        if ($adminModel->create($login_id, $password, $perms)) {
            logAction($_SESSION['login_id'], 'ç®¡ç†è€…ç™»éŒ²', "æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼: $login_id");
            $_SESSION['message'] = "ç®¡ç†è€…ã€Œ{$login_id}ã€ã‚’æ­£å¸¸ã«ç™»éŒ²ã—ã¾ã—ãŸã€‚";
            header("Location: /admin/users");
        } else {
            $_SESSION['message'] = "ã‚¨ãƒ©ãƒ¼ï¼šç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸã€‚";
            header("Location: /admin/users/create");
        }
        exit;
    }

    /**
     * ç”³è«‹ã®æ‰¿èªã¾ãŸã¯å´ä¸‹ã‚’å®Ÿè¡Œ
     */
    public function handleRequest()
    {
        $this->requirePermission(PERM_ADMIN); // ç®¡ç†è€…æ¨©é™ãƒã‚§ãƒƒã‚¯
        verifyCsrfToken(); // CSRFå¯¾ç­–

        $targetId = $_POST['target_admin_id'] ?? '';
        $action = $_POST['request_action'] ?? ''; // 'approve' or 'reject'

        if ($targetId && $action) {
            $adminModel = new AdminUser();
            if ($adminModel->updateRequestStatus($targetId, $action)) {
                $statusMsg = ($action === 'approve') ? 'æ‰¿èª' : 'å´ä¸‹';
                logAction($_SESSION['login_id'], "ç”³è«‹{$statusMsg}", "å¯¾è±¡: $targetId");
                $_SESSION['message'] = "ãƒ¦ãƒ¼ã‚¶ãƒ¼ {$targetId} ã®ç”³è«‹ã‚’{$statusMsg}ã—ã¾ã—ãŸã€‚";
            } else {
                $_SESSION['message'] = "ã‚¨ãƒ©ãƒ¼ï¼šå‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸã€‚";
            }
        }

        header("Location: /admin/users");
        exit;
    }

    /**
     * ç®¡ç†è€…ä¸€è¦§ã‚’CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã™ã‚‹
     */
    public function exportAdmins()
    {
        // ã€Œadminã€æ¨©é™ï¼ˆã‚¢ã‚«ã‚¦ãƒ³ãƒˆç®¡ç†ï¼‰ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯ã—ã¾ã™
        $this->requirePermission(PERM_ADMIN);

        // Supabaseç§»è¡Œã«å¿…è¦ãªã™ã¹ã¦ã®ã‚«ãƒ©ãƒ ã‚’ç›´æ¥å–å¾—ã—ã¾ã™
        $db = \App\Utils\Database::connect(); //
        $sql = "SELECT login_id, password_hash, role, failure_count, locked_until, perm_data, perm_admin, perm_log FROM admin_users";
        $stmt = $db->query($sql);
        $admins = $stmt->fetchAll(\PDO::FETCH_ASSOC);

        $filename = "admin_users_migration_" . date('Ymd_His') . ".csv";

        // å‡ºåŠ›ãƒãƒƒãƒ•ã‚¡ã‚’ã‚¯ãƒªã‚¢ã—ã€ä½™è¨ˆãªæ–‡å­—ãŒæ··å…¥ã™ã‚‹ã®ã‚’é˜²ãã¾ã™
        if (ob_get_level()) ob_end_clean();

        header('Content-Type: text/csv');
        header('Content-Disposition: attachment; filename="' . $filename . '"');

        $output = fopen('php://output', 'w');
        // Excelã§é–‹ã„ã¦ã‚‚æ–‡å­—åŒ–ã‘ã—ãªã„ã‚ˆã†BOMã‚’ä»˜ä¸ã—ã¾ã™
        fwrite($output, "\xEF\xBB\xBF");

        // æŒ‡å®šã•ã‚ŒãŸãƒ˜ãƒƒãƒ€ãƒ¼ã‚’å‡ºåŠ›ã—ã¾ã™
        fputcsv($output, ['login_id', 'password_hash', 'role', 'failure_count', 'locked_until', 'perm_data', 'perm_admin', 'perm_log']);

        foreach ($admins as $row) {
            fputcsv($output, [
                $row['login_id'],
                $row['password_hash'],
                $row['role'] ?? 1,
                $row['failure_count'] ?? 0,
                $row['locked_until'] ?? '',
                $row['perm_data'] ?? 0,
                $row['perm_admin'] ?? 0,
                $row['perm_log'] ?? 0
            ]);
        }
        fclose($output);
        exit; // ãƒ“ãƒ¥ãƒ¼ã‚’è¡¨ç¤ºã›ãšã«çµ‚äº†ã—ã¾ã™
    }
    /**
     * ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¼·åˆ¶ãƒªã‚»ãƒƒãƒˆç”»é¢ (æ—§ reset_admin_pass.php)
     */
    public function resetPasswordForm()
    {
        if (!isCurrentSuperAdmin()) {
            $_SESSION['message'] = "ã‚¨ãƒ©ãƒ¼ï¼šã“ã®æ“ä½œã«ã¯æœ€é«˜ç®¡ç†è€…æ¨©é™ãŒå¿…è¦ã§ã™ã€‚";
            header("Location: /admin/users");
            exit;
        }
        $this->requirePermission(PERM_ADMIN);
        return View::render('admin/reset_password', [
            'target_id' => $_GET['id'] ?? '',
            'message' => $_SESSION['message'] ?? ''
        ]);
    }

    /**
     * ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¼·åˆ¶ãƒªã‚»ãƒƒãƒˆå‡¦ç† (POST)
     */
    public function resetPasswordExec()
    {
        $this->requirePermission(PERM_ADMIN);
        verifyCsrfToken();

        $adminModel = new AdminUser();
        $target = $_POST['reset_target_id'];

        if (!$adminModel->exists($target)) {
            $_SESSION['message'] = "ã‚¨ãƒ©ãƒ¼ï¼šIDã€Œ{$target}ã€ã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚";
        } else {
            $hash = password_hash($_POST['reset_new_pass'], PASSWORD_DEFAULT);
            $adminModel->updatePassword($target, $hash);
            $_SESSION['message'] = "ç®¡ç†è€…ã€Œ{$target}ã€ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸã€‚";
            logAction($_SESSION['login_id'], 'PWãƒªã‚»ãƒƒãƒˆ', "å¯¾è±¡: $target");
        }

        header("Location: /admin/password/reset"); // ç”»é¢æ›´æ–°
        exit;
    }

    /**
     * ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆå®Ÿè¡Œ
     */
    public function resetPassword()
    {
        $this->requirePermission(PERM_ADMIN);
        verifyCsrfToken();

        if (!isCurrentSuperAdmin()) {
            $_SESSION['message'] = "ACCESS_DENIED: SuperAdmin authority required.";
            header("Location: /admin/users");
            exit;
        }

        $targetId = $_POST['target_admin_id'] ?? '';
        $newPass = $_POST['new_password'] ?? '';

        if (strlen($newPass) < 8) {
            $_SESSION['message'] = "ERROR: Password must be at least 8 chars.";
            header("Location: /admin/users/edit?id=" . urlencode($targetId));
            exit;
        }

        $adminModel = new AdminUser();
        $hash = password_hash($newPass, PASSWORD_DEFAULT);

        if ($adminModel->updatePassword($targetId, $hash)) {
            logAction($_SESSION['login_id'], 'PW_RESET', "Target: $targetId");
            $_SESSION['message'] = "SUCCESS: Password updated for $targetId";
        }

        header("Location: /admin/users");
        exit;
    }

    /**
     * ç®¡ç†è€…è©³ç´°ãƒ»æ¨©é™ç·¨é›†ç”»é¢ã®è¡¨ç¤º
     */
    public function editAdmin()
    {
        $this->requirePermission(PERM_ADMIN);

        $login_id = $_GET['id'] ?? '';
        $adminModel = new AdminUser();
        $targetAdmin = $adminModel->findById($login_id); //

        if (!$targetAdmin) {
            $_SESSION['message'] = "ã‚¨ãƒ©ãƒ¼ï¼šå¯¾è±¡ã®ç®¡ç†è€…ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚";
            header("Location: /admin/users");
            exit;
        }

        return View::render('admin/edit_admin', [
            'admin' => $targetAdmin,
            'message' => $_SESSION['message'] ?? ''
        ]);
    }

    /**
     * ç®¡ç†è€…æ¨©é™ã®æ›´æ–°å®Ÿè¡Œ (POST)
     */
    public function updateAdminPerms()
    {
        $this->requirePermission(PERM_ADMIN);
        verifyCsrfToken();
        $login_id = $_POST['target_admin_id'] ?? '';

        // ç‰¹æ¨©ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®æ¨©é™å¤‰æ›´ã‚’ãƒ–ãƒ­ãƒƒã‚¯
        if (isProtectedAdmin($login_id)) {
            $_SESSION['message'] = "ã‚¨ãƒ©ãƒ¼ï¼šã‚·ã‚¹ãƒ†ãƒ ç®¡ç†è€…ã®æ¨©é™ã¯å¤‰æ›´ã§ãã¾ã›ã‚“ã€‚";
            header("Location: /admin/users");
            exit;
        }

        $perms = [
            'data'  => isset($_POST['perm_data']) ? 1 : 0,
            'admin' => isset($_POST['perm_admin']) ? 1 : 0,
            'log'   => isset($_POST['perm_log']) ? 1 : 0
        ];

        $adminModel = new AdminUser();
        if ($adminModel->updatePermissions($login_id, $perms)) {
            $_SESSION['message'] = "ç®¡ç†è€…ã€Œ{$login_id}ã€ã®æ¨©é™ã‚’æ›´æ–°ã—ã¾ã—ãŸã€‚";
            logAction($_SESSION['login_id'], 'æ¨©é™å¤‰æ›´', "å¯¾è±¡: {$login_id} / Data:{$perms['data']}, Admin:{$perms['admin']}, Log:{$perms['log']}"); //
        } else {
            $_SESSION['message'] = "ã‚¨ãƒ©ãƒ¼ï¼šæ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸã€‚";
        }

        header("Location: /admin/users");
        exit;
    }
}
</file>

<file path="views/admin/register.php">
<?php require __DIR__ . '/../layouts/header.php'; ?>
<div class="container" style="max-width: 850px; margin-top: 20px;">

    <div style="display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #1eff1a; padding-bottom: 10px; margin-bottom: 20px;">
        <h2 style="color: #1eff1a; margin: 0;">ç®¡ç†è€…ä¸€è¦§</h2>
        <?php if (isCurrentSuperAdmin()): ?>
            <a href="/admin/users/create" class="btn-primary" style="text-decoration: none; padding: 5px 15px;">ï¼‹ æ–°è¦ç™»éŒ²</a>
        <?php endif; ?>
    </div>

    <div class="box">
        <table style="width: 100%; border-collapse: collapse; color: #1eff1a; background-color: #000;">
            <thead>
                <tr style="border-bottom: 2px solid #1eff1a;">
                    <th style="padding: 10px; text-align: left;">ãƒ­ã‚°ã‚¤ãƒ³ID</th>
                    <th style="width: 60px;">ãƒ‡ãƒ¼ã‚¿</th>
                    <th style="width: 60px;">ç®¡ç†</th>
                    <th style="width: 60px;">ãƒ­ã‚°</th>
                    <th style="padding: 10px; text-align: center; width: 120px;">ã‚¢ã‚¯ã‚·ãƒ§ãƒ³</th>
                </tr>
            </thead>
            <tbody>
                <?php foreach ($admin_list as $admin): ?>
                    <tr style="border-bottom: 1px solid #222;">
                        <td style="padding: 12px 10px;">
                            <?php echo h($admin['login_id']); ?>
                            <?php if ($admin['login_id'] === $_SESSION['login_id']) echo ' <span style="color:#666; font-size:0.8em;">(è‡ªåˆ†)</span>'; ?>

                            <?php if (($admin['request_status'] ?? '') === 'pending'): ?>
                                <span style="background: #ffff00; color: #000; font-size: 10px; padding: 2px 5px; border-radius: 3px; margin-left: 10px; font-weight: bold; box-shadow: 0 0 8px #ffff00;">
                                    REQUESTED
                                </span>
                            <?php endif; ?>
                        </td>
                        <td style="text-align: center;"><span style="color: <?php echo $admin['perm_data'] ? '#1eff1a' : '#333'; ?>;">â—</span></td>
                        <td style="text-align: center;"><span style="color: <?php echo $admin['perm_admin'] ? '#00ccff' : '#333'; ?>;">â—</span></td>
                        <td style="text-align: center;"><span style="color: <?php echo $admin['perm_log'] ? '#ff00ff' : '#333'; ?>;">â—</span></td>
                        <td style="padding: 10px; text-align: center;">
                            <a href="/admin/users/edit?id=<?php echo h($admin['login_id']); ?>" class="btn-detail"
                                style="text-decoration: none; border: 1px solid var(--cyber-green); padding: 4px 12px; font-size: 0.85em; display: inline-block; color: var(--cyber-green);">
                                <?php echo (($admin['request_status'] ?? '') === 'pending') ? 'æ‰¿èªå¯©æŸ»' : 'è©³ç´°ç·¨é›†'; ?>
                            </a>
                        </td>
                    </tr>
                <?php endforeach; ?>
            </tbody>
        </table>
    </div>

    <p style="color: #888; font-size: 0.8em; margin-top: 10px;">
        å‡¡ä¾‹: <span style="color: #1eff1a;">â—</span>ãƒ‡ãƒ¼ã‚¿ç®¡ç† / <span style="color: #00ccff;">â—</span>ç®¡ç†è€…ç®¡ç† / <span style="color: #ff00ff;">â—</span>ãƒ­ã‚°é–²è¦§
    </p>

    <div style="margin-top: 20px;">
        <a href="/" style="color: #888; text-decoration: none;">â† ãƒ¡ã‚¤ãƒ³ç”»é¢ã¸æˆ»ã‚‹</a>
    </div>
</div>
</file>

<file path="views/home.php">
<?php
require __DIR__ . '/layouts/header.php';
?>

<div class="container">
    <div class="box">
        <?php if (!isset($_SESSION['logged_in'])): ?>
            <div style="display: flex; justify-content: flex-end; gap: 15px; align-items: center;">
                <div style="text-align: left; margin-right: auto;">
                    <span style="color: #1eff1a; font-weight: bold;">GUEST MODE</span>
                    <p style="margin: 0; color: #888; font-size: 0.8em;">ãƒ‡ãƒ¼ã‚¿ã®é–²è¦§ãŒå¯èƒ½ã§ã™ã€‚ç·¨é›†ã«ã¯ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—ãƒ»ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™ã€‚</p>
                </div>
                <span style="color: #666; font-size: 0.8em; font-family: monospace;">ACCESS >></span>
                <a href="/auth/login" class="btn btn-secondary" style="min-width: 100px; text-align: center;">ãƒ­ã‚°ã‚¤ãƒ³</a>
                <a href="/register" class="btn btn-primary" style="min-width: 100px; text-align: center;">ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—</a>
            </div>
        <?php else: ?>
            <div style="display: flex; flex-direction: column; gap: 15px;">
                <div style="display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #333; padding-bottom: 10px;">
                    <div style="text-align: left;">
                        <span style="color: #1eff1a; font-family: monospace; font-size: 1.1em;">
                            SYSTEM_USER: <strong style="color: #fff;"><?php echo h($_SESSION['login_id']); ?></strong>
                        </span>
                    </div>

                    <div style="text-align: right; font-size: 0.9em;">
                        <?php \App\Utils\View::component('request_link'); ?>

                        <a href="/admin/password/change" style="color: #fff; margin-right: 15px;">[PWå¤‰æ›´]</a>

                        <form action="/auth/logout" method="post" style="display:inline;">
                            <input type="hidden" name="csrf_token" value="<?php echo h($_SESSION['csrf_token']); ?>">
                            <button type="submit" style="background:none; border:none; color:#888; text-decoration:underline; cursor:pointer;">LOGOUT</button>
                        </form>
                    </div>
                </div>

                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <?php if (hasPermission(PERM_DATA)): ?>
                        <a href="/koban/create" class="btn btn-primary" style="padding: 10px 25px;">ï¼‹ æ–°è¦ãƒ‡ãƒ¼ã‚¿è¿½åŠ </a>
                    <?php else: ?>
                        <div style="color: #888; font-size: 0.9em;">
                            <span style="color: var(--cyber-yellow);">[!]</span> é–²è¦§å°‚ç”¨ãƒ¢ãƒ¼ãƒ‰
                        </div>
                    <?php endif; ?>

                    <div style="display: flex; gap: 10px;">
                        <?php if (hasPermission(PERM_LOG)): ?>
                            <a href="/admin/logs" class="btn btn-secondary" style="color: #00ccff; border-color: #00ccff;">[ãƒ­ã‚°ç›£æŸ»]</a>
                        <?php endif; ?>

                        <?php if (hasPermission(PERM_ADMIN)): ?>
                            <a href="/admin/users" class="btn btn-secondary" style="color: #ffff00; border-color: #ffff00; position: relative;">
                                [ç®¡ç†è€…ç®¡ç†]
                                <?php if (($pendingCount ?? 0) > 0): ?>
                                    <span style="position: absolute; top: -10px; right: -10px; background: red; color: white; border-radius: 50%; padding: 2px 6px; font-size: 10px; font-weight: bold; box-shadow: 0 0 5px red;">
                                        !
                                    </span>
                                <?php endif; ?>
                            </a>
                        <?php endif; ?>
                    </div>
                </div>
            </div>
        <?php endif; ?>
    </div>

    <div class="box" style="background-color: #282828;">
        <h2 style="margin-top: 0; border-bottom: 1px solid #444; padding-bottom: 5px; font-size: 20px;">æ¡ä»¶æ¤œç´¢</h2>
        <form action="" method="get">
            <div class="flex-row" style="justify-content: center;">
                <input type="number" name="search_id" placeholder="ID"
                    value="<?php echo h($_GET['search_id'] ?? ''); ?>"
                    style="width: 80px; background: #fff; color: #000;" min="1">
                <select name="search_pref">
                    <option value="">éƒ½é“åºœçœŒ (ã™ã¹ã¦)</option>
                    <?php foreach ($pref_list as $p) echo "<option value='{$p}' " . (($_GET['search_pref'] ?? '') == $p ? 'selected' : '') . ">{$p}</option>"; ?>
                </select>
                <select name="search_type">
                    <option value="">ç¨®åˆ¥ (ã™ã¹ã¦)</option>
                    <option value="äº¤ç•ª" <?php if (($_GET['search_type'] ?? '') == 'äº¤ç•ª') echo 'selected'; ?>>äº¤ç•ª</option>
                    <option value="é§åœ¨æ‰€" <?php if (($_GET['search_type'] ?? '') == 'é§åœ¨æ‰€') echo 'selected'; ?>>é§åœ¨æ‰€</option>
                </select>
                <input type="text" name="keyword" placeholder="ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ (ä¾‹: æ–°å®¿)" value="<?php echo h($_GET['keyword'] ?? ''); ?>" style="background: #fff; color: #000;" size="30">
                <select name="sort">
                    <option value="id_asc">IDæ˜‡é †</option>
                    <option value="id_desc" <?php if (($_GET['sort'] ?? '') == 'id_desc') echo 'selected'; ?>>IDé™é †</option>
                    <option value="name_asc" <?php if (($_GET['sort'] ?? '') == 'name_asc') echo 'selected'; ?>>åå‰é †</option>
                </select>
                <input type="submit" value="çµã‚Šè¾¼ã¿æ¤œç´¢" class="btn-primary">
            </div>
            <p style="font-size: 12px; color: #888; text-align: center; margin-bottom: 0;">â€»ã‚¹ãƒšãƒ¼ã‚¹åŒºåˆ‡ã‚Šã§è¤‡æ•°ã®è¨€è‘‰ã‚’æ¤œç´¢ã§ãã¾ã™ï¼ˆä¾‹ï¼šæ±äº¬éƒ½ æ–°å®¿ï¼‰</p>
        </form>

        <div style="margin-top: 20px; text-align: right; border-top: 1px solid #444; padding-top: 10px; display: flex; justify-content: flex-end; gap: 10px;">
            <form action="/koban/export" method="get">
                <button type="submit" class="btn-secondary">å…¨ãƒ‡ãƒ¼ã‚¿ã‚’CSVä¿å­˜</button>
            </form>
            <form action="/koban/export" method="get">
                <?php foreach (['keyword', 'search_type', 'search_pref'] as $k) echo '<input type="hidden" name="' . $k . '" value="' . h($_GET[$k] ?? '') . '">'; ?>
                <button type="submit" class="btn-primary" style="color: #000;">æ¤œç´¢çµæœã‚’CSVä¿å­˜</button>
            </form>
        </div>
    </div>

    <div style="text-align: left; margin-bottom: 5px; font-size: 18px;">
        <?php if ($total_count > 0): ?>
            æ¤œç´¢çµæœï¼š <span style="font-weight: bold; font-size: 24px; color: #1eff1a;"><strong><?php echo number_format($total_count); ?></strong></span> ä»¶
        <?php else: ?>
            <span style="color: #ff4444;">æ¡ä»¶ã«ä¸€è‡´ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚</span>
        <?php endif; ?>
    </div>

    <table>
        <tr style="background-color: #4a4a4a;">
            <th width="5%">ID</th>
            <th width="20%">äº¤ç•ªå</th>
            <th width="5%">ç¨®åˆ¥</th>
            <th width="10%">TEL</th>
            <th width="5%">å›£ä½“ã‚³ãƒ¼ãƒ‰</th>
            <th width="8%">éƒµä¾¿ç•ªå·</th>
            <th>ä½æ‰€</th>
            <?php if (isset($_SESSION['logged_in'])): ?><th width="10%" style="background-color: #550000;">æ“ä½œ</th><?php endif; ?>
        </tr>
        <?php foreach ($all_data as $row): ?>
            <tr>
                <td style="text-align: center;"><?php echo h($row['id']); ?></td>
                <td><?php echo h($row['koban_fullname']); ?></td>
                <td style="text-align: center;"><?php echo h($row['type']); ?></td>
                <td style="text-align: center;"><?php echo h($row['phone_number']); ?></td>
                <td style="text-align: center;"><?php echo h($row['group_code']); ?></td>
                <td style="text-align: center;"><?php echo h($row['postal_code']); ?></td>

                <td>
                    <a href="https://www.google.com/maps/search/?api=1&query=<?php echo urlencode($row['pref'] . $row['addr3']); ?>"
                        target="_blank"
                        style="color: #1eff1a; text-decoration: underline;"
                        title="Googleãƒãƒƒãƒ—ã§è¦‹ã‚‹">
                        <?php echo h($row['pref'] . $row['addr3']); ?>
                    </a>
                </td>

                <?php if (isset($_SESSION['logged_in'])): ?>
                    <td style="text-align: center;">
                        <?php if (hasPermission('data')): ?>
                            <div style="display: flex; justify-content: center; gap: 5px;">
                                <a href="/koban/edit?id=<?php echo h($row['id']); ?>" class="btn btn-warning" style="padding: 4px 8px; font-size:12px;">ç·¨é›†</a>
                                <form method="post" action="/koban/delete" onsubmit="return confirm('æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ');">
                                    <input type="hidden" name="csrf_token" value="<?php echo h($_SESSION['csrf_token']); ?>">
                                    <input type="hidden" name="delete_id" value="<?php echo h($row['id']); ?>">
                                    <input type="submit" value="å‰Šé™¤" class="btn-danger" style="padding: 4px 8px; font-size:12px;">
                                </form>
                            </div>
                        <?php else: ?>
                            <span style="font-size: 10px; color: #888;">æ“ä½œä¸å¯</span>
                        <?php endif; ?>
                    </td>
                <?php endif; ?>
            </tr>
        <?php endforeach; ?>
    </table>

    <div class="pagination" style="margin-top: 20px;">
        <?php
        $q = http_build_query(array_filter($_GET, fn($k) => $k != 'page', ARRAY_FILTER_USE_KEY));
        $link = "?$q&page=";
        if ($page > 1) {
            echo '<a href="' . $link . '1" class="other">&laquo; æœ€åˆ</a>';
            echo '<a href="' . $link . ($page - 1) . '" class="other">&lsaquo; å‰ã¸</a>';
        }
        for ($i = max(1, $page - 3); $i <= min($total_pages, $page + 3); $i++) {
            $class = ($i == $page) ? 'current' : 'other';
            echo '<a href="' . $link . $i . '" class="' . $class . '">' . $i . '</a>';
        }
        if ($page < $total_pages) {
            echo '<a href="' . $link . ($page + 1) . '" class="other">æ¬¡ã¸ &rsaquo;</a>';
            echo '<a href="' . $link . $total_pages . '" class="other">æœ€å¾Œ &raquo;</a>';
        }
        ?>
    </div>
    <p style="color: #888; font-size: 12px; margin-top: 5px;">
        å…¨ <?php echo $total_count; ?> ä»¶ä¸­ã€<?php echo $page; ?> ãƒšãƒ¼ã‚¸ç›®ã‚’è¡¨ç¤º
    </p>
</div>
</body>

</html>
</file>

</files>
